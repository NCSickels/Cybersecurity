## Lesson Introduction
---
While actively scanning the network, the team will need to take steps to avoid detection. In this lesson, we’ll cover how to use a variety of techniques to conceal activity. We’ll outline methods such as spoofing and living off the land attacks that use file-less malware. In addition, you’ll see why the team might choose to employ more advanced techniques that include using steganography tools to hide and conceal in plain sight. Finally, we’ll see how the PenTest team may need to attempt to establish a covert channel along with using Ncat, Secure Shell, and proxy chaining to provide remote access for further exploits.

## Lesson Objectives
---
In this lesson, you will:

- Compare different methods used to evade detection while scanning, such as spoofing and living off the land techniques.
- Demonstrate the ability to use steganography tools, such as OpenStego and Snow, to hide and conceal activity such as Command and Control (C&C) communication
- Summarize methods used to establish a covert channel and provide remote access using Ncat, Secure Shell (SSH), and proxy chaining.

## Topic 8A - Evade Detection
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *3.7 Given a scenario, perform post-exploitation techniques.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Data loss prevention is ensuring that there is no data exfiltration, which is data that leaves the organization without authorization. Malicious actors use a variety of methods to exploit the attack vectors so they can launch an attack. As a result, the PenTest team will need to be aware of the techniques used to avoid detection. In this section, we’ll take a look at methods to evade or spoof a firewall or IDS. In addition, since it’s optimal to remain anonymous, we’ll outline ways to cover your tracks.

Let’s start with ways the team can evade detection.

### Flying Under the Radar
---
During the reconnaissance phase, the team will have identified potential network defenses. As a result, they will need to test to see if they can either spoof the device or pass through unnoticed.

When using Nmap, the TCP SYN scan is the default and most popular option. It can be performed quickly and is able to scan thousands of ports per second on a fast network not hampered by restrictive firewalls. The format for this scan is as follows: `nmap -sS <target>`.

Nmap has several other ways to be stealthy, such as using fragmentation along with randomizing the order of hosts being scanned.

As shown in the following table, we see only a partial list of the available commands used to avoid detection:

|   **Stealth Option**    | **Example**                                  | **Description**                                                                                                                                                               |
| :---------------------: | -------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|        **`-sF`**        | **`nmap -sF www.company.tld`**               | This option sends a TCP FIN to bypass a non-stateful firewall.                                                                                                                |
|        **`-f`**         | **`nmap -f 192.168.1.50`**                   | This will split the packets into 8-byte *fragments* to make it harder for packet <br>filtering firewalls and intrusion detection to identify the true purpose of the packets. |
| **`--randomize-hosts`** | **`nmap --randomize-hosts 192.168.1.1-100`** | This option will randomize the order of the hosts being scanned.                                                                                                              |

In this section, we’ll cover ways we can spoof a device and bypass Network Access Control. In addition, we’ll take a look at how using techniques such as fileless malware and proxies can help avoid detection.
First let's take a look at the many ways we can spoof a device.

#### Spoofing the Device
Nmap has several spoofing options you can use to trick the device into thinking normal traffic is passing through in order to avoid detection.

Some of the options include using a decoy, reporting a fake address, and utilizing a specific port number. Let’s start with seeing how a decoy can be used to spoof a device.

#### Using a Decoy
When conducting a port scan on a host, you can use decoys in order to make it appear as if the packets are coming from either a trusted or random device. You can specify the IP address you want to use, or you can allow Nmap to generate random IP addresses. The object is to create bogus packets from the “decoys” so the actual attacker "blends in" with the crowd. This option can be used by issuing the command: `-D [decoy1, decoy2, decoy3, etc.] <target>` .

To test this option, obtain your IP address and launch Wireshark. Then issue the command: `nmap -D 192.168.1.10 scanme.nmap.org` where `scanme.nmap.org` is the target and the other IP address is the decoy.

As shown in the screenshot, both the decoy (192.168.1.10) and the actual attacker (10.0.0.37) are both sending probes to scanme.nmap.org:
![[Pasted image 20240604110222.png]]
*Using the Nmap decoy option, as shown in Wireshark*

Another option is to use randomly generated decoys. In that case you would use the following option: `nmap -sS -sV -D RND:3 scanme.nmap.org`. As shown in the following screenshot, we see the actual attacker (10.0.0.37), along with three other decoys:
![[Pasted image 20240604110310.png]]
*Using the Nmap random decoy option, as shown in Wireshark*

In addition to using a decoy, Nmap can spoof an IP address as well.

#### Reporting a Fake IP Address
Another option to confuse the IDS is to use a bogus IP address to make it appear as if the packets are coming from another source. This option uses the following: `-S <spoofed source address>`.

For example, using `nmap -S www.google.com scanme.nmap.org` makes it appear that `www.google.com` is trying to scan `scanme.nmap.org`.

> [!warning] This scan might not return results since the target will try to respond to the fake address.

With Nmap you can also spoof a Media Access Control or (MAC) address. Let’s take a look.

#### Advertising a Fake MAC Address
In some cases, it might be effective to make the probe appear to be coming from a specific device. In that case, the team can generate a bogus source hardware (or MAC) address using this option:

`--spoof-mac [vendor type | MAC address]`

You can achieve this in one of two ways:

- Specify a random MAC based on the vendor category, i.e., `nmap -sT --spoof-mac apple scanme.nmap.org`, which creates a random Apple hardware address.
- Use a specific MAC address such as `nmap -sT --spoof-mac B7:B1:F9:BC:D4:56 scanme.nmap.org`, which creates a specific hardware address.

Another way to trick a device is to make it appear as if the packet is coming from a specific port.

#### Modifying a Port Number
Network security devices are tuned to either allow or deny specific packets based on several different parameters. One of those parameters is the source port number. Nmap offers an option to use a specific source port number to fool packet filters configured to trust that port. The team can use one of the following options:

- `--source-port <portnum>` , for example: `nmap --source-port 53 scanme.nmap.org`
- `-g <portnum>` , for example: `nmap -g 53 scanme.nmap.org`

In either option, the probe will appear to have originated from port 53, which is used by a DNS server when returning a response to the client.

Another technique to avoid detection is to slow the scans so as not to set up any flags on the security devices.

#### Slowing the Scans
Nmap has several choices for flying under the radar and avoiding detection. However, most modern network appliances are tuned to recognize a standard TCP SYN and other evasion and spoofing techniques. For example, Snort is a popular open-source IDS that holds many of the signatures to detect Nmap scans. When active, Snort will monitor for port scanning using a default threshold of 15 ports per second. If aggressive scanning is detected, Snort will issue an alert.

As a result, when testing, the team might be able to avoid detection by using the **`–T`** switch to slow the scans or combine the scan with other options to avoid detection.

In addition to spoofing, the team may choose to attempt to bypass ***Network Access Control (NAC)***. Let’s see what's involved.

### Bypassing NAC
---
Network Access Control appliances restrict traffic by allowing only authorized hosts to access the corporate infrastructure. NAC appliances can be a switch, Wireless Access Point (WAP), or a remote access/VPN server.

The most common way to bypass NAC is by accessing an authenticated device and using the device to slip by the NAC appliance. For example, a malicious actor can use a rogue WAP to get an authorized device to connect. The attacker machine will then use it to relay malicious traffic into the protected network. As shown in the graphic, the malicious actor is using an ***on-path attack***:
![[Pasted image 20240604110757.png | 670]]
*Bypassing a NAC*

> [!warning] An on-path attack is also known as a man-in-the-middle attack.

Another stealthy approach to avoid detection is to use a technique called ***living off the land (LoTL)***.

### Living Off The Land
---
A traditional approach to launching an attack is to use malware, backdoors, and rootkits. In contrast, LoTL attacks are called fileless malware as there are no viruses used. Instead, the attack will use the tools that are part of the OS or administration tools to launch an attack.

<mark style="background: #FFF3A3A6;">Some of the tools include the following:</mark>

- <mark style="background: #FFF3A3A6;">Microsoft PowerShell (PS) is a command shell and scripting language built on the .NET Framework. PS is used to automate tasks along with performing system management and configuration</mark>
- <mark style="background: #FFF3A3A6;">Windows Management Instrumentation (WMI) provides an interface for local or remote computer management. WMI can provide information about the status of hosts, configure security settings, and manipulate environment variables.</mark>
- <mark style="background: #FFF3A3A6;">Visual Basic Scripts (VBScript) is a command shell and scripting language built on the .NET Framework, which allows the administrator to manage computers.</mark>
- <mark style="background: #FFF3A3A6;">Mimikatz is an open-source tool that has several modules. Some of the functions include the ability to create a Microsoft Kerberos API, list active processes and view credential information stored on a Windows computer.</mark>

One scenario for launching a LoTL attack is to send a phishing email with an attached Word document that contains a macro, as shown in the graphic:
![[Pasted image 20240604110935.png | 670]]
*Living off The Land attack*

Once the victim accepts and opens the document, the macro can activate a VBScript, which in turn can execute a PowerShell task to complete a task, such as:

- Activate WMI to move through the system
- Use Mimikatz to dump credentials
- Download and install Metasploit.

A LoTL attack is extremely dangerous because the malicious actor will use the OS itself which in turn becomes weaponized. The toolkit is the system's own native tools, which generally won’t trigger any alarms and are harder to detect.

The attacks are stealthy and are being used for a variety of malicious purposes including using software deployment tools to deliver ransomware. Because there is no discrete signature, a more proactive approach to fileless malware is to use a blend of behavioral-based detection and monitoring strategies.

Once all scans and attacks are complete, you’ll want to remove any evidence that you were in the system after. Next, let’s see the many ways we can cover our tracks.

### Covering Your Tracks
---
One of the most common anti-forensics technique is to cover your tracks. An attacker will try to make it as difficult as possible for investigators to identify how the attack began and who is responsible.

Covering tracks is done in order to:

- Attempt to conceal the source of a malicious act and remove any residual traces of that event before leaving the target environment.
- Help the malicious actor hide their initial exploits as well as any ongoing compromise.
- Clean up after a PenTesting exercise by removing shells, tester-created credentials, and tools.

> [!warning] If cleanup is to be done after a PenTest, make sure that the team has recorded all data that is needed for the final report.

In this section, we’ll cover the techniques you can use to cover your tracks. Let’s start with ways to deal with event logs.

### Tidying Logs And Entries
---
Once the team has completed the PenTest, they will need to remove any evidence that they were in the system. There are several tools that can be used to modify the log entries. The team can either erase a whole log file or certain items. In addition, they can modify the time values to hinder the effectiveness of a forensic investigation.

Let’s first see how you can clear an entire log file.

#### Clearing Log Entries
Tools such as Metasploit offer commands that can clear an entire event log on a machine that you're currently exploiting. Because it clears every log rather than specific ones, this may raise suspicion; however, it can still make it harder for a forensic analyst to do their job.

<mark style="background: #FFF3A3A6;">Methods to clear event logs include:</mark>

- Using Metasploit's _meterpreter_ you can issue the command, `clearev` , which will clear all Windows event logs.
- When using the command line interface (CLI) in Windows, you can also clear individual log _categories_. For example: `wevtutil cl Application` will clear the application log.
- To clear logs on a Linux system, you can use one of several methods that you'd use to clear any text file. For example, to clear the syslog use: `echo "" > /var/log/syslog`.

In some cases, you don’t want to remove all logs, just specific entries.

#### Removing Specific Entries
Rather than wiping a log entirely and giving investigators something to be suspicious about, you can instead remove specific entries that could reveal your attack. For example, you've logged into a Linux system using a backdoor account called "backdr." Before leaving, you could wipe any entries in auth.log that show the account logging in, rather than clearing the entire log.

<mark style="background: #FFF3A3A6;">One way to do this is by using the stream editor (SED), which has the ability to search, find, delete, replace, insert, or edit without having to open the file. The following example uses SED to delete all lines matching the given string (backdr), while keeping the other lines intact:</mark>

`sed -i '/backdr/d' /var/log/auth.log`

Many times, during a forensic investigation, the focus is on the log files which record what we have done while in the system. However, sometimes it’s to our advantage to alter an entry to make it appear as if it came from somewhere else.

#### Changing Log Entries
Instead of removing an entry or an entire log, it may be more beneficial to simply _alter_ the log entries. For example, with some effort you can modify a user logon entry in Windows security logs which can frame another individual.

However, you can also steal a privileged user's token and then perform a malicious task. This type of attack is called Incognito, which allows you to impersonate user tokens after you have compromised a system. Using Metasploit's _meterpreter_ you can list available tokens and then impersonate one of the tokens to assume its privileges.

In either case, the event will be recorded as if it were performed by the user whose token you stole.

A good forensic investigator will attempt to reconstruct a narrative of events by correlating event data. One of the most important attributes in event correlation is time. Let’s see how we can modify the time values to skew the results of an investigation.

#### Modifying Timestamps
The concept of time is very important on a network. If you can modify the time that certain events are recorded, you can deceive the investigators during a forensic investigation. Changing time-based values is not just limited to event logs. You can also alter a ***file's modification, access, created, and entry modified (MACE) metadata***.

Changing the MACE values is possible by using Metasploit's _meterpreter_ tool called ***TimeStomp*** which allows you to delete or modify timestamp-related information on files. You can view the details of a file by using the following command:

```bash
meterpreter > timestomp example.txt -v

[*] Showing MACE attributes for example.txt

Modified : 2021-07-08 16:24:25 -0500

Accessed : 2021-07-08 16:23:24 -0500

Created : 2021-07-08 16:23:24 -0500

Entry Modified: 2021-07-08 16:24:25 -0500
```

The following command will change all the modified ( `-m`) MACE values for a file to the specified time:

```bash

meterpreter > timestomp example.txt -m "08/14/2021 10:12:05"

[*] Setting specific MACE attributes on example.txt
```

Changing the time values can fool the investigators; however, this action can also confirm that an attack has taken place.

While modifying logs and entries is possible, there are times that it’s best to remove all evidence. Let’s see how this is done.

#### Erasing or Shredding Evidence
---
In some cases, a malicious actor may choose to either remove the history of events, or completely shred all evidence of a file. Either choice will make the evidence less obvious. However, if you really want to remove any proof that a file existed, you’ll need to shred the file.

Let’s compare the two.

#### Removing the History
Certain shells, such as the Bash shell on a Linux OS, will store the last _n_ commands in history. A good forensic analyst can retrieve this history and piece together your executed commands. However, you can cover your tracks by setting the command history to zero _before_ executing the commands. For a Bash shell, this command is as follows: `export HISTSIZE=0`.

If the system has already recorded a shell history, it’s possible to delete the entries. Depending on the OS you are working with, you will need to issue one of the following:

- On a Linux machine using a Bash shell enter either `echo "" > ~/.bash_history or history -c`.
- In a Windows OS, you can clear the history of cmd.exe by pressing **Alt+F7** or by simply terminating the process.
- While in PowerShell, clear the history by using the Clear-History cmdlet.

In some cases, you’ll want to completely remove a file by shredding the evidence.

#### Shredding Files
Deleting a file while in a standard OS doesn’t completely erase that file. If you want to make sure that you've securely deleted and completely removed a file you should use a _file shredder._

Shredding or overwriting a file is possible by using the following:

On a **Linux** system, you can use the command shred. For example, to overwrite the file with zeros and hide evidence that the file was shredded and completely remove the file, you would use the command: `shred -zu /root/keylog.bin`.

Windows has a built in command, called cipher.exe, that can securely delete a file. By using `cipher.exe /w:C:\path\to\file.ext`, you can securely delete it. However, it must be over 1kb in size for cipher to work.

## Topic 8B - Use Steganography to Hide and Conceal
---
> [!note] Exam Objectives Covered
> *3.7 Given a scenario, perform post-exploitation techniques.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Steganography (Stego) is the art of hiding in plain sight and is an ideal way to conceal the fact that communication has taken place. Malicious actors use steganography, so it’s optimal for the PenTesting team to have a better understanding of the methods used to conceal information. In this section, we’ll discover some of the tools used in steganography. We’ll first investigate a few of the standard methods, including Steghide and OpenStego, that use images to conceal information. We’ll then cover some alternate methods such as New Technology File System (NTFS) alternate data streams along with using white space steganography. We’ll then finish with a discussion on how we can convert an image to music for a totally unique way to conceal text.

Let’s start with learning about classic steganography tools.

### Using Standard Stego Tools
---
Steganography tools and techniques have been in use for over 2,500 years.

Digital steganography requires three basic elements:

- Some type of carrier, such as music or an image
- The payload, which is generally the secret message
- The steganography software

The carrier must be able to pass as the original and appear harmless. The payload can contain any number of things, such as trade secrets or command and control activity. Once the payload is hidden, no one outside of the sender and the receiver should suspect anything.

Today, there are hundreds of steganography tools available that we can use to conceal activity. Most are freely available, and have similar functions in that they can conceal and encrypt data using a wide range of carriers. We can embed a payload in several types of carriers, such as documents, images, video, and audio files. The software can use either a CLI or GUI tool; however, most are intuitive and easy to use.

> [!warning] Kali Linux currently includes two Stego tools, Steghide, and StegoSuite.

However, within each tool there are some differences. In this section we’ll discuss a few of the tools used to conceal information. Let’s start with exploring ***Steghide***.

#### Discovering Steghide
Steghide is an open-source tool used to conceal a payload in either an image or audio file. The software can compress, conceal, and encrypt data using images such as JPEG and BMP, along with audio files using Waveform Audio File Format (WAV) and audio (AU) formats.

Steghide is natively a CLI tool. You can modify and conceal information using commands. For example, you can embed the secret.txt file in the carrier image as shown:
```bash
$ steghide embed -cf carrier.jpg -ef secret.txt

Enter passphrase:

Re-Enter passphrase:

embedding "secret.txt" in " carrier.jpg"... done
```

You can also use a GUI by using Steghide UI, which is a companion to the CLI version. Once you download and install Steghide UI, you will be able to load the carrier file and the payload, along with setting encryption options as shown in the following screenshot:
![[Pasted image 20240604112051.png | 400]]
*Steghide UI*

Another option is ***OpenStego***, another open-source steganography tool.

#### Disguising with OpenStego
OpenStego is similar to most other tools in that you embed a message in a carrier file. To get started, you‘ll need to make sure that you have the ***Java Runtime Environment (JRE)*** installed as the software is written in Java.

Once you launch OpenStego you’ll be able to see your choices. What’s unique about OpenStego is that, in addition to standard steganography functions, you can also embed a watermark. The watermark is similar to a digital signature, which when used can prevent someone from making unauthorized changes to the file.

To create a watermark, select the icon `Generate Signature`, as shown in the graphic below:
![[Pasted image 20240604112206.png |540]]
*OpenStego generate watermark*

To create a watermark, you will need to complete the following:

- Create a signature using a passphrase.
- Choose a location where to output the signature (.sig) file
- Select `Generate Signature`

Once you have created a watermark, you can then mark the file with an invisible signature.

In addition to standard steganography methods, there are also several alternative methods of hiding in plain sight. Let’s compare some options.

### Masking Using Alternate Methods
---
There are many ways to conceal information. For example, you can conceal data using NT File System (NTFS) alternate data streams.

NTFS Alternate Data Streams were originally designed to provide compatibility with non-Windows file systems. However, this method can also be used to allow data to be stored in hidden files that are linked to a regular visible file. The streams are not limited in size and there can be more than one stream linked to the visible file. This allows an attacker to hide their tools and data on a compromised system and retrieve them later.

Along with using alternate data streams, you can use other methods, such as hiding information in white space, along with converting an image into music. Let’s start with seeing what’s involved when using whitespace steganography.

#### Concealing with Whitespace
Snow is a CLI steganography tool that conceals a data payload within the whitespace of a text file that uses the ASCII format. Data can either be concealed using plaintext, or the message can be encrypted.

To hide a secret file, you’ll need the following:

- **Message** is what you want to conceal. In this case we’ll use “Orange tiger kittens are cute”
- **Password** is how you will protect the message. In this case we’ll use “tiger”
- **Text file** is the carrier. In this case we’ll use “Digital.txt”
- **Output file** is the file with the message concealed. In this case we’ll use “Digital2.txt”

To use Snow, navigate to the directory the software resides. Then issue the command: `Snow -C -m “Orange tiger kittens are cute” -p “tiger” Digital.txt Digital2.txt`, as shown in the screenshot:
![[Pasted image 20240604112408.png]]
*Using Snow to conceal text*

Once the secret message is hidden, you can compare the two. For example, the file on the left is the original, and the file on the right has the embedded message, as shown in the screenshot:
![[Pasted image 20240604112429.png | 670]]
*Comparing documents*

To extract the message, use the command `snow -C -p “tiger” Digital2.txt`, as shown:
![[Pasted image 20240604112503.png]]
*Extracting the hidden message*

Another novel way to conceal a message is by converting an image to sound. Let’s explore this next.

### Synthesizing Images
---
Methods to conceal data have evolved over time. Two other programs used to manipulate a message are ***Coagula*** and ***Sonic Visualizer***. As you’ll see, the two programs work in a similar method, they use _sound_ to conceal an image and then convert the text in the spectrogram. Let’s first explore Coagula.

#### Obscuring Text with Coagula
Coagula is a tool used to synthesize an image into a .wav file. To achieve this, you’ll need to download Coagula and Audacity, which are both free programs, and then do the following:

1. Create a basic image in PowerPoint using a black background with some text, and then save as a device an independent bitmap (BMP) file.
2. Open the file in Coagula as shown in the graphic below:

![[Pasted image 20240604112619.png | 550]]
*The Password.bmp in Coagula*

3. 3. Drop down the Sound menu choice, and then select `render without blue`. Once you are done, save as a .wav file and close the program.
4. Open the .wav in Audacity and then drop down the arrow on the password menu, then choose `Spectrogram`, as shown in the graphic below:

![[Pasted image 20240604112732.png | 550]]
*The Password.wav in Audacity*

5. Once you select Spectrogram, you will be able to see your text as shown:

![[Pasted image 20240604112810.png | 550]]
*The text revealed in Audacity*

In addition to Audacity, another tool that you can use to derive text from a .wav file is Sonic Visualizer.

#### Revealing with Sonic Visualizer
Sonic Visualizer is another tool that can distill hidden text. Similar to importing a .wav file in Audacity, open the Password.wav file in Sonic Visualizer, and then select Add Spectrogram from the Pane drop down menu choice, as shown in the graphic:
![[Pasted image 20240604112848.png]]
*Add Spectrogram to the .wav file*

Once Add `Spectrogram` is selected, Sonic Visualizer will then reveal the text, as shown:
![[Pasted image 20240604112919.png]]
*The text revealed in Sonic Visualizer*

As you can see, a determined malicious actor will have plenty of ways to conceal information, using a variety of steganography tools and techniques.

## Topic 8C -  Establish a Covert Channel
---
> [!note] Exam Objectives Covered
> *3.7 Given a scenario, perform post-exploitation techniques.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Once a malicious actor has gained access to a network and established a foothold, the next logical step is to continue to access the remote resource. This is commonly done by creating a covert channel so they can continue to maintain their position, undetected. In this section, we’ll take a look at ways to provide remote access by using tools such as Secure Shell (SSH), Ncat, and Netcat. Then, we’ll take a look at how using ProxyChains, a command-line tool, provides anonymity by sending messages through intermediary or proxy servers.

Let’s start with outlining ways to provide remote access.

### Providing Remote Access
---
A network administrator has multiple security devices and methods to enable complete visibility of the network at any given time. Generally, all devices are tuned to be aware of unusual or suspicious behavior that could lead to data compromise or data exfiltration.

***Data exfiltration*** is when data that is stored inside a private network is transferred to an external network without authorization. This can be achieved by someone on the inside of the organization, such as a disgruntled employee, a malicious actor, or by accident. <mark style="background: #FFF3A3A6;">Data exfiltration can be the result of the following:</mark>

- <mark style="background: #FFF3A3A6;">A social engineering attack such as a phishing email requesting data.</mark>
- <mark style="background: #FFF3A3A6;">Downloading data to an insecure device, such as a USB drive.</mark>
- <mark style="background: #FFF3A3A6;">Fileless malware such as a PowerShell-based attack using custom payloads.</mark>
- <mark style="background: #FFF3A3A6;">Transmitting data to non-secured cloud resources.</mark>

> [!warning] Detecting data exfiltration can be difficult. One way to detect an attack is by using an IDS that monitors for unusual activity, such as a spike in database reads and/or high-volume network transfers.

Not all data exfiltration activity is malicious. However, there may be an active attempt to obtain data in an unauthorized manner. One way to achieve this is by using a remote access method.

Many times, a malicious actor will work extremely hard to get into a system, then once in, they attempt to remain in the system undetected. Some of the tools that are used to provide remote access include Secure Shell (SSH), Windows Remote Management (WinRM), Ncat, and Netcat.

Let’s start with an overview of communicating securely using SSH.

### Using a Secure Shell
---
When communicating with a remote, Linux-based machine, it’s common to use ***Secure Socket Shell (SSH)***, a protocol that provides a way to communicate securely via a CLI (shell) over an encrypted connection.

<mark style="background: #FFF3A3A6;">For an SSH session to take place, you’ll need the following:</mark>

- <mark style="background: #FFF3A3A6;">One computer will act as a client. The client will initiate the communication process by contacting the server. If the server accepts the request, the client will provide host information and appropriate credentials to the server.</mark>
- <mark style="background: #FFF3A3A6;">One computer will act as a server. The server has an SSH daemon that listens for client requests. When a client initiates a request, the server will check the host information and appropriate credentials, then once accepted, both parties will establish a connection.</mark>

Once the session is started, the client can then manipulate objects, transfer files, or manage the computer by issuing commands via a terminal interface.

Malicious actors constantly try to exploit a vulnerable SSH server to gain access to a system. Nmap has several commands and scripts that the team can use to see if the target is vulnerable.

Next, let’s explore two other tools used for remote access, Netcat and Ncat.

### Hacking with Netcat and Ncat
---
During the Pentesting process, the team will use a variety of tools. Netcat (nc) is a classic example, as it is a versatile utility that is often called the "Swiss Army knife" of hacking tools. Ncat is considered to be a successor of Netcat as it provides all of the same commands and options as Netcat along with advanced functionalities.

Let’s compare the two, starting with Netcat.

#### Introducing Netcat
Netcat is a command-line utility used to read from, or write to, a TCP or UDP network connection. It can create or connect to a TCP server, act as a simple proxy or relay, transfer files, launch executables (such as a backdoor shell) when a connection is made, test services and daemons, and even scan ports.

The basic syntax of Netcat is `nc [options] [target address] [port(s)]`. Common options include the following:

| **Netcat Option** | **Description**                                                                                                                                          |
| :---------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
|     **`-l`**      | Starts Netcat in listen mode. The default mode is to act as a client.                                                                                    |
|     **`-L`**      | Starts Netcat in the Windows-only "listen harder" mode. This mode creates a persistent listener that starts listening again when the client disconnects. |
|     **`-p`**      | Specifies the port that Netcat should start listening on in listen mode. In client mode, it specifies the source port.                                   |
|     **`-u`**      | Starts Netcat in UDP mode. The default is to use TCP.                                                                                                    |
|     **`-e`**      | Specifies the program to execute when a connection is made.                                                                                              |
Netcat has been a standard for many years; however, a more advanced option is to use Ncat.

#### Evolving with Ncat
***Ncat*** is an Interactive CLI tool written for the Nmap Project. <mark style="background: #FFF3A3A6;">Ncat is used to read and write raw data over a network and includes support for proxy connections along with IPv6 and SSL communications. When establishing a link between two computers, Ncat can operate in one of two modes:</mark>

- <mark style="background: #FFF3A3A6;">Connect (or client) mode – If the host is in this mode, Ncat will attempt to initiate a connection to a listening service.</mark>
- <mark style="background: #FFF3A3A6;">Listen (or server) mode – If the host is in this mode, Ncat will listen for an incoming connection request.</mark>

Ncat is built into Nmap and all of the commands and functions complement one another. In addition, Ncat includes support for Windows, Linux, and Mac OS.

Other methods to provide remote management include Windows Remote Management (WinRM) and PSExec.

### Managing Remotely Using WinRM and PSExec
---
Within a Windows OS, there are different ways to manage a remote system. Two CLI choices include Windows Remote Management and PSExec.

Let’s compare the two.

#### Providing Remote Management with WinRM
WinRM comes installed with Windows and can be accessed via a CLI or PowerShell.

Either way you access WinRM, you will have to configure both machines to activate the service. To access WinRM, go into a CLI as an administrator, and then type the command `c:\users> winrm`, which will display the following:
![[Pasted image 20240604113643.png | 550]]
*WinRM output*

To activate the service, issue the command `c:\users> winrm quickconfig`, which will configure the firewall exceptions and start the service.

After initial configuration on both systems, you can then gain access to the remote system. Once in, you can execute commands to manage and monitor clients and servers.

In addition to WinRM, you can use PsExec.

#### Managing Remotely Using PSExec
***PsExec*** is a lightweight program that is part of the Sysinternals suite that provides interactivity for CLI programs. PsExec uses ***Server Message Block (SMB)*** to issue commands to a remote system without having to manually install client software.

<mark style="background: #FFF3A3A6;">While this is a convenient option for network administrators, PsExec can be used along with Mimikatz to allow a malicious actor to move laterally within a system and issue commands.</mark>

For example, to run an executable in the SYSTEM account you would issue the following command:

`psexec \\192.168.1.50 -s "C:\bad-app.exe"`

While there are many methods to provide remote access to another system, another technique to connect to a remote machine is to use a proxy.

### Using a Proxy
---
A proxy is someone who acts on your behalf. For example, if you are in a legal battle, a lawyer would be your proxy so that you would not have to deal directly with the other entity.

Proxy servers are used on a network to mediate the communications between a client and another server. One method is to use ***Socket Secure (SOCKS)*** which can provide the necessary authentication so that only authorized users may access a server.

> [!warning] SOCKS5 is the most current version available and is widely used.

A proxy can filter and often modify communications, as well as provide caching services to improve performance. However, malicious actors can also use proxies to conceal their location. Called ***ProxyChaining***, this provides an extra layer of protection by forcing a specific TCP connection so that websites do not see your real IP address.

It is possible to determine where the data originated; however, this can take some effort.

**ProxyChains4** is included with Kali Linux, as well as any other version of Linux. ProxyChains4 is a command-line tool that enables PenTesters to mask their identity and/or source IP address by sending messages through intermediary or proxy servers.

In order to stay anonymous during port scanning, you can use ***The Onion Router (TOR)*** through the ProxyChains4 utility, which will redirect connections through proxy servers.

ProxyChains4 is configured to use Tor by default. However, if you need to install TOR, you can use the command `apt-get install tor`.

All traffic is sent through a specific tunnel, another server or machine, that is acting on your behalf. Encrypting the traffic will conceal the contents of the packets. The command structure for ProxyChains4 is as follows: `--proxies <proxy:port, proxy:port...>.`

For example, the following `nmap --proxies http://192.168.1.30:8008,http://192.168.1.90:8008 scanme.nmap.org` will relay TCP connections through a chain of HTTP or SOCKS4 proxies, as shown:
![[Pasted image 20240604113931.png | 550]]
*Using proxy chaining*

This example conducts an Nmap scan against target scanme.nmap.org through two proxies, 192.168.1.30 and 192.168.1.90.