## Lesson Introduction
---
Once the PenTest is complete and all reporting is disseminated to the appropriate stakeholders, the team will need to ensure all traces of the test have been eradicated. That involves removing any shells, credentials, and tools, along with log files, data, and evidence of compromise. You will want to make sure the client has accepted the results; and then plan for the next test. Finally, the team will need to gather and review any lessons learned during the PenTest using a neutral facilitator.

## Lesson Objectives
---
In this lesson, you will:

- Summarize the types of activities the team will need to complete as they conduct a post-engagement cleanup.
- Compile a list of follow-up actions that includes obtaining client acceptance and a session to hash out lessons learned.

## Topic 20A - Post-Engagement Cleanup
---
> [!note] Exam Objectives Covered
> *4.4 Explain post-report delivery activities.*

In any case where an exploit will destabilize a live production system, you should be cleaning up directly after. However, for everything else, you can wait until the report has been handed off to begin your cleanup tasks. The purpose of these tasks is to ensure that there are no artifacts left over that an attacker could exploit or that could lead to more risk than the organization is willing to tolerate.

Some common cleanup tasks can include, but are not limited to:

- Delete any new files you created from the affected systems.
- Remove any credentials or accounts you created from the affected systems.
- Restore any original configurations you modified.
- Restore any original files that you modified or otherwise compromised.
- Restore any log files you deleted.
- Restore any original log files you modified or otherwise compromised.
- Remove any shells, RATs, or other backdoors from the affected systems.
- Remove any additional tools you may have left on the affected systems.
- Purge any sensitive data exposed in plaintext.
- Restore a clean backup copy of any apps that you compromised.

Whether you're removing credentials, shells, tools, or some other component added in the test, you need to watch out for collateral damage. Be sure that you're only removing test accounts and not legitimate user accounts. Take care not to remove any tools and other software that are crucial to the target system's operations. Ultimately, you want to leave the target systems in the state you found them.

### Removing Shells
---
As for removing shells, you need to remember that you likely tried to hide them on the target systems. In fact, you may have hidden them in multiple ways so that other shells could compensate if one were discovered.

Make sure to remove any values added to the HKLM and HKCU Run Registry keys that start a shell on a Windows system during boot. On Linux, depending on the distribution, scripts in **/etc/init.d/** and **/etc/systemd/** are examples of similar run-on-boot functionality.

Also make sure to remove any scheduled tasks in Windows Task Scheduler or the Linux crontab file that call a shell. Similarly, just because you can't see the shell running on the system when you check it, doesn't mean it isn't lying dormant, waiting to be called by a scheduling service or daemon. Likewise, if you added a Netcat binary or other shell software to the target system, then you should also remove it so that an attacker can't take advantage of it.

### Deleting Test Credentials
---
Removing tester-created credentials, shells, and tools that were installed on systems as part of the PenTest is not necessarily a simple task. These exploits might be deeply embedded in the target systems, especially if you applied evasive techniques to escape notice. The breadth of these exploits might make it difficult to track and manage them across all affected systems, even if you kept records.

When it comes to removing credentials you created during the test, keep in mind that not all authentication systems are alike. While you can simply log on to a local system and delete any local credentials you created on the system, the same cannot be said for Active Directory (AD) domain accounts.

<mark style="background: #FF5582A6;">If you created an AD account from a domain controller (DC) and then used that account to sign in to a workstation, simply removing the account from the workstation will not remove it from the domain. You will need access to the DC to delete the AD account, otherwise a real attacker might be able to leverage this account by using it to sign in to a DC.</mark>

Another concern with removing test credentials is that they might be integrated so tightly into a particular system that deleting the credentials could lead to system corruption or other issues.

For example, systems that place a strong emphasis on an audit trail or a change history (e.g., wiki software) might not provide a “delete account” feature on the standard interface to preserve the integrity of changes and/or versions. In this case, you may need to remove the test accounts from the user database directly, assuming you actually used them to make changes in a production environment.

### Eliminating Tools
---
Besides shells, you'll also need to remove other tools that you added to a system to enable its compromise, such as Metasploit payloads, keyloggers, and vulnerability scanner agents.

Some of these tools might be loaded into memory and are therefore automatically removed on system reboot (e.g., certain Metasploit payloads), whereas others linger on the target system until manually uninstalled.

For the latter, a superficial deletion of the tool is not necessarily enough—you may need to, when possible, **securely destroy** (also referred to as shredding or purging) the tool’s data and any associated files so that they cannot be recovered by an attacker or curious user.

> [!important] Shredding on HDDs vs. SSDs
> When PenTesters shred data on HDDs (Hard Disk Drives) it is faster and more reliable because the process of writing to a hard drive is reliable.
> When PenTesters shred data on SSDs (Solid State Drives) it is slower and less reliable because SSD write algorithms may write to different locations to reduce wear.


### Destroying Test Data
---
When purging data, a technically secure process should be followed, as some data may remain after simple deletion operations. Adhering to a known procedure that is technically feasible and easily repeatable, such as an automated script, will avoid issues such as forgetting about any exposed sensitive data.

Shredding data is the process of securely destroying data by overwriting the storage with new data. This new data can be all zeros, random and/or following patterns, and the techniques repeated after each other (known as passes) to minimize the chance of advanced data recovery methods to work.

Although safer, mixing techniques will make the process longer, and storage mediums may have differences that make some of the fast and reliable processes of data destruction behave slowly and/or unreliably on other mediums.

In particular, differences between HDD (Hard Disk Drive) and SSD (Solid State Drive) are a common example: repeated attempts to write on the same SSD location might actually end up writing to a different location due to the nature of SSD write algorithms optimized to reduce wear, whereas in a hard drive this process is much more reliable.

Note that while you can perform these tasks manually, you'll save yourself time and effort by automating cleanup through the use of scripts. These scripts can, in many cases, simply revert malicious configuration changes, uninstall malware, restore deleted logs, etc.

Of course, in order to properly automate cleanup tasks, you will need to have kept meticulous records on all of the exploits you launched, including what the exploits did and how they did it.


## Topic 20B - Follow-Up Actions
---
> [!note] Exam Objectives Covered
> *4.4 Explain post-report delivery activities.*

Even though the PenTest engagement is formally over with, you might still have a few final tasks to complete as a follow-up. The client will have to accept your report and its findings, which have to be backed up by evidence of what you found.

Ideally, the report should also contain recommendations to attend to the issues found during the penetration test. These mitigation recommendations can be tested again, for which a few more steps with the client will be needed.

Some examples include:

- Scheduling additional tests with the client organization.
- Working with the security team that will implement your recommended mitigations.
- Checking back with the client to see how their mitigation efforts are going.
- Researching and testing new vulnerabilities that your team discovered during the test.
- Researching vulnerabilities for which the team could not recommend a mitigation tactic.
- Informing the organization when/if a mitigation tactic is eventually found.

## Gaining the Client's Acceptance
---
After finishing your PenTest and writing the report, you should plan to have a discussion with the client about the findings in the report.

During the formal hand-off process, you will need to get confirmation from the client that they agree that the testing is complete and that they accept your findings as presented in your report. Use the meeting to discuss with the client anything that needs to be clarified or changed in the report before they can be confident in its conclusions.

Gaining the client's acceptance is of paramount importance, as they will not automatically be satisfied with your report just because you have written one. They need to be convinced that the test was worthwhile from a business standpoint and that it truly met the objectives that were set out during the planning phase. You could, for example, provide them with a ***cost–benefit analysis (CBA)*** of implementing your recommended mitigations.

The client may also wish to assess how well the test adhered to the established scope. They may even benefit from a better understanding of your testing methodology. In certain circumstances, they may also voice their concerns with how the test was handled, which is also important in order to understand how to better manage future situations.

Ultimately, you must work with the client to address their concerns and prove to them that the test was conducted in their best interests.

### Confirming the Findings
---
**Attestation** is the process of providing evidence that the findings detailed in the PenTest report are true. In other words, by signing off on the report given to the client, you are attesting that you believe the information and conclusions in the report are authentic.

Attestation is perhaps the most significant component of gaining client acceptance, as the client must believe that what you have said about their people, processes, and technology is accurate. Many organizations will not simply trust your word that a particular vulnerability exists, even if you've built yourself a good reputation over the years. You must be prepared to prove what you claim.

Proof can come in many forms, and those forms usually depend on the nature of what is being proven. For example, if you want to prove that you were able to break into a server holding sensitive data, you could present exfiltrated data to the client as proof.

If you want to provide evidence of a backdoor, you could give the client a live demonstration of accessing a host using a reverse shell. If you want to prove that you were able to glean sensitive data in transmission, you could show the client packet capture files that include the plaintext data.

The threshold of evidence will differ from organization to organization, and some might be content with screenshots showing compromise rather than direct demonstrations. Once again, it's important to communicate with your client to identify their needs.

### Planning the Retest
---
For a retest, the purpose is to analyze progress made in applying the mitigations to the attack vectors that were found during the penetration test. The first step will be scheduling additional tests with the client organization in order to assess their progress, so a window of time should be provided for them to fix the issues.

You might need to work with the security team that will implement your recommended mitigations, so that they can better understand the impact of the issue, and better understand the time it will take to apply. You can check back with the client to see how their mitigation efforts are going and adjust the timing of the retest.

During this time the focus should be put into researching vulnerabilities for which the team could not recommend a mitigation tactic and inform the organization when/if a mitigation tactic is eventually found.

Additionally, researching and testing new possible vulnerabilities that your team discovered during the test.

### Reviewing Lessons Learned
---
An important part of any project is to identify any lessons learned during the project.

When you debrief within the penetration test team, you are likely to uncover things that did or did not work well. You can use this information to influence how you conduct future tests. The primary goal of drafting a **lessons learned report (LLR)** or after-action report (AAR) is to improve your PenTest processes and tools.

Failing to learn from these lessons can lead to repeating the same mistakes, inefficient use of your time, inaccurate or compromised findings and conclusions, and more—all of which will make it much harder for you to gain the client's acceptance.

When you draft an LLR, you should ask and answer several fundamental questions about the PenTest. Those questions can include:

- What about the test went well?
- What about the test didn't go well or didn't go as well as planned?
- What can the team do to improve its people skills, processes, and technology for future client engagements?
- What new vulnerabilities, exploits, etc., did the team learn about?
- Do the answers to these questions necessitate a change in approach or testing methodology?
- How will you remediate any issues that you identified?