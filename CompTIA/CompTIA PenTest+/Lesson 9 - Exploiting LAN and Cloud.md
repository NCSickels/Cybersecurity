## Lesson Introduction
---
After scanning for vulnerabilities, the team will then be armed with information that will allow them to move to the attack phase and test the strength of the LAN. One common step in active reconnaissance is to establish a connection by enumerating open ports, services, and Active Directory objects. There are many attacks a team can launch, such as MAC address spoofing and New Technology LAN manager (NTLM) relay attacks. To achieve this goal, the PenTest team has a number of exploit tools that they can use to launch an attack, such as mitm6, SearchSploit along with Exploit-DB. Today, many organizations house resources on the cloud. As a result, the team should be aware of possible threats such as injection, denial of service, or side channel attacks. To achieve this the team can use a variety of automated vulnerability and penetration testing tools such as cloud custodian, Pacu, and CloudBrute.

## Lesson Objectives
---
In this lesson, you will:

- Distinguish a variety of methods used to establish a connection to network hosts, services, and Active Directory objects.
- Paraphrase different attacks on local area network protocols such as ARP poisoning, MAC spoofing, Kerberoasting and Denial of Service (DoS) attacks.
- Summarize the different exploit tools available, such as Metasploit, Responder and SearchSploit along with a discussion on their capabilities.
- Outline methods to discover cloud vulnerabilities when dealing with storage and virtualized containers, along with recognizing the need to control Identity and access management.
- Explore the various cloud-based attacks, such as credential harvesting and resource exhaustion, that can lead to data compromise, along with tools that can be used to assess compliance.

## Topic 9A - Enumerating Hosts
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *3.7 Given a scenario, perform post-exploitation techniques.*

Enumeration is a crucial step in the PenTesting process as it uses various techniques to query a device or service for information on its configuration and resources. Once you have connected to a host, you can interrogate it for details that will reveal additional attack vectors. Enumeration can help you discover the following:

- Operating systems and services in use
- User and group names and contact information
- Email addresses, passwords, and password hashes
- Host names, domain information, and IP addresses
- Network services such as DNS and SNMP
- Network devices such as servers, routers, and switches

In this section, we’ll see how to index services and hosts on the network along with ways to discover objects on both Windows and Linux operating systems. In addition, we’ll take a look at common techniques to enumerate hosts during active reconnaissance.

Let’s start with learning how to complete an inventory of the network.

### Indexing the Network
---
Enumeration is cataloging objects on the network to provide a more targeted list for further exploitation. While some enumeration can be done without a credential, the exercise is generally more successful if you can log into the system. In many cases, the credential can be that of an average user and doesn’t always require a privileged account. Once you are logged in, you can use the command prompt or other tools to enumerate information, such as network services and shares. In addition, it’s also common to enumerate websites for resources along with obtaining details on the underlying technology in use.

Let’s see what’s involved in investigating network services and shares.

#### Discovering Services and Shares
Many system administrators aren't fully aware of all the services running on their network. Services can include backup software, network monitoring applications, certification testing systems, Malware Analysis Servers, Anti-virus services, conferencing systems, project management tools, and drawing and coding applications.

Some common services to enumerate include the following:

|              **Service**               | **Port**     | **Goals**                                                                                   |
| :------------------------------------: | ------------ | ------------------------------------------------------------------------------------------- |
|     *File Transfer Protocol (FTP)*     | TCP port 21  | Identify FTP servers, versions, and authentication requirements including anonymous logins. |
| *Simple Mail Transfer Protocol (SMTP)* | TCP port 25  | Extract email addresses. Enumerate SMTP server information. Search for open relays.         |
|       *Domain Name System (DNS)*       | TCP port 53  | Elicit DNS zone transfers and discover DNS subdomains.                                      |
|  *Hypertext Transfer Protocol (HTTP)*  | TCP port 80  | Manually request web pages, enumerate directories, files, WebDAV features, and versions.    |
|      *Server Message Block (SMB)*      | TCP port 139 | Retrieve directory information, list, and transfer files.                                   |

In addition to services, most organizations make files available on the internal network for users to access. This is typically done through the use of network _shares_, which are directories that can be accessed by using a network sharing protocol. These network shares might hold sensitive files or information that is otherwise useful to the PenTesting team.

On most networks, shares can be enumerated on either Microsoft or Linux/Unix (nix) hosts.

- **Microsoft hosts**: Microsoft File and Print service, using Server Message Block (SMB) protocol via TCP ports TCP 139 or 445
- **Linux/Unix ( `*nix` ) hosts**: Network File System (NFS) daemon using the NFS protocol via TCP and UDP 2049

Within most operating systems, there are many built-in commands to scan and enumerate network shares. In addition, you can use other tools such as Metasploit and ShareEnum.

**Metasploit** is a platform for launching attacks against known software vulnerabilities and includes several modules for enumerating network shares. For example, using the following command: `auxiliary/scanner/smb/smb_enumshares` will enumerate any available SMB shares on the remote system. Even without authentication you will be able to collect valuable information, such as share names, OS versions, and service packs.

**ShareEnum** is a Sysinternals GUI tool that can scan a domain, workgroup, or IP address range for file and print shares along with their security settings. As shown in the screenshot we see the share path along with the hidden shares that end in $:

![[Pasted image 20240604132618.png]]
*ShareEnum Window*

> [!warning] ShareEnum is most effective when you run it from a domain administrator account.

During enumeration, it’s common to evaluate websites as well. Let’s see what we can learn.

#### Enumerating Websites
Website enumeration involves discovering the resources and underlying technology that the web server is using. The information can help you choose more effective vectors to use in an attack, as well as exploit vulnerabilities in specific versions of web server software.

You can use several tools to enumerate websites, including a browser, Nmap, Metasploit, and DirBuster.

For example, using the Uniform Resource Locator (URL) or IP address for one or more hosts, you can use Nmap to enumerate information. Nmap has several scripts you can use for popular web applications, such as the following:

- `nmap --script=http-enum <target>`
- `nmap --script=http-drupal-enum <target>`
- `nmap --script=http-php-version <target>`
- `nmap --script=http-webdav-scan <target>`
- `nmap --script=http-wordpress-enum <target>`

Some websites are deliberately configured to use non-standard ports. If you're not sure of the port, you can scan all of them to try to determine what services are bound to these ports, and possibly identify the web applications. The following example will use a TCP connect scan against all open ports on IP 192.168.1.50:

`nmap –PN –sT –sV –p0-65535 192.168.1.50`

Once run, you can then examine the output for web services, as shown below:

Interesting ports on 192.168.1.50:

`(The 65527 ports scanned but not shown below are in state: closed)`

|  **Port**  | **State Service** |               **Version**               |
|:----------:|:----------------- |:---------------------------------------:|
|  **`22/tcp`**  | **`open ssh`**        |     **`OpenSSH 3.5p1 (protocol 1.99`**      |
|  **`80/tcp`**  | **`open http`**       | **`Apache httpd 2.0.40 ((Red Hat Linux))`** |
| **`443/tcp`**  | **`open ssl`**        |                **`OpenSSL`**                |
| **`901/tcp`**  | **`open http`**       |   **`Samba SWAT administration server`**    |
| **`1241/tcp`** | **`open ssl`**        |        **`Nesses security scanner`**        |
| **`3690/tcp`** | **`open unknown`**    |                    **-**                    |
| **`8000/tcp`** | **`open http-alt?`**  |                    **-**                    |
| **`8080/tcp`** | **`open http`**       |  **`Apache Tomcat/Coyote JSP engine 1.1`**  |

The results show the following:
1. An Apache HTTP server is running on port 80.
2. A Samba Web Administration Tool (SWAT) web interface is on port 901.
3. Apache Tomcat is running on port 8080.

However, there are a few ambiguous results as follows:
- There appears to be an HTTPS server on port 443. To confirm this, open a browser and enter `https://192.168.1.50`.
- The service on port 1241 is not HTTPS but is the SSL-wrapped Nessus daemon.
- There is an unspecified service on port 8000. To see if it's HTTP, open a browser to `http://192.168.1.50:8000`.

As we can see, enumeration can show us a great deal of information; however, we will most likely need to run further tests to confirm the scan results.

In addition to enumerating services and shares on the network, the team will also need to assess the hosts using Windows OS along with Active Directory objects.

### Cataloging Windows OS
---
The Windows OS is one of the most widely used OS in the world today. As a result, it’s good practice to enumerate Windows hosts on the network, as the team can learn a great deal of information. In addition, it’s also possible to retrieve a wide range of information from Active Directory objects.

Let’s see what we can learn from scanning Windows hosts.

#### Enumerating Windows Hosts
After completing a ping sweep to identify interesting hosts in a Windows environment, the next logical step is to enumerate hosts on the network.

When enumerating Windows hosts, there are a number of tools you can use, including the built-in tools within the operating system. For example, using the CLI, the team can issue the following commands:

|        **Command**         | **Purpose**                                          |
| :------------------------: | ---------------------------------------------------- |
|       **`net view`**       | To view shares from other hosts in the network.      |
|        **`arp -a`**        | To view the Address Resolution Protocol (ARP) cache. |
|       **`net user`**       | To list all users on the machine.                    |
| **`ipconfig /displaydns`** | To display resolved DNS names.                       |
In addition to the built-in commands and utilities within the OS, there are several popular tools for Windows host enumeration that include PowerShell, Nmap, and Metasploit.

- **PowerShell (PS)** uses cmdlets, which are a verb-noun pairing to achieve a task, such as Get-Help, and can enumerate information such as OS version, shares, files, services, Registry keys, and policies
- **Nmap** has a wide range of commands and NSE scripts for host enumeration to fingerprint the operating system and interrogate its services.
- **Metasploit** has several modules that can enumerate hosts. For example, the team can run the `enum_applications` module to determine what applications are installed on the target host.

Next, let’s see how Active Directory (AD) can also be used to enumerate objects on a Windows environment.

#### Searching Active Directory
A directory service allows information to be stored, classified, and retrieved. Active Directory (AD) is the directory for a Microsoft environment and is a database of objects that stores, organizes, and enables access to other objects. AD also provides essential network services such as DNS and Kerberos-based authentication. As shown in the graphic, the structure of AD is as follows:
![[Pasted image 20240604133702.png | 550]]
*Active Directory Structure*

At the top of the structure is the Forest. Off of the Forest will be the following:

- A **Tree** is formed with a collection of domains and sub-domains.
- A **Domain** is the core of a Windows network. The first domain created is the root. Successive domains beneath that are referred to as child domains that have their own unique name.
- **Organizational units** **(OU)** are used within a domain to group similar objects such as users, groups, computers, and other OUs and are used to minimize the number of domains.
- **Users** represent a person or process that needs access to a resource. Each user has attributes such as name, password, and email address.
- A **group** is a _collection_ of users or computer accounts. A group is different from a container in that it does not store the user or computer, it just lists them. Groups make administration easier when assigning rights and permissions.

In some cases, a non-privileged user can query AD for information. In addition to tools such as Nmap and Metasploit, the team can use the Active Directory PowerShell plugin to enumerate information such as users, groups, and domains. Some of the PS cmdlets available for AD enumeration are listed in the following table:

|        **cmdlet**        | **Purpose**                                                |
| :----------------------: | ---------------------------------------------------------- |
|   **`Get-NetDomain`**    | Get the current user's domain.                             |
|  **`Get-NetLoggedOn`**   | Get users that are logged on to a given computer.          |
| **`Get-NetGroupMember`** | Get a list of domain members that belong to a given group. |

Along with enumerating Windows systems, the team may choose to enumerate Linux OS.

### Listing Linux Systems
---
As with Windows, there are many tools and Linux commands that you can use to enumerate information. For example, once you compromise a Linux machine in Metasploit, you can use the `post/linux/enum_system` module to get information about the system. Additional enumeration modules include:

- `enum_configs`
- `enum_network`
- `enum_protections`
- `enum_logged_on_users`

You can also use `nmap -O or -sV` scans to fingerprint the operating system and interrogate its services. If the Linux host is running the Samba service, you can use `nmap smb-*` NSE scripts against the target, such as the following: `nmap --script=smb-os-discovery 192.168.1.20`.

It’s also possible to use the built-in Bash commands as there is a very wide range to choose from. The following table lists just a few that you can use:

|      **Command**      | **Purpose**                                                  |
| :-------------------: | ------------------------------------------------------------ |
|     **`finger`**      | View a user's home directory along with login and idle time. |
| **`cat /etc/passwd`** | List all users on the system.                                |
|    **`uname -a`**     | Displays the OS name, version, and other details.            |
|       **`env`**       | Outputs a list of all the environment variables.             |

> [!warning] Some commands require root privilege.

## Topic 9B - Attack LAN Protocols
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *3.1 Given a scenario, research attack vectors and perform wireless attacks.*

A Local Area Network (LAN) can be a vulnerable target. As a result, the team will need to test the LAN to see if any exploits against the LAN is possible. In this section, we’ll cover some LAN attacks such as virtual LAN (VLAN) hopping, on-path attacks, and spoofing various LAN protocols. We’ll finish with seeing how we can chain multiple exploits to form a larger more complex attack.

Let’s start with a VLAN hopping attack.
<font style="color: red">VIDEO NEEDED</font>

### Moving Between VLANs 
---
<mark style="background: #FFF3A3A6;">A VLAN is a logical grouping of switch ports that can extend across any number of switches on a network. Each VLAN has its own network address and is logically segmented from the rest of the network. Because each VLAN is its own separate network, they must communicate with other VLANS by using either a Layer 3 switch or router.
</mark>
<mark style="background: #FFF3A3A6;">VLANs are used to organize devices by security need and/or to limit the impact of broadcast traffic on the larger network. The most common use cases are to segregate the network by department, device type, or security level. This separation allows the network admin to set policies to control access between hosts. Ordinarily, a switch port or Wi-Fi connection can only belong to one VLAN at a time and cannot change unless specifically configured by the network administrator.</mark>

> [!warning] In some cases, VLAN membership for a device is dynamically determined by its MAC address. The network administrator pre-creates a list of VLANs and the MAC addresses that belong to them. When the device is plugged in, its MAC address is checked against the database, and the corresponding VLAN ID is dynamically assigned to that port.

VLANS communicate through switches. A switch must be configured to allow VLAN traffic to pass between two switches by using a trunk line (or trunk link). Cisco uses ***VLAN Trunking Protocol (VTP)*** to propagate information to switches. In addition, Cisco also uses ***Dynamic Trunking Protocol (DTP)*** to automatically negotiate and form a trunk line between Cisco switches.

***VLAN hopping*** is the act of illegally moving from one VLAN to another. To launch this attack, a malicious actor can do one of the following:

- Launch a ***Macof attack***, which overflows the MAC table on a vulnerable switch so that it behaves like a hub, repeating frames out all ports.
- Configure the interface of an attacker machine to become a trunk port. It will then negotiate an unauthorized trunk link with the switch, which allows traffic from any VLAN to flow over that link. This allows the attacker machine to then apply the desired VLAN tag to malicious packets. The switch will then deliver those packets to the restricted VLAN.
- VLAN double tagging or switch spoofing.

To prevent this, the network administrator should disable DTP. In addition, there are other best practice suggestions for using VLANS. Those include using a dedicated VLAN ID for all trunk ports, disabling any unused switch ports, putting them in an unassigned VLAN, and not using VLAN 1.

> [!important] Double Tagging
> Double tagging is an attack technique that allows an attacker to gain unauthorized access to VLANs. This is done by sending packets to a VLAN that would not normally be accessible. For example, we can craft a packet using Scapy: **`sendp(Ether()/dot1q(vlan=100)/dotq(vlan=50)/IP(dst="172.16.50.10")/ICMP())`**

> [!important] Switch Spoofing 
> Switch spoofing is an attack technique that can allow the attacker visibility into traffic on VLANs other than their native VLAN. Switch spoofing relies on a switch interface that is configured as either dynamic desirable, dynamic auto, or trunk mode, allowing an attacker to generate dynamic trunk protocol messages, and subsequently access traffic from all VLANs.

Another attack is an on-path attack, which was previously known as man-in-the-middle (MITM) attack. Let’s explore ways this can happen.

### Launching an On-Path Attack 
---
An on-path attack is when a malicious actor sits in the middle or in the path of a connection. It differs from a hijacking attack in that it does not replace the client but rather acts as a relay between the client and server. Both sides think they are communicating directly with each other, but they are actually doing it through the on-path attack. The on-path attack then captures information that might otherwise be encrypted or manipulates the data in some other way.

One example of an on-path attack is an **SSL/TLS downgrading/stripping** attack that works in the following manner:

1. A malicious actor sits between a web client and server and creates a secure HTTPS session with the server.
2. The malicious actor will then force the client to accept either a cleartext HTTP session or a downgraded HTTPS session with a more vulnerable version of SSL/TLS.
3. The malicious actor will run some type of sniffer that can collect credentials as the user logs on and communicates with the server.

Another on-path attack uses a ***Wi-Fi Pineapple***, which is a rogue wireless access point that attracts Wi-Fi clients to connect to the network. Once the victim connects, the malicious actor can gather all data and credentials.

The team has several tools that can be used to launch an on-path attack, including ettercap, Bettercap, Netcat, and Nmap. However, in most cases, an on-path attack requires some type of spoofing. Let’s talk about types of spoofing techniques next.

### Spoofing LAN Protocols
---
With an on-path attack, a malicious actor is in the middle of a communication channel and is able to intercept all traffic. This is generally done by using either a spoofing or cache poisoning strategy, such as one of the following:

- **Domain Name System (DNS) cache poisoning** sends bogus records to a DNS resolver. When the victim requests an IP address, the DNS server will send the wrong IP address. That will redirect traffic to the malicious actor’s IP address instead of the web server’s IP address.
- **Address Resolution Protocol (ARP) spoofing** transmits spoofed ARP messages out on the LAN. The spoofed messages falsely report a malicious actor’s MAC address as being the victim's address. Similar to a DNS cache poisoning attack, this will redirect traffic to the malicious actor instead of the victim’s MAC address.
- **MAC address spoofing** will modify the MAC address on the malicious actor’s NIC card so that it matches the MAC address on the victim’s machine. Once done, the traffic can become inconsistent, causing traffic to not deliver correctly or not at all.

By using any of these attacks, when a device needs to deliver a message to the victim, it will instead send the message to the malicious actor.

Additionally, there are other attacks designed to spoof or misdirect the victim. Link-Local Multicast Name Resolution (LLMNR)/NetBIOS-Name Service (NBT-NS) poisoning is another attack that a malicious actor can use on a LAN. Let’s take a look.

### Poisoning LLMNR and NBT-NS
---
LLMNR and NetBIOS are two name resolution services used in a Windows environment to resolve network addresses. During name resolution, if a Windows host cannot resolve a domain or host name via a DNS server, it will query other hosts on the local segment. By default, the process will first use LLMNR, and if that fails, it will try the NetBIOS Name Service (NBT-NS).

***Responder*** is a on-path type tool that can be used to exploit name resolution on a Windows network. It is designed to intercept and poison LLMNR and NBT-NS requests, as shown in the following screenshot:
![[Pasted image 20240604134519.png]]
*Retrieving a user's password hash using Responder.*

Once a request is intercepted, Responder will return the attacker's host IP as the name record, causing the querying host to establish a session with the attacker.

For the attack to work, the victim system must either be tricked into querying a nonexistent name or prevented from using the legitimate DNS service.

> [!warning] Responder can also be used in analysis mode to monitor name resolution traffic without responding. This can help an attacker map out names used on the network and select a target.

Another way to circumvent an authentication process is by grabbing and using password hashes. Let’s see how this works.

### Obtaining the Hash
---
A password is one of the most common ways to provide authentication. While obtaining a password isn’t always feasible, it may be possible to obtain a password hash. Once obtained, a malicious actor can use the hash in a relay attack or attempt to crack the hash and obtain the cleartext password.

First, let’s see what’s involved in a relay attack.

#### Passing the Hash
One attack that uses a hash is a ***New Technology LAN Manager (NTLM)*** relay attack. In this case, the malicious actor doesn’t try to crack the password but instead will use the hash in an attack called ***pass the hash (PtH)***. In this type of attack the malicious actor will:

1. Obtain the hash by inducing the operating system or application to dump them from RAM, the Windows Registry, or a credentials file.
2. Then when logging into the target operating system or application, you provide the username and the hash of the password, rather than the password itself.

Once accepted, the malicious actor will be able to access the operating system or application.

Another attack that uses a hash is called Kerberoasting.

#### Kerberoasting
One method of obtaining a hash is by using Kerberoasting. In this attack, the malicious actor will do the following:

1. Get user ***Service Principal Names (SPN)***, which will identify all accounts that are candidates for Kerberoasting.
2. From the list of SPNs, get the service tickets of an interesting target, such as a server.
3. Dump out the service ticket, which is encrypted with the NTLM hash of the requested service account.
4. Crack the account's plaintext password offline.

Once you obtain the password, you can then continue to take control of the system. Kerberoasting is a significant attack as many services have admin privileges, and their passwords are seldom changed.

Many attacks require multiple steps to achieve the end goal. Next, let’s see why exploit chaining may be required for a successful attack.

### Chaining Exploits
---
Exploit chaining is the act of using multiple exploits to form a larger attack. Success of the attack will depend on all exploits doing their part. Using multiple forms of attacks in a distributed nature makes them complex and difficult to defend against.

Chained exploits can either run consecutively, with each depending on the previous exploit to complete, or they can run in parallel, where each part would have to be in place and complete for the final attack or payload to succeed.

<mark style="background: #FFF3A3A6;">Some examples of exploit chaining include:</mark>

- <mark style="background: #FFF3A3A6;">A Metasploit exploit that results in a user-level shell, followed by a local privilege escalation attack to give the shell system-level privileges.</mark>
- <mark style="background: #FFF3A3A6;">A module that runs a SQL injection, authentication bypass, file upload, command injection, and privilege escalation to finally give the attacker a root level shell.</mark>
- <mark style="background: #FFF3A3A6;">Physically (or electronically) breaking into a private network, planting a malicious device, then using that device to discover and attack vulnerable systems.</mark>
- <mark style="background: #FFF3A3A6;">Distracting a security guard so a colleague can tamper with a camera or alarm system while another colleague breaks into a private office to steal important documents.</mark>

As illustrated, there are many possible attacks to the Local Area Network, using many different tools and techniques.

## Topic 9C - Compare Exploit Tools
---
> [!note] Exam Objectives Covered
> *3.1 Given a scenario, research attack vectors and perform wireless attacks.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

When it’s time to launch an exploit against the target, the team will have choices in what tools are required for an effective attack. In this segment we’ll take a look at Metasploit, a platform for launching modularized attacks against known software vulnerabilities. In addition, we’ll also evaluate other exploit resources, such as Impacket tools, Exploit database (DB), and SearchSploit to help the team launch a more focused attack on the target.

Let’s start with an overview of Metasploit.

### Testing with Metasploit
---
Metasploit is a multi-purpose computer security and penetration testing framework that is used worldwide for both legitimate security analysis and unauthorized activities. Developed by Rapid7, it is intentionally modular, as it allows the attacker to mix and match scanners, exploits, and payloads into a single attack.

Metasploit currently comes in three editions:

- **Metasploit Framework**—the free open-source command-line version (installed by default in Kali Linux)
- **Metasploit Express**—a simplified commercial edition for security professionals who want to validate vulnerabilities
- **Metasploit Pro**—a full-featured graphical version that includes Quick Start wizards, easy vulnerability scanning and validation, phishing campaigns, and reporting.

Along with the Rapid7 projects, there are two popular GUI-based spin-offs:

- **Armitage**—an intuitive GUI for Metasploit framework
- **Cobalt Strike**—a commercial version of Armitage with advanced features and reporting

Metasploit's features are organized into modules. There are six basic types as outlined in the following table:

| **Module**  | **Function**                                                              |
| :---------: | ------------------------------------------------------------------------- |
| *Exploits*  | Attack software that delivers a payload.                                  |
| *Payloads*  | Code that runs remotely.                                                  |
|   *Post*    | Additional tasks you can perform on a compromised host.                   |
| *Auxiliary* | Scanners, sniffers, fuzzers, spoofers, and other non-exploit features.    |
| *Encoders*  | Ensures that payloads make it to their destination intact and undetected. |
|   *Nops*    | Keeps payload sizes consistent across exploit attempts.                   |

Each type has many modules inside, grouped by sub-type or platform. When using Metasploit, you specify a particular module by its path, as shown in the graphic below:
![[Pasted image 20240604135040.png | 550]]
*Outlining the path in Metasploit*

Launch Metasploit Framework (MSF) by either selecting the MSF launcher on the Kali desktop toolbar or by entering `msfconsole` in a regular terminal window. Once you have specified the module, you usually have to set options. Some are required and some are optional. Examples include:

- **RHOSTS** —(remote) target names or addresses
- **LHOST**—attacker ("listener") address
- **RPORT**—target port
- **LPORT**—attacker listener port
- **SMBUser**—a username for SMB-based attacks
- **SMBPass**—a password for SMB-based attacks

If you are using an exploit, you will also need to specify the payload. The payload is a program that runs on the target once it is compromised. The most popular payload is ***Meterpreter***, which is an interactive, menu-based list of commands you can run on the target.

Because of the many choices the team has when working with Metasploit, you may need to search for a specific exploit.

#### Searching the Modules
Both Metasploit Framework and Metasploit Pro allow you to search and select scanning modules. Armitage and Metasploit Pro both have a GUI interface that many find easier to use. You can search by a number of criteria, that include:

- A simple string that can appear anywhere in the module
- Type (exploit, auxiliary, payload, etc.)

Additionally, you can specify `-o <filename>` to save the output in CSV format.

> [!warning] Metasploit commands are not case sensitive.

For example, the team may want to launch a packet storm (also known as a broadcast storm or network storm), which is a sudden flood of traffic. A packet storm could be used in one of the following scenarios:

- To conduct stress testing, which monitors the ability of a network to be able to provide availability under extreme traffic conditions.
- To launch a ***denial of service (DoS)*** attack that will consume all available bandwidth and prevent the normal flow of traffic.

If launching a packet storm for a DoS, the team might want to try a ***Character Generator Protocol (CharGEN) attack***. CharGEN is a legacy protocol that was developed as a testing tool. However, the protocol can be used as part of a DoS attack, as when used, CharGEN will output a string of characters, as shown in the screenshot:
![[Pasted image 20240604135231.png | 600]]
*Characters generated hen using the CharGEN protocol*

To see if Metasploit has any modules related to CharGEN, you can search using the command: `search chargen`, which will output the following:
![[Pasted image 20240604135320.png | 600]]
*Search in Metasploit for CharGEN exploit*

Other search examples include the following:

|             **Search Parameters**              | **Desired Results**                                                                 |
| :--------------------------------------------: | ----------------------------------------------------------------------------------- |
|     **`search EternalBlue type: exploit`**     | Find every exploit that refers to EternalBlue.                                      |
|    **`search Windows/MSSQL type:exploit`**     | Find every exploit that can be used against Microsoft SQL running on Windows.       |
| **`search Windows/SMB type:exploit -S great`** | Find all Windows-based SMB exploits that have an excellent (most reliable) ranking. |

Once you have found a module that you would like to try, use the search results to give you the path to that module so that you can launch an exploit.

For example, the team might want to search for MSSQL scanners, which will present a list of matching modules, as shown in the screenshot:
![[Pasted image 20240604135516.png]]
*Using a scanner*

The command `auxiliary(scanner/mysql/mysql_ping) >show options` will list options. Once the options are entered you can then begin the scan by typing run or exploit then enter.

Metasploit will then scan a host/range for any machine listening on UDP 1434 (MSSQL server), then try to determine the TCP port (default or not) that the Microsoft SQL Server is using.

You can have several MSF/Meterpreter sessions running simultaneously. Let’s see how we can manage the sessions.

#### Managing the Session
In some cases, you will need to have multiple sessions running during an exploit. Here are some syntax examples that you can use to manage the sessions:

Press `Ctrl+Z` to put your current session in the background.

`msf > sessions -l` will list all of the sessions you currently have running.

`msf > sessions 2` will then switch to session #2.

The following screenshot is an example of managing multiple Meterpreter sessions:
![[Pasted image 20240604135608.png]]
*Managing multiple Meterpreter sessions*

Metasploit is a powerful tool that is used for a wide range of exploits. However, there are several others that have a specific purpose when PenTesting the LAN. Let’s explore some of those next.

### Recognizing Other Tools
---
Many times, the team will use a variety of methods to launch an effective attack. That is why it’s in your best interest to become familiar with the various tools available for PenTesting.

The following are some of the tools that can be used when working on a LAN:

- **Impacket tools** is an open-source collection of tools used when PenTesting in a Windows environment. The Impacket library provides methods for several attacks such as an NTLM and Kerberos authentication attacks, pass the hash, credential dumping, and packet sniffing.
- **Responder** is a command line tool in Kali Linux used to poison NetBIOS, LLMNR, and MDNS name resolution requests.
- **mitm6** <mark style="background: #FFF3A3A6;">is an IPv6 DNS hijacking tool that works by first replying to DHCPv6 messages that set the malicious actor as DNS server. It will then reply to DNS queries with bogus IP addresses that redirect the victim to another malicious host.</mark>

In addition to the tools used to launch attacks, the PenTest team will need to be aware of all possible exploits. While there are many repositories available, the team can use the ***Exploit Database (Exploit DB)*** which provides a complete collection of public exploits and vulnerable software in a searchable database. To search Exploit DB, the team can use ***SearchSploit*** , a tool included in the exploitdb package on Kali Linux.



## Topic 9D - Discover Cloud Vulnerabilities
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *3.7 Given a scenario, perform post-exploitation techniques.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

Cloud threats exist just as they do on a physical LAN. As a result, the team may be tasked in assessing the cloud for vulnerabilities. In this section, we’ll take a look at recognizing issues to address when dealing with storage and virtualized containers while running applications. In addition, because the most significant cloud threats lie in the improper configuration of identity and access management systems, we’ll see why it’s essential to test for this vulnerability.

Let’s start with learning the importance of properly configuring cloud assets.

### Configuring Cloud Assets
---
Cloud computing has become extremely popular in the past decade. With cloud computing, an organization can access and manage data and applications from any host, anywhere in the world. The storage method and location are hidden or abstracted through virtualization. The combination of infrastructure, platform services, and software represent a ***cloud federation***.

In a traditional LAN, an attacker may find the ability to breach the infrastructure difficult, as the network is isolated from the outside world. However, in a cloud environment, the attacker may simply need to have an internet connection and a dictionary of stolen password hashes to cause a breach. A lack of oversight in the security procedures of cloud providers can dramatically increase the risk an organization takes.

Conversely, cloud federation is a boon to attackers. The elastic computing power can be borrowed through the cloud from services such as those provided by Amazon, Microsoft, and Google. That power can enable an attacker to quickly scale their computing capabilities and to borrow access to resources in a way that can make their actions hard to trace. That in turn can make it easier for an attacker to run extensive password-cracking algorithms or host a command-and-control botmaster.

Many vulnerability assessment tools generally assume that all your organizational assets and infrastructure are located on a local or on-premises network. However, it's increasingly common for organizations to offload at least some of these assets and services to the cloud, if not entire systems and networks. Managing vulnerabilities in a hosted public cloud is more complex as you are likely to be dependent on the service provider.

The stakeholders will need to identify precisely where responsibilities lie in terms of threat and vulnerability management. In addition, they will need to make sure that the provider reports the outcomes of any security-related auditing to the team.

Part of operating in the cloud is running applications and services in virtualized environments. Next, let’s see how we reduce the risk when running applications.

#### Running Applications
When dealing with the cloud, applications can be deployed either in a virtualized or containerized environment. While both are the same concept, each has subtle differences along for the need to test for vulnerabilities.

***Virtual machines (VM)*** are the backbone for virtualized computing environments and are managed via a hypervisor. <mark style="background: #FFF3A3A6;">Part of testing should include regular audits of VMs to ensure they are kept within the scope of administrative oversight.</mark> Be particularly alert to the risk of VM sprawl and the creation of dormant VMs in the cloud.

> [!warning] A dormant VM is one that is created and configured for a particular purpose and then shut down or even left running without being properly decommissioned.

***Containers*** are an efficient and more agile way of handling virtualization. Each image contains everything needed to run a single application or microservice. <mark style="background: #FFF3A3A6;">However, a container image can have several vulnerabilities that include:</mark>

- <mark style="background: #FFF3A3A6;">Embedded malware</mark>
- <mark style="background: #FFF3A3A6;">Missing critical security updates</mark>
- <mark style="background: #FFF3A3A6;">Outdated software</mark>
- <mark style="background: #FFF3A3A6;">Configuration defects</mark>
- <mark style="background: #FFF3A3A6;">Hand-coded cleartext passwords</mark>

Prior to deploying the container, the network administrator should test and mitigate any vulnerabilities and then, once trusted, preserve the image.

Within the cloud federation, there is storage that can also be a target for malicious actors.

### Understanding Storage Vulnerabilities
---
Cloud storage containers are referred to as buckets. A container is created within a specific region and cannot be nested within another container. Each container can host data objects, which is the equivalent of files in a local file system. In addition, a container can have customizable metadata attributes.

Access control can be administered through a mixture of container policies, ***Identity and access management (IAM)*** authorizations, and object ACLs. Consequently, the permissions system for cloud storage can be more complex to administer than local storage, and it is easy to make mistakes. For example, the following misconfigurations can expose data and apps to risks:

- **Incorrect permissions**—When storage containers are created, they may default to public read/write permissions. If the default permissions are not properly configured, any data that is uploaded to the container can be freely accessed. In addition, the container can also be misused as a repository for malware.
- **Incorrect origin settings**—Data in cloud storage can be used to serve static web content, such as HTML pages, images, and videos. In this scenario, the content is published from the container to a ***content delivery network (CDN***).<mark style="background: #FFF3A3A6;"> The CDN caches the content to edge locations throughout its network to provide faster access to clients located in different geographic locations. When a site is built this way, it must usually use objects from multiple domains, which is normally blocked by client web browsers. A</mark> ***cross origin resource sharing (CORS) policy*** <mark style="background: #FFF3A3A6;">instructs the browser to treat requests from nominated domains as safe.</mark> Weakly configured CORS policies expose the site to vulnerabilities such as XSS.

The above are examples of _consumer side_ configuration risks. Storage is also potentially vulnerable to insider threat or compromise of the ***Cloud Service Provider (CSP)*** systems. Compromises could include data breach (confidentiality), and also data destruction (availability), or integrity issues.

The administrator should understand the design of a CSP's storage permissions. Policies should be created to guide the application of permissions settings so that storage containers and objects are not exposed to unnecessary risk.

Another potential source of vulnerabilities is Identity and access management. Let’s see what’s involved in this important concept.

### Controlling Identity and Access Management
---
IAM defines how users and devices are represented in the organization, as well as how they are granted access to resources based on this representation. To properly control access, it’s essential to have a solid understanding of identity and account types along with potential risks involved when managing access.

Let’s start with outlining the different types of identities.

#### Comparing Identity and Account Types
Every unique subject in the organization is identified and associated with an account. Keep in mind, subjects are not restricted to human users. The different types include the following:

- **Personnel**—The most common use for IAM is to define identities for organizational employees. Likewise, personnel identities are among the most popular attack vectors. People are often careless with the privileges they're given and may fail to understand how the personal information attached to their identities can be used against them and the organization. End-user security training is vital to ensure that personnel user accounts are not a major weak point in the IAM system.
- **Endpoints**—The devices that people use to gain legitimate access to your network are varied and often difficult to account for. If an employee accesses the network remotely with their personal device, there is no real guarantee that this device is security compliant. Centralized endpoint management solutions can assign identity profiles to known endpoints, which allows validated devices to connect with the requisite privileges and identifying information. Likewise, the solution may assign unknown endpoints to a specific, untrusted profile group that has few privileges. Endpoints are often identified by their MAC address, but keep in mind that this can be easily spoofed. A more secure system issues digital certificates to trusted endpoints, but it is a significant management task to support certificates on all client devices.
- **Servers**—Mission-critical systems can use encryption schemes, like a digital certificate, to prove their identity and establish trust. The most pressing issue with digital certificates is the security of the entity that issued the certificate. If this entity is compromised, then the identity of the server may not be verifiable. This is often why organizations buy certificates from major certificate authorities rather than establish their own ***public key infrastructure (PKI)*** or use self-signed certificates. In the case that the organization does run its own PKI, the root ***certificate authority (CA)*** and private key must be guarded closely.
- **Software**—Like servers, applications and services can be uniquely identified in the organization through digital certificates. This helps the client verify the software's provenance before installation. As with servers, the security of the entity that issued the certificate is paramount. One unique issue with applications is how to determine which other entities are allowed to run certain apps. Services like Windows AppLocker enforce identity policies that either allow or disallow a client from running a specific app based on the app's identity and the client's permissions.
- **Roles**—Roles support the identities of various assets such as personnel or software and define the resources an asset has permission to access based on the function that asset fulfills. Roles can be tied to a user's job tasks (i.e., administrator), a server's main functionality (i.e., name resolution), and/or the service an application provides (i.e., publishing). The main issue with role-based identity is that poorly defined roles can lead to privilege creep, violating the principle of least privilege and increasing an entity's chance at being a vector for attack. Thorough and meaningful role definitions are the most important remedy for this issue.

An IAM system usually contains technical components like directory services and repositories, access management tools, and systems that audit and report on ID management capabilities. Typical IAM tasks might include:

- Auditing account activity
- Evaluating identity-based threats and vulnerabilities
- Maintaining compliance with regulations
- Creating and deprovisioning accounts (onboarding and offboarding)
- Managing accounts (resetting user passwords, updating certificates, managing permissions and authorizations, and synchronizing multiple identities)

IAM must be supported by organizational policies and procedures plus training. Policy deviations can allow the creation of rogue accounts or allow improper control of an account. In the next section, let’s outline potential risks associated with IAM.

#### Recognizing Account Management Risks
Malicious actors target employees as a means of gaining access to the network. To avoid an attack, it’s important to provide oversight when using either privileged or shared accounts, as both can represent a vulnerability.

A **privileged account** will allow the user to perform additional tasks, such as upgrading the OS, and deleting, modifying, or installing software. A privileged account can be vulnerable for the following reasons:

- Users often adopt poor credential management habits, such as choosing bad passwords, writing down passwords, and reusing passwords on third-party sites.
- Administrators are often granted too many privileges or use accounts with "super" privileges for routine log-ons.

Therefore, it’s important to ensure that privileged accounts are tightly audited.

Another vulnerable account is a **shared account**, which can exist when the password or another authentication credential is _shared_ with more than one person. A shared account can be used in a small office home office (SOHO) environment, as many SOHO networking devices do not allow you to create multiple accounts. As a result, a single "Admin" account is used to manage the device. A shared account should be avoided, as it breaks the principle of nonrepudiation and makes an accurate audit trail difficult to establish.

These issues can be largely addressed by delivering training and education targeted to specific user groups. In addition, it’s always good practice to provide strong access control methods by using the principle of least privilege and routinely monitor and test networks.

## Topic 9E - Explore Cloud-Based Attacks
---
> [!note] Exam Objectives Covered
> *3.4 Given a scenario, research attack vectors and perform attacks on cloud technologies.*

With the pervasive nature of the cloud, it’s important to recognize the threats to the infrastructure. In this section, we’ll outline some of the cloud-based attacks that can occur, such as credential harvesting, resource exhaustion, and malware injection attacks that can lead to data compromise or exfiltration. We’ll also take a look at automated vulnerability tools such as ScoutSuite and Pacu that the team can use during the PenTesting exercise.

Let’s start with an overview of some of the attacks on cloud resources.

### Attacking the Cloud
---
The cloud is vulnerable to the same types of attacks that affect many applications. An attack against a cloud delivery model such as Software as a Service (SaaS), Platform as a Service (PaaS), and Infrastructure as a Service (IaaS) can result in a data breach. In addition to the financial impact of recovery fees and possible loss of intellectual property, a company that suffers from an attack can face fines, penalties, and legal action.

As a result, it’s important to recognize the cloud computing infrastructure is susceptible to several types of attacks that include:

- **Malware injection attack**: In this attack, a malicious actor injects malicious code into an application. Common attacks can include SQL injection (SQLi) and Cross Site Scripting (XSS). In addition, the service can fall victim to a wrapper attack, which wraps and conceals malicious code, in order to bypass standard security methods.
- **Side-channel attacks:** <mark style="background: #FFF3A3A6;">Also called a sidebar or implementation attack, this exploit is possible because of the shared nature of the cloud infrastructure, especially in a PaaS model. In this attack, the hardware leaks sensitive information such as cryptographic keys, via a covert channel, to a potential attacker.</mark>
- **Direct-to-origin attacks (D2O)** <mark style="background: #FFF3A3A6;">Many organizations seek to reduce the threat of a DDoS attack by using methods such as reverse proxies in front of the web servers. This insulates the servers from a possible attack as the malicious actor is unable to penetrate the defenses. However, in a D2O attack, malicious actors circumvent this protection by identifying the origin network or IP address, and then launching a direct attack.</mark>

> [!warning] When conduction a resource exhaustion attack on a target that uses autoscaling service architecture that leverages Content Delivery Networks, load balancers, or similar systems, the most probable attack technique is a Direct-to-Origin (D2O) attack.

In some cases, the malicious actors reap greater rewards by gathering credentials, as we’ll see next.

### Harvesting Credentials
---
Credential harvesting is an attack specifically designed to steal usernames and passwords. Harvesting can be done in a variety of ways, that include:

- An email phishing attack armed with links to bogus websites or malicious attachments.
- Social engineering techniques, digital scamming, and malware
- MITM attacks, DNS poisoning, and other vectors

In some cases, the malicious actor will use the credentials to take over an account to use in another attack. For example, a malicious actor might take over an email account to send out emails, IMs, or other forms of communication to mount further phishing attacks.

Once the malicious actor has harvested the credentials, they may choose to sell them on the dark web or use them to escalate privilege. Let’s see what can happen during privilege escalation.

#### Escalating Privilege
Privilege escalation is one of the primary objectives in any exploit. It allows the attacker to gain control, access/change sensitive files, and open a backdoor. <mark style="background: #FFF3A3A6;">During a PenTest, you will rarely get administrative access to a target system on your first attempt. In most cases, you'll need to find a way to elevate your access to administrator and then possibly to SYSTEM level access.</mark>

In addition to kernel-specific exploits, there are other types of attacks that can elevate privilege. The attacks can take advantage of services, drivers, and applications running in SYSTEM or administrator privilege. Similar to kernel exploits, most attacks are run locally, after you have gained access to the target. The following table highlights a few examples:

|            **Vulnerability/Technique**            | **Description**                                                                                                                                                                                            |
| :-----------------------------------------------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|       *Security Account Manager (SAM) file*       | Either dump the contents of the SAM file to get the hashed passwords or copy the file using Volume Shadow Service (VSS) <br>and then crack the passwords offline.                                          |
| *Local Windows User Account Control (UAC) bypass* | Bypass local UAC. One way is to use process injection to leverage a trusted publisher certificate.                                                                                                         |
|            *Weak process permissions*             | Find processes with weak controls and then see if you can inject malicious code into those processes.                                                                                                      |
|                 *Shared folders*                  | Search for sensitive information in shared folders, as it is common for them to have few or no restrictions.                                                                                               |
|     *Dynamic Link Libraries (DLL) hijacking*      | Elevate privileges by exploiting weak folder permissions, unquoted service paths, or applications that run from network shares. <br>Additionally, you can replace legitimate DLLs with malicious ones.     |
|                *Writable services*                | Edit the startup parameters of a service, including its executable path and account. You could also use unquoted service paths <br>to inject a malicious app that the service will run run during startup. |
|      *Missing patches and misconfigurations*      | Search for missing patches or common misconfigurations that can lead to privilege escalation.                                                                                                              |
> [!warning] To search Metasploit for local exploits that escalate privilege at the `msfconsole`, enter the following: `search exploit/windows/local -S Escalation`.

> [!important] DLL Hijacking
> When conducting a DLL Hijacking attack, if you want to take advantage of the default search order for a Windows system, remember that the default windows search order for the DLLs will be the directory the application is in, the current directory, the Windows system directory, the Windows directory, and then any directories listed in the **`PATH`** environment variable.

Next, let’s see how a denial-of-service attack can prevent a target from performing its normal duties on the network.

### Denying Service
---
A DoS attack can target a protocol, device, OS, or service. The results of a DoS attack will depend on the affected system. For example, a DoS attack against a server will consume all resources, including CPU, memory, disk space, and allowed client connections and can lock out legitimate users.

A related DoS attack is resource exhaustion, where the focus is on consuming system resources and can lead to a system crash or failure. Resource exhaustion uses various techniques such as:

- Amplification or volumetric attacks focus on saturating the bandwidth of the network resource.
- A denial-of-sleep attack will drain a device's battery, which in turn can render the device inactive.
- A slow HTTP attack sends fragmented requests and can stress the server, as compiling the fragmented requests can lead to depletion of processing resources.

For network-based DoS attacks, a single attacker is unlikely to have much (if any) impact. The most effective exploits are distributed denial-of-service (DDoS) attacks, in which thousands or hundreds of thousands of machines, typically in a botnet, are coordinated to attack a single target.

The following table summarizes some examples of DoS attack types along with some of the tools you can use to launch the attack.

|      **Attack Type**       | **Description**                                                                                                                                                                                                                                                | **Tool Examples**                                                                                    |
| :------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
|       *Packet flood*       | Create and send massive amounts of TCP, UDP, ICMP, or random packet traffic to target. <br>Can include different TCP flag variants.                                                                                                                            | hping3, Nemesy, XOIC, Low Orbit Ion Cannon (LOIC)                                                    |
|        *SYN flood*         | Create and send massive amounts of TCP SYN packets.                                                                                                                                                                                                            | hping3, Metasploit auxiliary/dos/tcp/synflood                                                        |
|        *Slowloris*         | Keep multiple fake web connections open for as long as possible, until the maximum number of <br>allowed connections is reached. Slowloris will allow one web server to take down another <br>without impacting other ports or services on the target network. | Nmap Slowloris script, R-U-Dead-Yet (RUDY)                                                           |
|    *NTP amplification*     | Send spoofed NTP queries to publicly available NTP servers to overwhelm a target.                                                                                                                                                                              | NTPDos, NTPDoser, Saddam                                                                             |
|    *HTTP flood attack*     | Use seemingly legitimate HTTP GET or POST requests to attack a web server. <br>Does not require spoofing or malformed packets but can consume a high number of resources <br>with a single request.                                                            | High Orbit Ion Cannon (HOIC), Low Orbit Ion Cannon (LOIC), <br>GoldenEye HTTP Denial Of Service Tool |
|     *DNS flood attack*     | Consume all CPU or memory of a DNS server with a flood of requests.                                                                                                                                                                                            | Hyenae                                                                                               |
| *DNS amplification attack* | Multiple public DNS servers receive spoofed queries and respond to a target.                                                                                                                                                                                   | Saddam                                                                                               |

In most cases, to launch a DoS attack, you would enter your parameters and the tool will then begin the attack. For example, the following shows the command and output from a web server SYN flood generated from the hping3 tool:
![[Pasted image 20240604140809.png]]
*Hping3 web server SYN flood*

> [!warning] You can search for Metasploit DoS modules at the `msfconsole`. For example, to search for DoS attacks that involve DNS, enter `search dns dos`

Because of the proliferation of cloud services, it may be in the scope of the PenTest to assess cloud resources. In the next section, let’s take a look at tools used to audit the cloud.

### Auditing the Cloud
---
Today, there are a number of tools available to perform automated vulnerability scanning and PenTesting on cloud assets. The tools can test security configurations or perform extensive compliance auditing and include ScoutSuite, Prowler, Pacu, and Cloud Custodian.

Let’s start with ScoutSuite.

#### Discovering ScoutSuite
ScoutSuite is an open-source tool written in Python that can be used to audit instances and policies created on multicloud platforms, such as AWS, Microsoft Azure, and Google Cloud. ScoutSuite collects data from the cloud using API calls. It then compiles a report of all the objects discovered, such as VM instances, storage containers, IAM accounts, data, and firewall ACLs.

The team can configure rulesets to categorize each object with a severity level, if a policy is violated. For example, the following rule will flag unauthenticated access to a ***Simple Storage Service (S3)*** bucket with a severity level of _danger:_
```bash
“allow-unauthenticated-access-to-S3-bucket”:[
{
"enabled": true,
"level": "danger"
}]
```

ScoutSuite can work with a variety of platforms. However, some tools are designed to only work with AWS. One such tool is Prowler.

#### Using Prowler
Prowler is an audit tool for use with Amazon Web Services only. It can be used to evaluate cloud infrastructure against the ***Center for Internet Security (CIS)*** benchmarks for AWS, plus additional GDPR and HIPAA compliance checks.

> [!warning] The Center for Internet Security (CIS; [cisecurity.org](https://www.cisecurity.org/)) is a not-for-profit organization that publishes the well-known "18 CIS Controls" which represent system design recommendations. The complete list can be found at [www.cisecurity.org/controls/cis-controls-list](https://www.cisecurity.org/controls/cis-controls-list/).

If an attacker or PenTest team has the credentials of one user within a cloud account, they can attempt to gather information about other accounts and services that have been configured. In addition, they can use various attacks to widen and deepen their access. As a result, an authenticated PenTest is a more powerful method to assess the security of cloud resources.

Pacu is a tool that can perform an authenticated PenTest. Let’s explore how this type of assessment can help the PenTest team.

#### Testing with Pacu
Pacu is designed as an exploitation framework to assess the security configuration of an AWS account. It includes several modules so the team can attempt exploits such as obtaining API keys or gaining control of a VM instance. For example, the module shown in the screenshot below will enumerate user accounts:
![[Pasted image 20240604141425.png]]
*Using Pacu to enumerate user accounts*

Pacu focuses on the post-compromise phase, so the team can drill down into the system to escalate privileges, launch additional attacks, or install a backdoor.

> [!warning] Prior to scanning hosts and services in a cloud, the team should consult the CSP's acceptable use policy.
> In some cases, an organization must enforce a variety of policies. Let’s see how Cloud Custodian can help an organization have a well-managed cloud.

#### Assessing with Cloud Custodian
Cloud custodian is an open-source cloud security, governance, and management tool designed to help the administrator create policies based on resource types. When run, you'll be able to see which resources will leave you vulnerable then enforce policies to automatically correct the vulnerabilities.

Cloud Custodian can help you achieve the following:

- Notify users in real time if mistakes are made.
- Ensure compliance in terms of encryption, access requirements, and backups.
- Shut down during off hours and manage garbage collection.

In addition, you can apply specific actions such as terminating or suspending incidents based on the filters you set.