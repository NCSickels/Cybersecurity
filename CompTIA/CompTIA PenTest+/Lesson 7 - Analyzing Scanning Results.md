## Lesson Introduction
---
During the PenTest, the team will scan a variety of devices, networks, and operating systems. In this lesson, we’ll learn how a thorough analysis of the network is necessary as it will dictate the next step in the process. We’ll discover how Network mapper (Nmap), a predominant method used to scan networks, has a variety of options to detect listening hosts, open ports, and operating systems. We’ll outline the basic capabilities of Nmap, along with how advanced features, such as the Nmap Scripting Engine (NSE), can help refine results and target specific services. Once they have gathered the scanning results, the next step is to evaluate the scans. We’ll then see how the team will use other resources, such as web logs, network traffic, and Domain Name System (DNS) to provide an accurate assessment of the target’s environment.

## Lesson Objectives
---
In this lesson, you will:

- Paraphrase the capabilities of Nmap, including common options such as `sV`, `sT`, `Pn`, `O`, `sU`, and the effect of running that scan, along with scripting options using NSE.
- Demonstrate techniques used to fingerprint the network and hosts to determine the operating systems and software that are in use.
- Examine the output from scans such as Nmap, web logs, and network traffic and produce a report that will help determine the next phase in the PenTest exercise.


## Topic 7A - Discover Nmap and NSE
---
> [!note] Exam Objectives Covered
> *2.3 Given a scenario, analyze the results of a reconnaissance exercise.*
> *2.4 Given a scenario, perform vulnerability scanning.*
> *3.2 Given a scenario, research attack vectors and perform wireless attacks.*

Nmap is the most widely used network scanner today. In addition to being used by network administrators to test the LAN, Nmap is the underlying scanning engine in a number of commercial and open-source vulnerability testing products. In this section, we’ll outline some of the basic features of Nmap along with a review of settings for evading detection. We’ll then finish with advanced scripting options where you’ll realize the power of Nmap as a full featured network discovery tool.

Let’s start with the basics.

### Covering the Basics
---
Nmap enables the network administrator to scan ports and identify services. In addition, you’ll find a wide range of flexible options and expanded capabilities.

You can use Nmap in a variety of ways that include:

- Host and service discovery
- Operating system fingerprinting
- Gathering MAC addresses
- Detecting vulnerable hosts

When the team moves into the active reconnaissance phase, generally one of the first tasks is to scan all hosts on the network in search of interesting targets, such as hosts that are running essential services.

When outlining a plan for testing, the team has many options. Scans can be customized to adhere to timing and performance limitations, use specific TCP or UDP ports, or operate in stealth mode to evade detection. Let’s first talk about timing and performance issues when scanning the network.

#### Timing and Performance Considerations
Vulnerability scanning is part of the PenTest exercise, however, depending on the network, this process can take quite a while. In addition, the scanning process can be aggressive or intrusive, as certain scans generate a lot of traffic and are considered to be "noisy".

Network performance is essential. If the target has a healthy amount of bandwidth, and the client agrees, the team can scan using multiple concurrent scanners, which will speed up the scanning process. However, the team will need to monitor the network as this type of scanning can result in an overburdened network. In addition, aggressive scans can cause congestion and disrupt fragile systems. The team will need to be aware of this and may have to adjust the timing of the scans to run during off hours or use less intrusive scans.

Nmap has a timing option which can be modified to suit your needs. The timing option is **`-T <0 - 5>`** , where **`T0`** is the slowest and **`T5`** is the fastest, as described below:

- **`T0`** and **`T1`** are the best options for IDS evasion but are extremely SLOW.
- **`T2`** slows the scan to conserve bandwidth.
- **`T3`** is the default and is the most stable option.
- **`T4`** is the recommended choice for a fast scan that is still relatively stable.
- **`T5`** is the fastest option but can be unstable and should only be used on a network that can handle the speed.

In some cases, network devices enforce rate limiting, which limits the data flow by either policing or shaping the traffic. Nmap will detect whether rate limiting is in place and will adjust the scan to avoid flooding the network. Keep in mind that rate limiting may result in a much lower scan rate. In that case, the team may want to skip slow hosts by using the option **`--host-timeout`**.

Another option when scanning is whether to use Transmission Control Protocol (TCP) and User Datagram Protocol (UDP). Let’s compare the difference.

#### Using TCP or UDP
When scanning with Nmap, the team will have a variety of options that can be used during scanning. Two options to choose from are Transmission Control Protocol and User Datagram Protocol.

#### Transmission Control Protocol
TCP is a connection-oriented protocol which can provide more detailed results when scanning. Nmap has a variety of scans that use TCP that include:

- A TCP ACK scan is used to bypass firewall rulesets, determine which ports are filtered, and if a firewall is stateful or not. This scan uses the option: **`-sA`**.
- A full (or TCP connect) scan will use a standard TCP three-way handshake. This scan uses the option: **`-sT`**.
- A Christmas tree scan sends a TCP segment with the FIN, PSH, and URG flags raised to bypass a firewall or IDS. This scan uses the option: **`-sX`**

The strength of using TCP when scanning is the connection-oriented nature of the protocol, along with the flexibility of the six flags that can be manipulated and used during the scan.

#### User Datagram Protocol
Scanning using UDP is also an option. When using a UDP scan, the response will indicate the state as follows:

- If the port is open, the target _might_ return a UDP packet which provides proof that the port is open. However, if no response, the port is considered closed or filtered.
- If the port is closed, the target will return an ICMP port unreachable error (type 3, code 3).
- If the target is filtered using a firewall, the target _might_ return an ICMP unreachable error (type 3, codes 1, 2, 9, 10, or 13).

The team can run a UDP scan using the option **`-sU`**. In addition, you can also use version detection **`-sV`** to help differentiate the truly open ports from the filtered ones.

Scanning using UDP is generally slower and more difficult than running a TCP scan. In addition, open and filtered ports rarely send any response. Because of this, the team may choose not to run a UDP scan.

However, it’s important to keep in mind that there are several protocols such as DNS, SNMP, and DHCP that use UDP, and these services can be exploited. As a result, testing UDP ports should be included in the scanning phase of the PenTest.

For either TCP or UDP, the team can define the port(s) to be used during the scan using the following syntax: **`-p <port ranges>`**. For example :
- To scan port 53, you will use the command **`nmap -p 53 192.168.1.1`**.
- **`nmap -p 110,25,443 192.168.1.1`**.

With Nmap, you can run either a basic scan or incorporate scripts for advanced functionality. Let’s explore this concept.

### Scripting with Nmap
---
On its own, Nmap provides an exceptional ability to scan networks. However, using a preconfigured script during the PenTest can greatly enhance the efficiency and effectiveness of the process.

A script is a short program that can be used to automate tasks. ***Nmap Scripting Engine (NSE)*** scripts are a core component of Nmap that allows users to customize activity and automate the scanning process. <mark style="background: #FFF3A3A6;">The team can use NSE scripts to achieve the following:</mark>
- <mark style="background: #FFF3A3A6;">Perform advanced network discovery that can include protocol queries and whois lookups.</mark>
- <mark style="background: #FFF3A3A6;">Detect versions using complex probes then attempt to brute force the service.</mark>
- <mark style="background: #FFF3A3A6;">Determine vulnerabilities by using specially crafted probes then, once detected, attempt to exploit the vulnerability.</mark>
- <mark style="background: #FFF3A3A6;">Uncover the existence of malware such as Trojans and backdoors.</mark>

To use an Nmap script, type the following: **`nmap --script <name of script>`**, as shown in the following example:

**`nmap -–script=dns-random-srcport`**

> [!warning] When writing the command, you don’t have to type the (nse) extension, as nmap will automatically know that you are using a script.

The following script uses the NSE script **`targets-sniffer.nse`**. When using this command, Nmap will sniff the network for 60 seconds using the eth0 interface, list any new targets that it sniffs, and then scan those targets **`nmap -- script=targets-sniffer -- script-args=newtargets,targets-sniffer.timeout=60s,targets-sniffer.iface=eth0`**

The output is shown in the following graphic:
![[Pasted image 20240603143841.png]]
*An Nmap discovery scan*

Nmap comes preconfigured with a full library of scripts. You can find the scripts in Kali Linux by issuing the following command: **`ls -al /usr/share/nmap/scripts/`** . As shown in the screenshot, we see a partial list of the Nmap scripts:
![[Pasted image 20240603143930.png]]
*Partial list of Nmap scripts*

Nmap scripts are written using the LUA programming language. With NSE, you can create or modify your own customized scripts specific to your needs.

> [!warning] Any scripts you write will need to use the (nse) extension so that nmap can use the scripts.

To view a script, you can open in a text editor such as vim. For example, use the following command to view the script **`traceroute-geolocation.nse in vim: vim /usr/share/nmap/scripts/traceroute-geolocation.nse`**, as shown in the screenshot:
![[Pasted image 20240603144023.png]]
*A portion of the `traceroute-geolocation.nse` script in Vim*

<mark style="background: #FFF3A3A6;">Scripts are grouped into several different categories that include:</mark>
- <mark style="background: #FFF3A3A6;">**Malware**—scripts capable of detecting a variety of different types of malware.</mark>
- <mark style="background: #FFF3A3A6;">**Discovery**—scripts that can discover networks, services, and hosts.</mark>
- <mark style="background: #FFF3A3A6;">**Vulnerabilities** – include a variety of vulnerabilities and exploitation commands.</mark>

When using the NSE, you can use more than one script in a command, you will just need to use a comma between each script. Additionally, for a more powerful option, you can use the base script identifier and the wildcard option within double quotes, or run all scripts in a specific category as follows:

- Run all scripts related to File Transfer Protocol (FTP) using the wildcard option on the target: **`nmap -p 21 --script “ftp-*” <ip address>`**.
- Run all scripts in the vulnerabilities (vuln) category on the target: **`nmap -- script=vuln <ip address>`**.

Keep in mind that if you use either option, this will run multiple scans that will most likely take a while. In addition, the scanning can either cause a system crash and/or create excessive network congestion. As a result, you’ll need to evaluate whether running an intrusive scan is appropriate for the environment.

## Topic 7B - Enumerate Network Hosts
---
> [!note] Exam Objectives Covered
> *2.4 Given a scenario, perform vulnerability scanning.*
> *3.2 Given a scenario, research attack vectors and perform wireless attacks.*

Prior to actively launching any attacks, the team will need to map the network to get a better idea of the hosts and services running on the target environment. In this section, we’ll cover ways we can scan the network to identify interesting hosts. We’ll also see how we can gather the make and model of network devices, evidence of listening services, and the operating systems in use.

Let’s start with a review of some options to use during host discovery.

### Detecting Interesting Hosts
---
When evaluating the network for vulnerabilities, it’s important to gather as many details as possible. Some of the activity that takes place during scanning include:

- **Ping Scans,** which will ping a range of IP addresses to learn which machines are responding.
- **TCP Scans,** which will check for open and listening TCP ports to determine what services are in use.
- **OS Footprinting,** which will identify the operating systems in use on the network.

The basic syntax for Nmap is: **`nmap [Scan Type(s)] [Option(s)] <target>`**.

Because every network is unique, the team may need to use a variety of scans to get a solid grasp on the environment. By default, Nmap uses the following during host discovery:

- **TCP SYN** packet to port 443
- **TCP ACK** packet to port 80
- **ICMP type 8** (echo request)
- **ICMP type 13** (timestamp request)
- **ARP** requests to obtain MAC address details

When scanning, the team may need to adjust if they run into problems. For example, if a firewall is blocking the default ICMP pings, the team has other options. For example, they can try the following:

- **TCP ACK Ping** **`-PA <portlist>`** This will set the acknowledgement (ACK) flag in the TCP header.
- **UDP Ping** **`-PU <portlist>`** This scan uses User Datagram Protocol (UDP).
- **SCTP Initiation Ping** **`- sY <portlist>`** This scan uses the Stream Control Transmission Protocol (SCTP) , an alternative to using either a TCP or UDP scan to see if a host is alive.
- **TCP SYN Ping** **`-PS <target>`** This sends an empty TCP packet with the SYN flag set to whatever port(s) you specify. If you don’t indicate a port number, Nmap will try all ports and then display the findings. For example, running the command **`nmap -PS scanme.nmap.org`**, will result in the following:

![[Pasted image 20240603144518.png]]
*TCP SYN Ping*

> [!warning] When using the TCP SYN Ping using multiple ports, there can be no space between -PS and the port list. For example, you’ll need to type the command as follows: PS22-25,80,110.

When scanning, Nmap will display the ports that were detected. Ports can be in one of four states as shown in the following table:

| **Port State** | **Description**                                                                               |
| :------------: | --------------------------------------------------------------------------------------------- |
|      OPEN      | The port is open and responding to probes.                                                    |
|     CLOSED     | The port is not responding to probes.                                                         |
|    FILTERED    | The port is blocked by a firewall.                                                            |
|   UNFILTERED   | The port is *accessible*; however, Nmap is unable to determine if the port is open or closed. |
During the host discovery phase, the team has some options as follows:
- Skip the discovery phase altogether and treat all hosts as if they are online by using the switch **`-Pn`**.
- Complete the network discovery _without_ doing a port scan using the switch **`-sn`**.
- Run a script without either a ping or port scan by using the two options **`-Pn -sn`** together.

> [!warning] Use caution when using -Pn on a network, as Nmap will attempt to scan all hosts, which could equate to hundreds or thousands of hosts.

> [!important] If using the **`ping -A`** command and you receive a 128 TTL packet, the most likely OS of the target is Windows. 
> 

Another key exercise when scanning is to determine the operating system in use on the host. Let’s see why this is a critical step in the PenTest process.

### Fingerprinting the OS
---
Part of evaluating network hosts is to identify vulnerable targets. Nmap can detect the operating system and version in use along with service detection for a single host or a range of devices. Once the vulnerable machine(s) are identified, the vulnerabilities can either be mitigated, or the team can attempt to actively attack the system.

During fingerprinting (or footprinting) the team can use passive or active OS scanning.

#### Passively Gathering Traffic
Passive ***OS fingerprinting*** gathers network traffic using a packet sniffer such as Wireshark, without actively attempting to contact any hosts. Once the traffic is gathered the team can either manually evaluate the ***packet capture (PCAP)*** or import the `pcap` into software used for analysis. Passive fingerprinting is useful for avoiding detection by security appliances, such as a firewall or IDS. However, a passive scan is less accurate.

#### Actively Sending Probes
Active OS fingerprinting actively sends probes to a target and then analyzes the packets that are returned. For example, if we issue the command **`nmap -sV scanme.nmap.org`**, it will result in the following:
![[Pasted image 20240603144955.png]]
*Using the `-sV` option*

Using this command will display open ports and determine the service and version running. As shown in the screenshot, Nmap reports the following:
- The target is running several services, which includes http - version is Apache httpd 2.4.7 ((Ubuntu)).
- The target is using a Linux operating system.

<mark style="background: #FFF3A3A6;">Once a response is received from the target, Nmap will analyze the TCP/IP behavior to make a best effort estimate of what OS is in use. Some of the key elements used to determine the OS include:</mark>

- **Don’t Fragment (DF) bit**—Is the DF bit in the IPv4 header on or off?
- **Window Size (WS)**—What does the OS use as a WS?
- **Time to Live (TTL)**—What is the TTL value set on the outbound packet?

One thing to keep in mind is that Nmap uses the values to make a probable guess as to the target’s operating system. If when scanning the team notices any incorrect results, they can report discrepancies to [https://nmap.org/submit](https://nmap.org/submit).

> [!important] Operating system fingerprinting is typically done using TCP/IP stack fingerprinting techniques that focus on comparing responses to TCP and UDP packets sent to remote hosts. Differences in how operating systems and even operating systems versions respond, what TCP options they support, the order in which they send packets, and a host of other details can often provide a good guess at what OS the remote system is running.
## Topic 7C - Analyze Output from Scans
---
> [!note] Exam Objectives Covered
> *2.3 Given a scenario, analyze the results of a reconnaissance exercise.*
> *3.1 Given a scenario, research attack vectors and perform wireless attacks.*

After completing the reconnaissance phase, the team will need to examine the output from scans. In this section, we’ll see what we can learn from evaluating network traffic. We’ll compare the differences between Nmap, a Command Line Interface (CLI) tool, and Zenmap, a Graphical User Interface (GUI) tool that enables better visualization of the scan results. In addition, we’ll learn how information from DNS and web servers can provide a more comprehensive view of the target network.

Let’s start with discovering what’s involved when evaluating the network.


### Examining Network Traffic
---
Depending on the type of test, the team will need to gather as much information on the target as possible on network services, hosts, and applications traveling across the network. Some of the questions the team will need to find out include:

- Which host(s) are interesting and worth pursuing?
- Where is the target located?
- What devices are on the target network?
- What is it we want when we gain access to a device or host?
- When and how should we attack?

> [!warning] The method of attack will be evident after all targets are identified along with their vulnerabilities.

Prior to beginning the PenTest, the team might have little or no information about the elements of the target network. Depending on the parameters of the project scope, the team might use one of three methods when testing:

- **Unknown environment** testing is when the team is completely in the dark, as no information is presented to the team prior to testing.
- **Partially known environment** testing is when the PenTesting team is given some information, such as internal functionality and code.
- **Known environment** testing is when the PenTesting team is given all details of the network and applications.

Once the team learns more information on the target, they can outline the network topology and identify the boundaries more clearly. Armed with this information, the team can make a more reasonable decision as to the type of probes to be sent and how to bypass security controls. The team will use a variety of tools to gather and record this information, such as using Nmap in the CLI or Zenmap using a GUI.

Let’s take a look at using Nmap results when interfacing in the CLI.

#### Reporting With Nmap
Using Nmap can provide exceptional results when discovering network devices and related vulnerabilities. Nmap has hundreds of standard commands, along with a full library of scripts, which you can combine and consolidate to achieve a variety of results.

For example, running the command **`nmap --script=vuln scanme.nmap.org`** will run all scripts in the category: _vulnerability_ and then display the results as shown in the screenshot:
![[Pasted image 20240603145317.png]]
*Nmap scan to determine vulnerabilities*

When viewing the results of a scan, Nmap has several available formats for outputting the results as follows:

- **Interactive output** is a human readable output that you would normally see on the screen when you run a scan. This is the default output, so no switch is needed.
- **XML output** ( **`-oX`** ) is a format that can easily be analyzed by security automation tools, converted to HTML, imported into a database, or studied using Zenmap.
- **Grepable output** ( **`-oG`** ) creates a grepable friendly file that can be searched using grep, awk, cut, and diff.
- **Normal output** ( **`-oN`** ) is similar to interactive; however, with this format you can save the results of an Nmap scan to a text file for later analysis.

For example, we see the results of `nmap -oN Scanme.txt Scanme.nmap.org`, which outputs the results to a file `Scanme.txt`, as shown in the screenshot:
![[Pasted image 20240603145424.png]]
*Sending output to a text file in Nmap*

Nmap is a CLI tool; however, for a Graphical User Interface option, you can use Zenmap.

#### Interfacing With Zenmap
Zenmap is the companion product to Nmap that can be used on a variety of platforms, including Windows. Using Zenmap is intuitive, and you can run scans within the application just as you would when using Nmap. When scanning a network, Zenmap can create a visual of the network topology, as shown in the screenshot:
![[Pasted image 20240603145453.png | 670]]
*Topology of a network as shown in Zenmap*

The topology map provides an excellent way to assess devices and provide an insight when planning an attack. When moving about the interface, you will discover the results of the scan, as shown in the screenshot, where Zenmap has listed the details of host 10.0.0.75:
![[Pasted image 20240603145538.png]]
*Host details for 10.0.0.75*

In addition to using scan results in evaluating the network, the team will use other resources that will help map your target's network, as we’ll see next.

### Evaluating DNS and Web Logs
---
During a PenTest, the team will use a wide range of methods to gather intel. That includes network scans, data transmitted in plaintext, DNS behavior, and web server transactions. The combined information will help provide a more comprehensive view of the target network.

First let’s see how the team can evaluate DNS for vulnerabilities that can expose sensitive information.

#### Testing DNS
Footprinting using DNS can reveal additional targets that can help the team learn more about the structure of an organization's network. However, in addition to footprinting DNS records, it’s also important to test DNS for vulnerabilities.

DNS can fall victim to several threats that include:

- A flood or amplification attack.
- Cache poisoning.
- Exposure of the zone file.

When testing DNS for vulnerabilities, it’s important to understand the normal behavior.

#### Recognizing Normal Behavior
A normal DNS transaction occurs when a client sends a query to a DNS server for an IP address. The server will respond with the information on hand. However, if the server doesn’t have the IP address, it can ask other servers for the information.

When dealing with DNS there are two servers involved:

- Authoritative nameservers house the records for a namespace and respond to DNS requests.
- Recursive servers hold a copy of the DNS records for the namespace. In addition, if the requested information is not available in the server’s cache, the recursive server can ask other servers for information on behalf of the client.

Either server can be at risk for compromise. Nmap has several methods that you can use to test the DNS structure for vulnerabilities. For example, you can use the following to discover the target host's services:

`nmap --script=dns-service-discovery -p 5353 <target>`

The script uses the DNS Service Discovery protocol to get a list of services. Once the list is obtained, Nmap will follow up by sending probes to get more information.

Next let’s see why it’s important to test to see if the nameserver responds to an unauthorized zone transfer.

#### Transferring Zone Information
A zone file is a text file that contains information and resource records for a specific namespace. The following table is a list of some of the resource records found in a zone file:

| **Type** | **Function**                                                       |
| :------: | ------------------------------------------------------------------ |
|    A     | Maps a hostname to a 32-bit IPv4 address of the host.              |
|   AAAA   | Maps a hostname to a 128-bit IPv6 address of the host.             |
|   PTR    | (Pointer) Most common use is for implementing reverse DNS lookups. |
|    MX    | Mail Exchange Record.                                              |
It’s important to properly configure the servers to ensure the zone information is available _only_ to authorized servers.

> [!warning] A DNS Zone Transfer is sometimes referred to as an Authoritative Transfer (AXFR).

If not properly configured, the zone file can be exposed and leak resource record information. Let’s outline how this works.

On a network, there are host and client DNS nameservers. A zone transfer is when a host DNS nameserver passes a copy of the zone file to a client DNS nameserver.

An attack occurs when an entity poses as a DNS client server and asks for a copy of the zone records.
![[Pasted image 20240603145837.png |670]]
*Requesting a zone transfer*

This can be achieved using the Nmap script `dns-zone-transfer.domain`. If the server honors the request, it will return the zone file. The following is a snippet of the address information that is sent during the course of a normal query:
![[Pasted image 20240603145910.png]]
*Portion of the zone file*

#### Poisoning The Cache
On a network, updating the DNS recursive servers should only be completed by trusted sources. If the server is not properly configured, this can lead to an attack, such as a DNS cache poisoning attack. In this attack, the malicious actor will corrupt the DNS cache of a recursion server to point a victim to a bogus IP address.

To see if the server is vulnerable to this type of attack, the team will need to first check and see if the server uses recursion. As shown in the screenshot, the script `dns-recursion` is run and has reported that recursion is enabled:
![[Pasted image 20240603145936.png]]
*Script to check for recursion*

<mark style="background: #FFF3A3A6;">After determining that the server uses recursion, the team can attempt to perform a dynamic DNS update without authentication. This can be achieved using the following script:</mark>

`nmap -sU -p 53 --script=dns-update --script-args=dns-update.hostname=target.example.com,dns-update.ip=192.0.2.1 <target>`
`
In addition to testing the DNS servers for vulnerabilities, the team may also be charged with testing the web servers as well.

### Exposing Vulnerable Web Servers
---
During the PenTesting exercise, the team can test the organization's web server using a few methods:

- Manually examine the source code and elements within the site for comments or other interesting artifacts.
- Examine the web or access logs that show the activity for a website.
- Intercept traffic using a proxy between the web client and the server.

All methods are useful; however, when using a proxy, the team can gather more data to check for security issues that occur during a web transaction. Vulnerabilities can include cryptographic weaknesses, missing or weak authentication, and other web vulnerabilities.

One tool that can be used to test web applications is Burp Suite, which is an integrated platform used to test the security of web applications.

> [!warning] The Community Edition is one of the tools prebuilt into Kali Linux.

Acting as a local proxy, Burp Suite can intercept and capture the HTTP requests and responses so the team can analyze the traffic. When discovered, Burp Suite will list the vulnerabilities. Below the activity monitor, you can view the details of the vulnerability, as shown in the screenshot:
![[Pasted image 20240603150049.png]]
*Burp Suite interface*

In addition, you can view other details as well. For example, as shown in the screenshot, the Request tab shows the OS command injection code:
![[Pasted image 20240603150130.png]]
*OS command injection*

The Burp Suite Community Edition provides limited functionality; however, it will provide a great deal of resources for identifying web server vulnerabilities.
