## Lesson Introduction
---
Once the team has completed a footprinting exercise, the next phase is to devise a strategy to assess the network for vulnerabilities. The team will need to plan the vulnerability scan, along with identifying key goals in assuring the organization has a solid security posture. The team will want to outline the types of scans to be run, along with any constraints that will impact testing. In addition, they will need to detect defenses that will influence the effectiveness of the scan. During this process, the team will utilize scanning tools such as Censys, an attack surface analyzer, along with tools such as Hping and Open Vulnerability Assessment Scanner (Open VAS).

## Lesson Objectives
---
In this lesson, you will:

- Understand how reducing vulnerabilities will decrease overall organizational risk and compile a vulnerability scan strategy in-line with organizational in-scope requirements.
- Realize potential network defenses that may impact the effectiveness of the vulnerability scan.
- Examine the many vulnerability scanning tools available such as Nikto and SQLmap along with Censys, an attack surface analyzer.

## Topic 5A - Plan the Vulnerability Scan
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *2.4 Given a scenario, perform vulnerability scanning.*
> *3.2 Given a scenario, research attack vectors and perform wireless attacks.*
> *3.7 Given a scenario, perform post-exploitation techniques.*

After the team has gathered essential information related to the organization, they are better prepared to begin assessing the network. In this section, we’ll take a look at the importance of identifying vulnerabilities, step through the lifecycle of a vulnerability, and see how a zero-day attack can be especially dangerous. We’ll then review the types of scans the team can run when performing active reconnaissance and cover the importance of identifying network defenses that might interfere with the scan. Finally, we’ll review the choices the team has in scanning tools available and ways to analyze the attack surface, craft packets, and assess web vulnerabilities.

Let’s start with the importance of identifying and mitigating vulnerabilities.

<font style="color: red">Video Transcript: Performing Vulnerability Scanning</font>

| **Time-codes** | **Dialogue**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 01:00:00:10    | TITLE SEQUENCE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 01:00:09:23    | **James Stanger**<br><br>Welcome, everybody. I'm here with Lee McWhorter to talk about performing vulnerability scanning. Kinda the ins and the outs, some of the things to look for. Lee, tell us a bit about yourself and let's start talking about vulnerability scanning.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 01:00:22:19    | **Lee McWhorter**<br><br>Alright, thanks for having me, James. I'm Lee McWhorter. I'm the CTO of Covered 6, proud owner of all of CompTIA certs and I had the distinct pleasure of teaching the first PenTest+ [trainer] and I get to do the next one for the new exam as well, next year. I've been doing this for about 30 years and look forward to talking to you about this today.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 01:00:42:13    | **James Stanger**<br><br>You know, when it comes to vulnerability scanning, I mean, there's so many things to think about but one of them is, as you gather information, how can you do so in the best possible way, in terms of the time, running the scans? What about fragile systems, things like that?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 01:00:58:04    | **Lee McWhorter**<br><br>Yeah, vulnerability assessment really takes it up a notch. You know, once you do, you start with your passive, you're not even touching the target. You start getting into active scanning, you start to touch the target, leave some trails. When you go into a full vulnerability test, even with just something as the scripting engine of Nmap, let alone open VOS or [SPECIALIST TERMINOLOGY], you are really pounding on that target and so you have to weigh a lot of different considerations. If it's something that, you know, you're not wanting to get caught because you're trying to simulate being an outside adversary in this pen test, then you've gotta maybe slow it down, so you don't trigger any flags or get blocked by intruder detection. You may have to slow it down even if it's totally a known environment test and you know everything, and everybody knows it's coming but that's an older system that you don't wanna risk impacting. So, all of those come into play. You know, you wanna try to get things as quick as you can done, you know, to try to move on with that report and move on with the pen test, but at the same token, you have to consider the type of pen test you're doing and the type of systems you're targeting.                                                                                                                                                                                                                                                                                                                                                                |
| 01:01:58:03    | **James Stanger**<br><br>Makes sense. So, you basically, do kinda query throttling and tell me about some of the fragile systems that you've had to consider, 'cause I've crashed a few doing a few scans, you know, completely unwittingly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 01:02:09:28    | **Lee McWhorter**<br><br>Well, yeah, you know, all of the systems like, you know, Nmap has its throttle functionality, so you can change the speed from insane to paranoid.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 01:02:18:12    | **James Stanger**<br><br>But that's the -T, right, one through five?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 01:02:20:22    | **Lee McWhorter**<br><br>Exactly, the big cap T, and so, if you're, you know, paranoid about getting caught then you slow it down. If you wanna just pound away insane speeds and get it done, obviously set off lags along the way, you can do that. And the other types of vulnerability software have speed settings or even the ability, like a lot of the higher end attackers will spread their stuff out across their botnet, for example, so they're only doing a little bit from each place and it's really hard to pin down that pattern and stop them. But yeah, you have to be careful of older systems, legacy systems. A lotta times, like, I've run into older database systems that, you know, you don't think, it's just a server, it's just a database but all of a sudden, woom, then that vulnerability just starts pounding that machine and it can't keep up with the number of connections, and you can basically end up running a denial-of-service attack by accident against your client's target.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 01:03:11:10    | **James Stanger**<br><br>You know, when it comes to scanning methods, there's things like, you can conduct stealth scans and take advantage of TCP, kind of the connections, the three-way handshake, etc. Let's talk about that a little bit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 01:03:25:02    | **Lee McWhorter**<br><br>Well, Nmap itself, and there are other ways to do it, but Nmap are a really important tool for pen testing of course, has its sense scan mode where it'll start the initial TCP connection by sending the synthbut then when it gets to the acknowledgment, it will cut off the connection. So, the idea there - and in most cases it does work - it will prevent that transaction from completing and from there being a log potentially left in. Not always guaranteed. Depends on the service and the port in question and how that, whether you're scanning a web server, an FTP server or whether they're gonna log that incomplete transaction or not. But the idea is that it can sometimes help you, you know, sort of slip under a radar a little bit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 01:04:09:12    | **James Stanger**<br><br>You know, when it comes to running certain scans, are there better times than others? How do you determine that for an organization as you're doing a pen test?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 01:04:16:10    | **Lee McWhorter**<br><br>Well, you know, the first stage of any pen test is scoping and planning and so in a scoping and planning phase, you're going to have worked with that client to determine when the best time is. You know, are gonna build a come and go as we please? It's totally wide open, we're acting like a hacker, so we don't care. Are we being nicer to the business? We're only gonna do it over hours or on the weekends or whatever. So, a lotta that impacts it and it can impact even the speed we were talking about before because if you are being able, already limited to doing it at night, then you may have to run faster in your short period to try to get things done, but there's always that fine line of running too fast and maybe knocking a system off-line.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 01:04:53:23    | **James Stanger**<br><br>You know, during the pen test, you've gotten the topology in one way or other, whether it be the old school ping scan or whatever. You're going into the different systems, what are some of the settings that you can do besides time, to avoid detection? There are spoofing settings and things that I've used, for example.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 01:05:10:25    | **Lee McWhorter**<br><br>Well, yeah, Nmap has a number of evasion things. You can also, you know, potentially use some of your own ability to obfuscate, route things through different proxies, through different VMs. And of course, you wanna limit because, you know, if you've already done your homework with the passive and the actual reconnaissance scans, you already have some idea. You're not probably, at this point in a pen test, running just a blanket vulnerability test anymore. You're trying to just hit and verify that that, I saw there was an FTP server, Nmap seems to think it's vulnerable. Is it really, so I can go and attack it? And so, you wouldn't necessarily be hitting that machine on ever port. So sometimes, just limiting by port and servers can really cut down the amount of load and the time it takes to run that scan.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 01:05:58:08    | **James Stanger**<br><br>Makes a lotta sense. You know, one of the things that I've also used, for example with Nmap, is the script = vulnerability option for the NSE. Basically, as you do a scan, it will go out to the CVE database and then start doing mapping together. I find that particularly powerful. Have you used that much before?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 01:06:18:11    | **Lee McWhorter**<br><br>Yes, I do, and I use it either in one of two ways. Specifically, once again, trying to validate a particular thing; maybe I've already found in some other way. Many times, I teach students, you need to run sometimes more than one scan or more than one tool, 'cause we do get false positives, right. Just because it says it's there doesn't mean I can actually use it and before I take the time to try to exploit it, I may wanna verify that it's really there. And so those types of situations, and then there's also, you know, Nmap has the, what I like to call the anything and everything flag, the -A and it runs basically those top scans as part of. And so, if I don't have a narrower target and you know, I'm not just going after one port, one particular vulnerability, then I may use the cap A to just say, scan this target, find everything I can about this target. Let's see if we can find anything vulnerable there.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 01:07:09:12    | **James Stanger**<br><br>There's a lot been said about automation in pen testing. Let's talk about that for a second. I mean, I always think in terms of, automation using, you know, a scripting language like Python or something like that, or a language like Python. Tell us a bit more about automation and pen testing at this level of vulnerability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 01:07:24:27    | **Lee McWhorter**<br><br>Well, you know, you can do a number of different things. You can write your own scripts and craft your own packets if that's something you do, possibly tying back into that evasion or trying to make it look different to get past some kind of intrusion detection or something. One of the things, we had this really, and it was actually not from our materials, some other student in the PenTest+ class way back there, three years ago, shared this one scenario of, basically in a nutshell to keep it short in our time, but you have all these big subnets you need to scan and you're gonna use Nmap. How would you do it in the most efficient way? And it led to, and it's really more of a thought exercise and I ended up coming with three or four different possible answers. One of them was, you know, just kinda your standard, use these flags, these settings, this is a pretty long command. But then I said, "let's start getting creative. Let's sort of think outside the box." [UNSURE OF WORD] maybe a little bit and so maybe the idea was you could break it up, so you could have one Nmap scanning a first set and exporting that to a file and then have another instance picking up those results and going further. And now you've been able to spread this load across a couple of systems of VMs and you're letting the one results drive the next step. And that's kind of a cool way to kinda automated speed up and cover that ground because at the end of the day, you could start with a ping sweep to find everything and then go deeper and then the next phase could feed that even deeper. |
| 01:08:46:28    | **James Stanger**<br><br>I've seen this somewhere before using Ansible and also using datalike. You set up the results of those scans and then you can do some scanning, I should say, some data analysis as it were, using some AI and things like that, I've seen. And then that helps you take the next step and that's been an interesting way that you could use automation to do some different pivoting and things that your victim, as it were, the person you're testing wouldn't expect.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 01:09:13:26    | **Lee McWhorter**<br><br>Well, and based on what I saw at Black Hat and DEF CON last week, we're gonna see more of that, James. There was a lotta AI, a lotta people who are applying AI to different stages of this. I've even talked to one vendor that had a whole pen test suite of tools that they're trying to make it so even more junior people can have a lot of this automated form and take steps based on what's found in a previous step.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 01:09:35:09    | **James Stanger**<br><br>'Cause the automation basically moves your skills as a pen tester up a stack as it were. I don't mean no OSIRN necessarily but up value chain, let's call it that.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 01:09:43:27    | **Lee McWhorter**<br><br>I mean, it adds value. Ideally at this stage, most of what AI, in the best case we can hope for, is that it's gonna all make us better. It's gonna make our jobs easier and we're gonna definitely see more of that coming in this space.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 01:09:54:04    | **James Stanger**<br><br>Yeah, 'cause the last thing the world needs are script kiddie pen testers. It's not what we're all about at that professional level, so I figure you're gonna see a lot more of that kind of automation coming in using those types of tools.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 01:10:05:02    | **Lee McWhorter**<br><br>I agree.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 01:10:06:07    | **James Stanger**<br><br>Lee, thanks so much for your time and your wisdom, talking about vulnerability scanning and some of the moves that you can make.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 01:10:12:21    | **Lee McWhorter**<br><br>Thank you for having me, James. Always good talking to you.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 01:10:14:10    | **James Stanger**<br><br>Always good talking to you.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 01:10:15:16    | End of Programme                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

### Understanding Vulnerabilities
---
Penetration testing is a proactive exercise that tests the strength of an organization’s security defenses. A key part of this process is identifying vulnerabilities or weaknesses that can be triggered accidentally or exploited intentionally and cause a security breach.

In this section, we’ll review the lifecycle of a vulnerability and the potential risks to data if anyone or anything is able to exploit the vulnerability. We’ll then cover how the team prepares for active reconnaissance in identifying hosts, ports, and services, and detail choices that are involved when performing vulnerability scans.

Let’s begin by outlining the lifecycle of a vulnerability.

### Moving Through The Life of a Vulnerability
---
Vulnerabilities exist in many different areas, called ***attack surfaces***, which includes software, hardware, networks, and users that can be exploited. Malicious actors are constantly seeking ways they can find and leverage vulnerabilities in order to attack their targets.

The **lifecycle of a vulnerability** is a process that moves from initial discovery through awareness and documentation, as shown in the graphic:
![[Pasted image 20240104143954.png]]
*Lifecycle of a vulnerability*

The lifecycle generally involves the following:

1. **Discover** is the first phase of finding a potential vulnerability that can be exploited. It's important to recognize that a vulnerability exists in order to defend against a possible attack, now or in the future.
2. **Coordinate** is the next phase, where both the vulnerability and the potential to exploit the vulnerability are known. During this phase, the vulnerability is defined, listed, and published in the CVE and CWE so that vendors and anyone involved is aware of the vulnerability.
3. **Mitigate** is when vendors and software designers take a look at the vulnerability and devise a strategy to deal with the vulnerability. In most cases a patch is developed and then released to the public.
4. **Manage** is when the patch has been released. It’s now up to each individual organization to take the next step and apply the patch in order to remediate or mitigate the vulnerability.
5. **Document** is the final phase, in that the vulnerability has been tested, and everyone involved will take a moment to document what has been done. In addition, it’s best to reflect on lessons learned, in order to prevent further exposure.

> [!warning] Just because a vulnerability exists doesn't mean that a malicious actor will try to exploit the vulnerability. However, it’s important to be aware it exists, as someone can later use the vulnerability in an active attack.

As outlined, identifying vulnerabilities is the first step in reducing overall risk. One type of threat is a zero-day attack, which takes advantage of a software vulnerability that is unknown or undisclosed by the software vendor. Let’s see how this works.

#### Exploiting the Unknown
Malicious actors seek ways to gain access to systems by discovering unknown or unpublished vulnerabilities. As shown in the graphic, we see a timeline of a zero-day vulnerability that can progress into an attack:
![[Pasted image 20240104144101.png]]
*A zero-day vulnerability*

The process is as follows:

1. The vulnerability is found in the wild, possibly by a malicious actor that specifically seeks out vulnerabilities with the goal of trying to exploit them.
2. At some point, the vulnerability, and the potential for exploitation are now known by the vendor and is defined, listed, and published so that anyone involved is aware of the vulnerability.
3. After identification, the vendor will mitigate or remediate the vulnerability by creating a patch.

As shown, until the patch is applied, the system is vulnerable and creates a ***risk gap***, which is the time between when the vendor releases a patch, and the patch is applied. During this gap, the malicious actor can exploit the zero-day vulnerability, which can lead to devastating results.

Today organizations use a variety of methods to reduce vulnerabilities and protect our assets. Not mitigating vulnerabilities can have serious risks to data, as outlined next.

#### Reducing Risks to Data
Some of the key considerations in performing a PenTest is the goal of protecting an organizations’ data. An attack can have serious repercussions. If someone is able to gain unauthorized access to the data, either by accident or by exploiting a vulnerability, this can result in the following:

- **Exposing sensitive data** occurs when someone or something exposes sensitive or personal data, which is a violation of confidentiality.
- **Data modification** or corruption is when data has been altered in some way, which is a violation of integrity.

An organization must take steps to properly protect the data. For example, if the data on a server is not encrypted, this can leave the data vulnerable and lead to exposure. A malicious actor might be able to gain access to the server and read the unencrypted files.

In order to decrease overall organizational risk, it’s essential to identify and reduce vulnerabilities in each attack surface. In the next section, we’ll see how one way the PenTest team can identify vulnerabilities is by actively conducting a reconnaissance exercise.

### Performing Active Reconnaissance
---
Part of a comprehensive PenTest is actively seeking out vulnerabilities. During this phase, the team will gather information by grabbing banners, mapping the network, and running scans to identify vulnerabilities.

One of the easiest things the team can do to enumerate network information is to perform banner grabbing. Let’s explore this concept.

#### Grabbing Banners
Banner Grabbing is a technique used during reconnaissance to gather information about network hosts and the services running on open ports. The process involves attempting to open a session with a service and getting the service to identify itself.

You can use Wget, Netcat, and other tools to grab banners from services and protocols such as FTP, SSH, HTTP, SMTP, POP3, DNS, Telnet, Microsoft netbios-ssn, and more. Acquiring these banners can help you focus your attacks on specific services.

The following are some examples of banner grabbing:

***Wget*** can be used to grab a banner using the following syntax: **`wget <target IP> -S`**. When using this command, **`-S`** will print the HTTP headers that are sent by the server.

Another option is ***netcat (nc)***, a popular tool for Unix and Linux. The following screenshot shows using an HTTP GET request to elicit the web server type and version: **`echo -en "GET / HTTP/1.0\n\n\n"|nc www.comptia.org 80|grep Server`**

As shown in the graphic, the server is listed as Microsoft-IIS/8.5:
![[Pasted image 20240109142911.png]]
*Banner grabbing with Netcat*

When using certain commands to grab banners, the service will either respond with information about itself, or wait for more input from you. Depending on the tool and the protocol, you may need to send specific input that that the service will know how to respond. In addition, you may also need to break out of the connection by pressing **Ctrl+C** or **Enter** a few times.

Another tool to grab banners is ***Nmap***. Use the following to get some basic information about a target IP: **`nmap -sV <target IP> -p <port number>`**

> [!warning] When using nmap, you don't need to break out of the session, simply wait a few seconds for the scan to complete.

In addition to basic commands, you can also use an Nmap _Scripting_ Engine (NSE) script, which will attempt to grab banners from every service it can discover on a host. An example is shown in the screenshot using the following script: **`nmap -sV --script=banner <target>`**:
![[Pasted image 20240109143105.png]]
*Nmap NSE banner script example*

You can also grab a banner by using curl, which is an open-source command line protocol used to transfer data. An example using the command curl -I example.com to retrieve the banner is shown in the following screenshot:
![[Pasted image 20240109143132.png]]
*Grabbing a banner using curl*

As outlined, there are many ways to grab banners to learn basic information about a host. In addition to banner grabbing, the team will want to map the network in order to discover devices, visualize the network and create a logical network *topology* map. Let’s see how this is achieved.

> [!important] Service identification is usually done in one of two ways: either by connecting and grabbing the *banner* or connection information provided by the service or by comparing its responses to the signatures of known services.
#### Mapping the Network
Network mapping is an essential first step in the active reconnaissance phase of the PenTest. This process uses active probing to gather essential information related to the network. Information includes:

- MAC and IP addresses, ports, services, and operating systems
- Device types, virtual machines, and host names
- **Protocols** running on the network
- Subnets and how the devices are interconnected.

The team can scan using a tool such as Nmap to create a network map. However, there are other methods to map the network, which include:

- Interrogating ARP caches, routing, and MAC tables
- Using ***Cisco Discovery Protocol (CDP)*** neighbor tables
- Sniffing traffic using tools such as ***tcpdump***, ***Wireshark*** or ***tshark***

Many mapping tools have additional functionality. They use ***Windows Management Instrumentation (WMI)*** or ***Simple Network Monitoring Protocol (SNMP)*** to enumerate information from hosts. The tools can gather information such as:

- Hardware and service status
- Interface statistics
- Installed applications and patch levels
- Usernames and groups

Having a topology map of the network is valuable to the PenTest team, as it will define your choice of tools and strategies when moving to the attack phase. For example, you cannot conduct an ARP scan or spoof a MAC address on a remote network without direct access to that network.

<mark style="background: #FFF3A3A6;">Most network mappers only scan the immediate subnet by default.</mark> You may have to manually add additional subnets. Many tools allow you to specify a "seed device" such as a router or multilayer switch that can provide knowledge of the various subnets. You typically have to provide a username and password for the scanner to log into the device to make such queries.

There are many free and commercial network mapping tools. In addition, most of the paid versions provide free trials. Some mappers interface with drawing applications such as Microsoft Visio to create professional-looking diagrams. Popular network mappers include ***SolarWinds***, ***Intermapper***, ***WhatsUp Gold***, ***PRTG***, ***Spiceworks***, ***Nmap***, and ***Zenmap***.

The tool will actively probe each device and report back what it has found during the process. As shown, when using a GUI, you can select the device, and the software will display the node details, along with interface and **Virtual Local Area Networks (VLAN)** data.

In addition to mapping, the team will need to scan the network for vulnerabilities. Let’s see what’s involved next.

### Running Scans
---
Scanning the network for vulnerabilities is another important task when conducting active reconnaissance. Scanning probes potential targets on the network in order to identify some of the following issues:

- Weak encryption and authentication protocols
- Improperly configured networks, hosts and devices
- System vulnerabilities and security flaws
- Lack of compliance with data privacy regulations

After scanning is complete, the team will be able to identify potential targets to exploit during the attack phase of the PenTest.

Today, there are many choices when selecting a scanner. Scanners can be more generalized or focus on specific targets such as Linux and SQL servers, web applications, or network devices.

Some tools allow you to select the target type; others can use the output from a port scan to focus their efforts. For example, the following command will use nmap to discover web servers on the network and then pipe the output to Nikto to run a vulnerability scan:
```bash
nmap -p80,443 10.0.1.0/24 -oG - | nikto.pl -h –
```

The following are some commonly used general purpose vulnerability scanners:

- <mark style="background: #FFF3A3A6;">Open Vulnerability Assessment Scanner (OpenVAS)</mark> is an open-source scanner
- <mark style="background: #FFF3A3A6;">Nexpose Community Edition</mark> helps identify, prioritize, and manage organizational risk
- <mark style="background: #FFF3A3A6;"> Retina Community</mark> is a free scanner for small networks
- <mark style="background: #FFF3A3A6;">Nessus/Tenable</mark> is a comprehensive commercial scanner
- <mark style="background: #FFF3A3A6;">Nmap</mark> is a powerful security scanner, which can be used alone or by using NSE scripts

While scanning for vulnerabilities is an essential step to take during the PenTest process, the team will need to limit impact of vulnerability scans on production systems.

Some common ports to know are:

|    **Port**     | **TCP/UDP** | **Service**              |
| :-------------: | ----------- | ------------------------ |
|       20        | TCP, UDP    | FTP Data                 |
|       21        | TCP, UDP    | FTP Control              |
|       22        | TCP, UDP    | SSH                      |
|       23        | TCP, UDP    | Telnet                   |
|       25        | TCP, UDP    | SMTP (email)             |
|       53        | UDP         | DNS                      |
|       67        | TCP, UDP    | DHCP Server              |
|       68        | TCP, UDP    | DHCP Client              |
|       69        | TCP, UDP    | TFTP                     |
| 80 (8080, 8008) | TCP, UDP    | HTTP                     |
|       88        | TCP, UDP    | Kerberos                 |
|       110       | TCP, UDP    | POP3                     |
|       123       | TCP, UDP    | NTP                      |
|       135       | TCP, UDP    | Microsoft EPMAP          |
|     136-139     | TCP, UDP    | NetBIOS                  |
|       143       | TCP         | IMAP                     |
|       161       | UDP         | SNMP                     |
|       162       | TCP, UDP    | SNMP traps               |
|       389       | TCP, UDP    | LDAP                     |
|       443       | TCP, UDP    | HTTPS                    |
|       445       | TCP         | Microsoft AD and SMB     |
|       500       | TCP, UDP    | ISAKMP, IKE              |
|       515       | TCP         | LPD print services       |
|      1433       | TCP         | Microsoft SQL Server     |
|      1434       | TCP, UDP    | Microsoft SQL Monitor    |
|      1521       | TCP         | Oracle database listener |
|   1812, 1813    | TCP, UDP    | RADIUS                   |
|      3389       | TCP         | RDP                      |
> [!important] By default, Nmap will scan the 1,000 most common TCP and UDP ports if it is not used with a command flag that provides it with a range of ports.

#### Scanning Considerations
During the planning phase of the PenTest, the organization will define some of the parameters of the PenTest in the project scope, that includes the following considerations:

- **Time to run scans**—Some vulnerability scans take a great deal of time to run, such as web app scans, which can take days. You may need to configure the run of the scan at a more superficial level. You can also set the scan to stop scanning after a certain amount of time or when you get a satisfactory number of results.
- **Bandwidth limitations**—Intensive scans can consume a significant amount of bandwidth, especially if several concurrent scans are running against multiple hosts. This can delay the scans or disrupt them entirely.
- **Fragile systems**—Some systems, such as a legacy server or nontraditional assets such as Internet of Things (IoT) devices, may not be able to withstand an intensive scan. In addition, in most cases the team should use caution when scanning printers, as the scan may cause a printer to print out random data and waste a great deal of paper.
- **Query throttling**—The number of queries launched by the scanner in order to overcome bandwidth limitations can be throttled. In addition, it can help avoid issues with fragile systems and other non-traditional assets that have weak or outdated hardware or are inherently unstable.

The less overhead the target needs to deal with, the less likely it will experience delays, become unresponsive, or crash entirely.

One of the things that should be considered with vulnerability scanners is the potential impact on the devices they are scanning. If the scan runs during working hours, there is the possibility of creating disruption. Ideally, the scan should be performed in the background with minimal degradation to network traffic and no impact to end-users.

> [!Important] Scanning can be either intrusive or nonintrusive. A nonintrusive scan is passive and only reports identified vulnerabilities; however, an intrusive scan can identify and then exploit vulnerabilities. When using an intrusive scan, the team should use caution, as this type of scanning can cause damage to the system.

Testing can include the following types of scans:

- **Web application scans**—scans web servers and applications for vulnerabilities such as cross-site scripting and SQL injection.
- **Network scans**—evaluate computers and devices on your network for open ports, misconfigurations, weak or missing credentials and unpatched systems
- **Application scans**—specifically target known vulnerabilities on applications
- **Compliance scans**—assess whether or not systems have appropriate security hardening

<mark style="background: #FFB8EBA6;">Another major consideration is to validate vulnerabilities that you do find. Many vulnerability scans produce false positives, or report vulnerabilities that can't actually be exploited. The most common way to validate is to attempt to actually exploit the vulnerabilities and produce evidence of success.</mark> Tools such as Metasploit can import the results of a vulnerability scan and then attempt the exploit on the system.

The team should also keep in mind the limits of various scanning tools. For example, tools such as Metasploit have limited scanning capabilities, as this is not Metasploit's primary focus. That is why you should use an actual scanning tool such as OpenVAS or Nexpose to _conduct_ the scan, and then have Metasploit _validate_ the results. In addition, some tools can be out-of-date and therefore cannot produce accurate results. Because of this, the team should not rely on any single tool for a comprehensive scan.

## Topic 5B - Detect Defenses
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*

During active reconnaissance, the team gathers information about the target in order to better prepare for the next phase in the PenTest process. When scanning a network, it’s not uncommon to encounter a device or application that will either interfere with a scan or detect scanning activity. Throughout this phase, the team will want to identify potential network defenses. In this section, we’ll evaluate how the team can identify load balancers, scan firewalls, and avoid antivirus.

Let’s start with understanding how load balancers are used on a network.

### Identifying Load Balancers
---
On a network, a load balancer is used to stabilize network traffic across two or more servers. As shown in the graphic, balancing the load prevents any one server from getting too many requests:

![[Pasted image 20240109145644.png|500]]
*Load balancing on a network*

Load balancing helps ensure network hosts receive a response to a request in a timely manner, which in turn will improve network and application performance. However, during scanning, it’s important for the team to identify any devices such as load balancers that can misdirect probes or attacks.

The team can detect the presence of a load balancer by using the **`load balancing detector (lbd)`** app in Kali Linux, as shown in the screenshot:
![[Pasted image 20240109145920.png]]
*Checking for load balancing at CompTIA.org*

In addition to load balancers, there are other devices that can cause false results on security scans, such as reverse proxies, intrusion prevention/detection systems, and firewalls.

Firewalls are used on most networks today to block unauthorized packets from reaching listening services. While a firewall might have vulnerabilities, most scans are conducted to identify which type of traffic the firewall will allow and test the effectiveness of its rules. Let’s investigate this next.

### Recognizing Firewalls
---
Firewalls are widely used to monitor and control traffic on a network and use rule sets to determine if traffic is allowed or denied. Most rules are based on the following parameters:

- Destination or source port and IP address
- Protocol type and payload

Single hosts commonly use software-based personal firewalls (such as Windows firewall) to protect the host from unwanted connections. However, for mission critical systems, many network administrators use a dedicated appliance to control traffic flowing between the trusted and untrusted network.

One example of a dedicated firewall is a web application firewall (WAF). A WAF is specifically designed to monitor web applications and guard against common attacks such as cross-site scripting (XSS) and SQL Injection (SQLi) attacks.

A few examples of how the team can identify a WAF include the following:

- A WAF can give away their existence by adding a personal cookie in the HTTP packets.
- Some WAF products (such as Citrix NetScaler) use a technique called Header alternation, which changes the original response header to confuse the attacker.
- Other WAF will identify themselves by their response, for example you might see the following:
**`<title> myDefender bocked your request</title>`**.

During the PenTest, the team will test firewalls to see if specially crafted packets are able to slip past the firewall. The packets might be able to pass through the firewall for either of the following reasons:

- The packet matches a permit rule.
- The packet doesn't match a deny rule.

<mark style="background: #FFB8EBA6;">Another reason a specially crafted packet is able to slip through is because not all firewalls are capable of payload inspection.</mark> As a result, you might be able to push malicious code through a firewall over a permitted port. For example, if TCP port 80 is allowed, you could hide a payload in an HTTP header, or simply set the destination port of any malicious TCP packet to port 80. If the firewall is only inspecting the ports and not the payload, it will permit the packet.

In some cases, the packets may have slipped through because the ***Access Control List (ACL)*** was not configured correctly.

Whatever the reason, if potentially malicious packets are able to pass through the firewall, the team should include the results on their report along with remediation suggestions.

When scanning a firewall for vulnerabilities the team can use a couple of basic approaches.

- Port-scan the public address of the host or firewall to see which ports are open or are listening.
- Attempt to discover the details of the internal network by using firewalking.

***Firewalking*** is a technique that uses a combination of traceroute and port scanning to discover the details of the internal network. The Firewalk tool, which is available on Kali Linux, creates specially crafted packets to see what traffic can pass through a device; as shown in the graphic:
![[Pasted image 20240109150755.png]]
*Firewalking*

In addition to Firewalking, the team can attempt to access a blocked port by using applications such as Datapipe to redirect the traffic to another port.

Because scanning can be time-consuming, the team can use automated tools to streamline the workflow. In addition to custom nmap scripts, there are several automated tools for WAF detection available on GitHub such as ***Wafw00f*** and ***WAFNinja***.

While it’s important to identify network devices, the team should also assess the presence of antivirus and antimalware protection in use on the network.

### Avoiding Antivirus
---
Today organizations and individuals employ antivirus/antimalware protection to continuously monitor systems and networks for malware.

During the PenTest, the team may need to assess whether or not they are able to create an exploit that can bypass the antivirus protection.

In general, there are a few methods to avoid AV detection:

- Create a metamorphic virus, which transforms as they propagate and makes pattern detection nearly impossible.
- Obfuscate a known signature using a tool such as ***ObfuscatedEmpire***, which is a fork of Empire that has Invoke-Obfuscation baked directly into its functionality.
- Use specialized tools or payloads such as fileless malware that use OS embedded functions that are difficult if not impossible to detect.

One way to achieve this is by using the Social Engineering Toolkit (SET) in Kali Linux. Using SET along with Metasploit, the team can create a malicious payload, such as a _virus_, worm, or Trojan, and embed the payload in a PDF.

Once complete, the team can run a test to see if the payload is detected when introduced on the network.

As we can see, while an organization may have numerous safeguards in place, the only way to be sure they are effective is by actively testing the defenses.

## Topic 5C - Utilize Scanning Tools
---
> [!note] Exam Objectives Covered
> *2.2 Given a scenario, perform active reconnaissance.*
> *5.3 Explain use cases of the following tools during the phases of a penetration test.*

When actively scanning the network for vulnerabilities, the team will want to outline the types of scans to be run, along with any constraints that will impact testing. To achieve a wide range of scans and get an accurate picture of the network, the team will use different tools and techniques. In this section, we’ll take a look at tools used to evaluate the attack surface, craft, and customize packets along with tools specific to evaluate web servers and databases.

Let’s start with identifying the attack surfaces.

### Analyzing the Attack Surface
---
During the footprinting and reconnaissance phase, the team will have used a variety of OSINT tools and security search engines such as Shodan to gather information. In addition, the team might also utilize tools specific to the types of targets on the network, such as web-based tools that can scan remote targets for hosts, services, and other details.

When testing for vulnerabilities, one tool the team can use is ***Censys***, an attack surface analyzer, similar to ***Shodan***, to identify exposed systems. For example, entering [https://search.censys.io/search?resource=hosts&amp;q=comptia.org](https://search.censys.io/search?resource=hosts&amp;q=comptia.org) in the URL will result in the following:
![[Pasted image 20240109165345.png]]
*Scan of CompTIA.org using Censys (Screenshot courtesy of Censys https://search.censys.io/)*

Once you have run the scan, you can select different elements to examine more details, such as services running, ports in use, along with any software vendors that were recognized.

In addition, the team can run a scan using the Open Vulnerability Assessment Scanner. When run, OpenVAS will list the vulnerabilities along with a risk rating that summarizes the overall state of the site that was tested. Below the summary, you will see details that include the Common Vulnerability Scoring System (CVSS) value and the Common Vulnerabilities and Exposures (CVE) number.

As shown in the screenshot, we see the details of an OpenVAS scan of Scanme.nmap.org:
![[Pasted image 20240109165413.png]]
*A portion of an OpenVAS scan of Scanme.nmap.org*

Scanning tools have a wide range of options. In addition to scanning a network, some are capable of packet crafting, which involves altering a normal IP packet before transmitting it on a network. Let’s see what’s involved next.

### Crafting Packets
---
The team has a number of tasks to complete when running a PenTest. To achieve some of their goals, they may use packet crafting to test firewall rules, evade intrusion detection, or cause a denial of service.

For example, when crafting packets, you could do the following:

- <mark style="background: #FFF3A3A6;">Set unusual TCP flags to see if a firewall allows the packet.</mark>
- <mark style="background: #FFF3A3A6;">Fragment packets so that a malicious signature is not recognized by an IDS.</mark>
- <mark style="background: #FFF3A3A6;">Create fragmented packets that cannot be reassembled, which can consume all of a target's CPU time and cause either a system crash or denial of service (DoS).</mark>

The goal in all cases is to use as few packets as possible to achieve the desired result.

Packet crafting involves four stages:

1. **Assemble** —create the packet to be sent.
2. **Edit**—modify the contents of a created or captured packet.
3. **Play**—send/resend a packet on the network.
4. **Decode**—capture and analyze traffic generated using a packet analyzer such as Wireshark.

You can craft your packet(s) using the command line, GUI, or script options.

The type of packet you craft will be dependent on the firewall product. However, you might want to start with some well-known vulnerabilities. For example, the Christmas (XMAS) scan turns on the FIN, URG, and PSH flags all in the same TCP segment. This scan will be able to bypass firewalls that follow a strict interpretation of RFC 793, the original TCP specification. While this has been updated in most implementations, this vulnerability still exists in the wild.

A number of hacking tools (including Metasploit) use packet crafting techniques as part of the attack. Some popular packet crafting tools include:

- Ostinato, Libcrafter, Yersinia, packETH
- Colasoft Packet Builder, and Bit-Twist

Two other tools to craft and send a malformed packet to your target include Scapy and hping/Hping3.

As shown in the screenshot, hping3 is used in Kali Linux to craft a custom packet:
![[Pasted image 20240109170054.png]]
*Example of hping3 packet crafting*

In addition to testing network devices, a few of the more commonly scanned objects are web servers and databases. Next, let’s outline some of the tools and techniques that the team has in their arsenal to evaluate these targets.

### Evaluating Web Tools
---
Web servers and databases provide a unique opportunity for vulnerability scanning. Although they often work together, they are actually separate services, each with its own vulnerabilities and listening ports. They are often installed on separate computers and have their own IP addresses.

Web servers are often public-facing, whereas database servers are almost always on the private network. The web server will then have a backend connection to the database server. <mark style="background: #FFB8EBA6;">Most database servers using SQL will listen on TCP port 1433 or UDP port 1434</mark>. If you have access to the internal network, you can try scanning the SQL server directly. Or, if your access is through the web server, you can try scanning the web application to see if it will pass illegal commands to the SQL server to try and attempt an SQL injection attack. Keep in mind that in smaller applications the web server and database can be part of the same application, installed on the same computer.

Some possibilities for evaluating a web server and its database includes scanning:

- Web server on TCP 80 or 443 for server-specific vulnerabilities
- Servers that run on nonstandard ports
- Web applications for SQL-injection-related vulnerabilities
- Any apps running on the web server for vulnerabilities not related to SQL
- SQL server directly on its port (usually TCP 1433)

There are many web application vulnerability scanners available today. Some popular scanners include ***Arachni***, ***Skipfish***, ***Grabber***, ***Wapiti***, ***OWASP ZAP***, and ***Metasploit Pro***.

In addition to scanning for _general_ weaknesses related to an organization’s website, the team may also be tasked to check for SQL-specific vulnerabilities. To achieve this goal, the team has several specialized scanners and testers at their disposal. One tool that the team can use is **SQLmap** , which is an open-source database scanner that searches for and exploits SQL injection flaws.

SQLmap is included with Kali Linux and is easy to use. As shown in the screenshot, SQLmap is run against Scanme.nmap.org:
![[Pasted image 20240109170643.png]]
*SQLmap on Kali Linux*

Most websites today rely on cryptographic concepts such as SSL/TLS to protect data in transit from exposure. As a result, the team will also want to check for vulnerabilities that might impact the capabilities of the web server to properly encrypt data. Some possible vulnerabilities include:

- **Logjam vulnerability** can weaken the encryption complexity
- **Freak vulnerability** attacks the RSA-export keys and can allow a malicious actor to decrypt the communication stream
- **Poodle vulnerability** alters the way SSL 3.0 handles block cipher mode padding to be able to select content within the SSL session

Another tool that is built into Kali Linux is Nikto, an open-source web server scanner that can complete comprehensive testing on web servers for a variety of vulnerabilities, such as anti-clickjacking X-Frame-options header, and dangerous files and CGIs.

![[Pasted image 20240109170721.png]]
*Nikto in Kali Linux*

To learn more about Nikto and its capabilities, visit the manual (man) page.

As we have learned, most networks have many targets that the team will need to evaluate. During your career, you will most likely develop your own set of favorite tools in which to scan and test network defenses. However, keep in mind that over time, tools will be deprecated or no longer supported. The good news is new tools and techniques are developed all the time.
