up:: [[Cybersecurity/Reverse Engineering & Malware Analysis/Software Reverse Engineering (SWRE)]]

# PE File Format

## Index
---
1. Introduction
	1.1 What is it?
		A. How is it used?
2. Key Features
3. Basic Structure
4. Mapping from File to Memory
5. DOS Header
6. PE Header (Image_NT_Headers)

## Introduction

The Portable Executable (PE) file format is used for executables, object code, and DLLs in 32-bit and 64-bit Windows operating systems. It encapsulates the information necessary for the Windows OS loader to manage the executable code.

### What is it?

- **Portable Executable**:
    - Native Win32 file format used in Windows.
    - Defines what an EXE is, including DLLs, COM files, and more.
    - A flag in the PE header differentiates between an EXE and a DLL.

#### How is it used?

1. A file is compiled.
2. An object is created.
3. A linker takes the object files as input to create an EXE.
4. The EXE is used by the loader to get it into the process image.

## Key Features

- **Header Information**: Contains metadata about the file, such as the target machine, number of sections, and timestamps.
- **Section Headers**: Define the sections of the file, such as code, data, and resources.
- **Import Table**: Lists the external functions and libraries that the executable depends on.
- **Export Table**: Lists the functions and data that the executable exposes to other modules.
- **Relocation Table**: Contains information for relocating the code if it is not loaded at its preferred address.

## Basic Structure

A PE file typically has at least two sections: one for code and one for data. Windows NT applications have predefined sections such as `.text`, `.bss`, `.rdata`, `.data`, `.rsrc`, `.edata`, `.idata`, `pdata`, and `.debug`. Common sections include:

- **Executable Code Section**: `.text` (Microsoft) or `CODE` (Borland).
- **Data Sections**: `.data`, `.rdata`, or `.bss` (Microsoft) or `DATA` (Borland).
- **Resources Section**: `.rsrc`.
- **Export Data Section**: `.edata`.
- **Import Data Section**: `.idata`.
- **Debug Information Section**: `.debug`.

## Mapping from File to Memory

- Sections loaded in RAM are aligned for 4KB pages, with each section starting at a fresh page.
- Buffers are expanded in the process image:
    - On disk, these are offsets parsed with a hex editor.
    - In memory, they are virtual addresses derived from RVAs.

## DOS Header

- The starting point of all PEs, constituting the first 64 bytes.
- Contains 19 members:
    - **Magic**: Hex values `4Dh`, `5Ah` (MZ) indicating a valid DOS header.
    - **E_lfanew**: DWORD containing the offset of the PE header.
    - The loader uses this offset to skip the DOS stub and reach the PE header.
    - The last DWORD is the primary concern regarding the DOS header.

## PE Header (IMAGE_NT_Headers)

- The PE Header and IMAGE_NT_Headers are synonymous and needed by the loader.
- **Standard COFF File Header**:
    - Describes important attributes:
        - **Entry Point**: RVA of the first instruction executed when the PE loader is ready to run the PE file.
        - **Size of Image**.
        - **Base of Code**.
        - **Base of Data**: Optional member, not in 64-bit; all other members are fixed offset.
        - **NumberOfSections**.
        - **TimeDateStamp**.
        - **Characteristics**: Indicates if it is an EXE or a DLL.
- The PE Header starts with a signature: `50h`, `45h`, `00h`, `00h` (PE\0\0).
    - Different signatures exist for older executables, such as 16-bit Windows New Executable File, OS/2, etc.

For more details, refer to the [PE format documentation](vscode-file://vscode-app/c:/Users/nsickels/AppData/Local/Programs/Microsoft%20VS%20Code/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html).

## Problem Addressed

The PE file format addresses the problem of standardizing the structure of executable files on Windows. It allows the operating system to efficiently load and execute programs, manage dependencies, and handle dynamic linking.

## Implications

The use of the PE file format standardizes the way executables are structured and loaded in Windows, facilitating compatibility and interoperability. It also provides a framework for advanced features like dynamic linking and code relocation.

## Impact

- **Standardization**: Ensures a consistent structure for executables, simplifying development and deployment.
- **Dynamic Linking**: Allows executables to use shared libraries, reducing memory usage and disk space.
- **Code Relocation**: Enables executables to be loaded at different memory addresses, enhancing flexibility.
- **Interoperability**: Facilitates compatibility across different versions of Windows.

## Defense Mechanisms

- **Code Signing**: Ensures the integrity and authenticity of the executable.
- **Address Space Layout Randomization (ASLR)**: Randomizes the memory addresses used by executables to prevent exploitation.
- **Data Execution Prevention (DEP)**: Prevents execution of code from non-executable memory regions.
- **Anti-Tampering Techniques**: Detects and prevents unauthorized modifications to the executable.

## Exploitable Mechanisms/Weaknesses

If not properly managed, the PE file format can be exploited to inject malicious code, manipulate import/export tables, or bypass security mechanisms. Over-reliance on automated tools without adequate human oversight might result in overlooked vulnerabilities.

## Current Status

The PE file format remains the standard for executables on Windows, with ongoing enhancements to improve security and functionality. Advanced tools and techniques are continually being developed to analyze and manipulate PE files for various purposes, including malware analysis and software development. Many organizations now have dedicated teams focused on PE file analysis to address various aspects of software security and performance.

## Revision History

- **2024-09-10**: Entry created.
- **2024-12-5**: Refactored for clarity. 